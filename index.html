<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MJ's Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--work-orange:#E86F2A;--work-orange-dark:#D4853A;--work-yellow-cream:#F5E6C8;--work-pink:#F8C8D4;--work-pink-light:#FDF2F5;--personal-bg:#F5F5F3;--personal-red:#E57373;--personal-orange:#FFB74D;--personal-purple:#9575CD;--personal-purple-dark:#7E57C2;--personal-blue:#64B5F6;--personal-green:#81C784;--white:#FFFFFF;--dark:#2D2D2D;--gray:#6B6B6B;--gray-light:#F7F7F7;--border:#E8E8E8}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--white);min-height:100vh;color:var(--dark);line-height:1.6}
body.personal-mode{background:var(--personal-bg)}
.container{max-width:1200px;margin:0 auto;padding:32px 24px}
header{margin-bottom:32px}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header-left{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
h1{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:600}
.mode-toggle{display:flex;background:var(--white);border-radius:25px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid var(--border)}
.mode-btn{padding:10px 24px;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;background:transparent;color:var(--gray)}
.mode-btn.work-btn.active{background:var(--work-orange);color:white}
.mode-btn.personal-btn.active{background:var(--personal-purple-dark);color:white}
.settings-btn{background:var(--white);border:1px solid var(--border);padding:8px 20px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-family:'DM Sans',sans-serif;font-weight:600}
.stats-row{display:flex;flex-direction:row;gap:12px;flex-wrap:nowrap}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 16px;flex:1 1 0;min-width:80px}
.stat-card.highlight{background:var(--work-pink-light);border-color:var(--work-pink)}
.stat-card.warning{background:#FFF3E0;border-color:var(--work-orange)}
body.personal-mode .stat-card.highlight{background:#EDE7F6;border-color:var(--personal-purple)}
body.personal-mode .stat-card.warning{background:#FFEBEE;border-color:var(--personal-red)}
.stat-number{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:600;line-height:1}
.stat-label{font-size:0.7rem;color:var(--gray);margin-top:2px;font-weight:500}
.quick-add{background:var(--work-yellow-cream);border-radius:16px;padding:24px;margin-bottom:32px}
body.personal-mode .quick-add{background:#EDE7F6}
.quick-add-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.quick-add input[type="text"]{flex:1;min-width:200px;padding:14px 18px;border:1px solid var(--border);border-radius:10px;font-size:0.95rem;font-family:'DM Sans',sans-serif;background:var(--white)}
.quick-add select,.quick-add input[type="date"]{padding:14px 18px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;background:var(--white)}
.btn{padding:14px 28px;border:none;border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer}
.btn-primary{background:var(--work-orange);color:var(--white)}
body.personal-mode .btn-primary{background:var(--personal-purple-dark)}
.btn-secondary{background:var(--white);color:var(--dark);border:1px solid var(--border)}
.btn-sm{padding:8px 16px;font-size:0.8rem}
.btn-icon{padding:14px 16px;background:var(--white);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:1.2rem}
.work-view{display:block}body.personal-mode .work-view{display:none}
.personal-view{display:none}body.personal-mode .personal-view{display:block}
.view-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.view-tab{padding:12px 24px;background:var(--white);border:1px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;color:var(--gray)}
.view-tab.active{background:var(--work-orange);color:white;border-color:var(--work-orange)}
body.personal-mode .view-tab.active{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:24px}
.filter-label{font-size:0.85rem;font-weight:600;color:var(--gray)}
.filter-btn{padding:8px 16px;background:var(--white);border:1px solid var(--border);border-radius:20px;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;color:var(--gray)}
.filter-btn.active{background:var(--work-orange);color:var(--white);border-color:var(--work-orange)}
body.personal-mode .filter-btn.active{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark);color:white}
.tag-filter-banner{background:var(--work-yellow-cream);padding:16px 24px;border-radius:12px;margin-bottom:24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
body.personal-mode .tag-filter-banner{background:#EDE7F6}
.tag-filter-banner h3{font-family:'Playfair Display',serif;font-size:1.1rem}
.tag-filter-count{background:var(--work-orange);color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:600}
body.personal-mode .tag-filter-count{background:var(--personal-purple-dark)}
.clear-filter-btn{margin-left:auto;padding:8px 16px;background:var(--white);border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer}
.partners-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:24px}
.partner-section{background:var(--white);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.partner-header{padding:16px 24px;font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.partner-header .task-count{background:var(--gray-light);color:var(--gray);padding:4px 12px;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.75rem;font-weight:600}
.haven .partner-header{background:var(--work-pink-light)}.haven .partner-header .task-count{background:var(--work-pink);color:var(--dark)}
.bonclub .partner-header{background:#FFF3E0}.bonclub .partner-header .task-count{background:var(--work-orange);color:white}
.admin .partner-header{background:var(--work-yellow-cream)}.admin .partner-header .task-count{background:var(--work-orange-dark);color:white}
.project-section{border-bottom:1px solid var(--border)}
.project-header{padding:12px 24px;background:var(--gray-light);font-weight:600;font-size:0.85rem;color:var(--gray)}
.deliverable-section{padding:12px 24px;border-left:3px solid transparent}
.deliverable-section.has-tasks{border-left-color:var(--work-orange)}
.deliverable-name{font-size:0.75rem;color:var(--gray);margin-bottom:8px;font-weight:600;text-transform:uppercase}
.task-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.task-item:last-child{border-bottom:none}
.task-checkbox{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;cursor:pointer;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;background:var(--white)}
.task-checkbox.checked{background:var(--work-orange);border-color:var(--work-orange)}
.task-checkbox.checked::after{content:'‚úì';color:white;font-size:12px;font-weight:bold}
body.personal-mode .task-checkbox.checked{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.task-content{flex:1}
.task-text{font-size:0.95rem;font-weight:500}
.task-item.completed .task-text{text-decoration:line-through;color:var(--gray)}
.task-meta{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.task-due{font-size:0.75rem;padding:4px 10px;font-weight:600;border-radius:6px;background:var(--gray-light);color:var(--gray)}
.task-due.overdue{background:#FFEBEE;color:#C62828}
.task-tag{font-size:0.7rem;padding:4px 10px;font-weight:600;border-radius:6px;background:var(--gray-light);color:var(--gray)}
.task-source{font-size:0.7rem;color:var(--gray);font-style:italic}
.delete-task{opacity:0;background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem;padding:4px 8px}
.task-item:hover .delete-task,.work-task-item:hover .delete-task,.personal-task-item:hover .delete-task{opacity:1}
.delete-task:hover{color:#EF5350}
.empty-state{text-align:center;padding:32px 20px;color:var(--gray);font-size:0.9rem}
.priority-section{margin-bottom:24px}
.priority-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.priority-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:700;text-transform:uppercase}
.priority-pill.high{background:#FFEBEE;color:var(--personal-red)}.priority-pill.high::before{content:'‚ñ≤';font-size:0.7rem}
.priority-pill.medium{background:#FFF3E0;color:var(--personal-orange)}.priority-pill.medium::before{content:'‚óè';font-size:0.6rem}
.priority-pill.low{background:#EDE7F6;color:var(--personal-purple)}.priority-pill.low::before{content:'‚ñº';font-size:0.7rem}
.priority-count{font-size:0.85rem;color:var(--gray);font-weight:500}
.priority-add-btn{margin-left:auto;background:none;border:none;font-size:1.2rem;color:var(--gray);cursor:pointer}
.priority-tasks{background:var(--white);border-radius:16px;overflow:hidden;border:1px solid var(--border)}
.priority-empty{padding:20px;text-align:center;color:var(--gray);font-size:0.9rem;border:2px dashed var(--border);border-radius:12px;margin:8px}
.work-task-item,.personal-task-item{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);background:var(--white)}
.work-task-item:last-child,.personal-task-item:last-child{border-bottom:none}
.work-task-item.completed .work-task-text,.personal-task-item.completed .personal-task-text{text-decoration:line-through;color:var(--gray)}
.work-task-content,.personal-task-content{flex:1}
.work-task-text,.personal-task-text{font-weight:500}
.work-task-meta,.personal-task-meta{font-size:0.8rem;color:var(--gray);margin-top:4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.work-task-checkbox,.personal-task-checkbox{width:26px;height:26px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.work-task-checkbox.checked{background:var(--work-orange);border-color:var(--work-orange)}
.work-task-checkbox.checked::after,.personal-task-checkbox.checked::after{content:'‚úì';color:white;font-size:14px;font-weight:bold}
.personal-task-checkbox.checked{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.personal-task-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background:var(--gray-light)}
.habit-badge{background:var(--personal-green);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.repeat-badge{background:var(--personal-blue);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.priority-badge{padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.priority-badge.high{background:#FFEBEE;color:var(--personal-red)}
.priority-badge.medium{background:#FFF3E0;color:var(--personal-orange)}
.priority-badge.low{background:#EDE7F6;color:var(--personal-purple)}
.projects-grid,.protocols-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.project-card{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:20px;cursor:pointer}
.project-card:hover{border-color:var(--personal-purple);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.project-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.project-card-title{font-weight:600;display:flex;align-items:center;gap:8px}
.project-status{padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
.project-status.active{background:var(--personal-green);color:white}
.project-status.paused{background:var(--personal-orange);color:white}
.project-status.someday{background:var(--gray-light);color:var(--gray)}
.project-card-meta{font-size:0.85rem;color:var(--gray)}
.project-progress{margin-top:12px;height:6px;background:var(--gray-light);border-radius:3px;overflow:hidden}
.project-progress-bar{height:100%;background:var(--personal-purple-dark)}
.protocol-card{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:24px;position:relative}
.protocol-card.active{border-color:var(--personal-purple);box-shadow:0 0 0 3px rgba(149,117,205,0.2)}
.protocol-card-icon{font-size:2rem;margin-bottom:12px}
.protocol-card-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:600;margin-bottom:8px}
.protocol-card-desc{font-size:0.85rem;color:var(--gray);margin-bottom:16px}
.protocol-tasks-preview{font-size:0.8rem;color:var(--gray);margin-bottom:16px}
.protocol-activate-btn{width:100%;padding:12px;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;background:var(--gray-light)}
.protocol-card.active .protocol-activate-btn{background:var(--personal-red);color:white}
.protocol-active-badge{position:absolute;top:12px;right:12px;background:var(--personal-purple-dark);color:white;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600}
.done-section{margin-top:32px}
.done-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer}
.done-pill{padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:700;text-transform:uppercase;background:var(--gray-light);color:var(--gray)}
.done-tasks{display:none}.done-tasks.expanded{display:block}
.filtered-tasks-list{background:var(--white);border-radius:16px;overflow:hidden;border:1px solid var(--border)}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--white);border-radius:20px;padding:32px;max-width:600px;width:90%;max-height:85vh;overflow-y:auto}
.modal.wide{max-width:800px}
.modal h2{font-family:'Playfair Display',serif;font-weight:600;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.modal-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.modal-tab{padding:10px 20px;background:var(--gray-light);border:none;border-radius:8px;font-size:0.85rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;color:var(--gray)}
.modal-tab.active{background:var(--work-orange);color:white}
body.personal-mode .modal-tab.active{background:var(--personal-purple-dark)}
.modal-section{margin-bottom:24px}
.modal-section h3{font-size:0.85rem;color:var(--gray);margin-bottom:12px;font-weight:600}
.modal input,.modal select,.modal textarea{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;margin-bottom:8px;background:var(--white)}
.modal textarea{min-height:80px;resize:vertical}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--gray-light);border-radius:10px;margin-bottom:8px}
.settings-item-info{flex:1}
.settings-item-title{font-weight:600;font-size:0.9rem}
.settings-item-meta{font-size:0.8rem;color:var(--gray)}
.settings-item-actions button{background:none;border:none;color:var(--gray);cursor:pointer;font-size:1rem;padding:4px 8px}
.settings-item-actions button.delete:hover{color:#EF5350}
.add-inline{display:flex;gap:8px;margin-top:12px}
.add-inline input{flex:1;margin-bottom:0}
.subtask-item{display:flex;align-items:center;gap:8px;padding:8px 0;font-size:0.85rem}
.subtask-item button{background:none;border:none;color:var(--gray);cursor:pointer}
.api-key-input{display:flex;gap:8px}
.api-key-input input{flex:1;margin-bottom:0;font-family:monospace;font-size:0.85rem}
.api-status{padding:8px 12px;border-radius:8px;font-size:0.85rem;margin-top:8px}
.api-status.connected{background:#E8F5E9;color:#2E7D32}
.api-status.disconnected{background:#FFF3E0;color:#E65100}
.scan-preview{display:flex;gap:24px;margin-bottom:24px}
.scan-image{width:200px;height:200px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
.scan-instructions{flex:1}
.scan-instructions h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:8px}
.scan-instructions p{color:var(--gray);font-size:0.9rem;margin-bottom:12px}
.scan-status{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--gray-light);border-radius:10px;font-size:0.9rem}
.scan-status.loading{background:#E3F2FD;color:#1565C0}
.scan-status.error{background:#FFEBEE;color:#C62828}
.suggested-task{display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--gray-light);border-radius:12px;margin-bottom:12px}
.suggested-task input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--work-orange)}
body.personal-mode .suggested-task input[type="checkbox"]{accent-color:var(--personal-purple-dark)}
.suggested-task-content{flex:1}
.suggested-task-text{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:0.9rem;font-family:'DM Sans',sans-serif}
.suggested-task-options{display:flex;gap:8px;margin-top:8px}
.suggested-task-options select{padding:6px 10px;font-size:0.8rem;border:1px solid var(--border);border-radius:6px}
.suggested-task .remove-btn{background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem}
.suggested-task .remove-btn:hover{color:#EF5350}
.drop-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--work-orange);background:var(--work-yellow-cream)}
body.personal-mode .drop-zone:hover,body.personal-mode .drop-zone.dragover{border-color:var(--personal-purple-dark);background:#EDE7F6}
.drop-zone-icon{font-size:3rem;margin-bottom:12px}
.drop-zone-text{font-weight:600;margin-bottom:4px}
.drop-zone-hint{font-size:0.85rem;color:var(--gray)}
@media(max-width:768px){.container{padding:16px}.partners-grid,.projects-grid,.protocols-grid{grid-template-columns:1fr}.quick-add-row{flex-direction:column}.quick-add input[type="text"],.quick-add select,.btn{width:100%}h1{font-size:1.8rem}.header-left{flex-direction:column;align-items:flex-start;gap:12px}.mode-toggle{width:100%;justify-content:center}.scan-preview{flex-direction:column}.scan-image{width:100%;height:150px}}
</style>
</head>
<body>
<div class="container">
<header>
<div class="header-top">
<div class="header-left"><h1>MJ's Planner</h1><div class="mode-toggle"><button class="mode-btn work-btn active" onclick="setMode('work')">Work</button><button class="mode-btn personal-btn" onclick="setMode('personal')">Personal</button></div></div>
<div class="header-actions"><button class="settings-btn" onclick="openSettings()">Settings</button></div>
</div>
<div class="stats-row work-view"><div class="stat-card"><div class="stat-number" id="totalTasks">0</div><div class="stat-label">Total</div></div><div class="stat-card warning"><div class="stat-number" id="urgentTasks">0</div><div class="stat-label">Urgent</div></div><div class="stat-card"><div class="stat-number" id="overdueTasks">0</div><div class="stat-label">Overdue</div></div><div class="stat-card highlight"><div class="stat-number" id="completedToday">0</div><div class="stat-label">Done</div></div></div>
<div class="stats-row personal-view"><div class="stat-card"><div class="stat-number" id="pTotalTasks">0</div><div class="stat-label">To-Do</div></div><div class="stat-card warning"><div class="stat-number" id="pHighTasks">0</div><div class="stat-label">High</div></div><div class="stat-card"><div class="stat-number" id="pHabits">0</div><div class="stat-label">Habits</div></div><div class="stat-card highlight"><div class="stat-number" id="pCompletedToday">0</div><div class="stat-label">Done</div></div></div>
</header>
<div class="work-view">
<div class="quick-add"><div class="quick-add-row">
<input type="text" id="workTaskInput" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter')addWorkTask()">
<select id="workProjectSelect"></select>
<select id="workPrioritySelect"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">Urgent</option></select>
<input type="date" id="workDueDate">
<select id="workTagSelect"><option value="">Tag</option></select>
<button class="btn btn-primary" onclick="addWorkTask()">Add Task</button>
<button class="btn-icon" onclick="openScanModal()" title="Scan handwritten notes">üì∑</button>
</div></div>
<div class="view-tabs"><button class="view-tab active" onclick="setWorkView('priority',this)">üìã By Priority</button><button class="view-tab" onclick="setWorkView('projects',this)">üìÅ By Project</button></div>
<div id="workPriorityView">
<div class="priority-section"><div class="priority-header"><span class="priority-pill high">Urgent</span><span class="priority-count" id="wHighCount">(0)</span></div><div class="priority-tasks" id="wHighTasks"></div></div>
<div class="priority-section"><div class="priority-header"><span class="priority-pill medium">Medium</span><span class="priority-count" id="wMediumCount">(0)</span></div><div class="priority-tasks" id="wMediumTasks"></div></div>
<div class="priority-section"><div class="priority-header"><span class="priority-pill low">Low</span><span class="priority-count" id="wLowCount">(0)</span></div><div class="priority-tasks" id="wLowTasks"></div></div>
<div class="done-section"><div class="done-header" onclick="toggleWorkDone()"><span class="done-pill">Done <span id="wDoneCount">(0)</span></span><span style="color:var(--gray)">‚ñº</span></div><div class="done-tasks" id="wDoneTasks"></div></div>
</div>
<div id="workProjectsView" class="partners-grid" style="display:none"></div>
</div>
<div class="personal-view">
<div class="quick-add"><div class="quick-add-row">
<input type="text" id="personalTaskInput" placeholder="Add a to-do..." onkeypress="if(event.key==='Enter')addPersonalTask()">
<select id="personalPrioritySelect"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select>
<select id="personalTagSelect"><option value="">Tag</option></select>
<button class="btn btn-primary" onclick="addPersonalTask()">Add</button>
<button class="btn-icon" onclick="openScanModal()" title="Scan handwritten notes">üì∑</button>
</div></div>
<div class="view-tabs"><button class="view-tab active" onclick="setPersonalView('todo',this)">üìã To-Do</button><button class="view-tab" onclick="setPersonalView('projects',this)">üéØ Projects</button><button class="view-tab" onclick="setPersonalView('protocols',this)">ü©π Protocols</button></div>
<div id="personalFiltersRow" class="filters"><span class="filter-label">Filter:</span><button class="filter-btn active" onclick="setPersonalTagFilter('',this)">All</button><span id="personalTagFilters"></span></div>
<div id="tagFilterBanner" class="tag-filter-banner" style="display:none"><h3><span id="filterTagIcon"></span> <span id="filterTagName"></span></h3><span class="tag-filter-count" id="filterTagCount">0 tasks</span><button class="clear-filter-btn" onclick="clearTagFilter()">√ó Clear</button></div>
<div id="filteredTasksView" style="display:none"><div class="filtered-tasks-list" id="filteredTasksList"></div></div>
<div id="personalTodoView">
<div class="priority-section"><div class="priority-header"><span class="priority-pill high">High</span><span class="priority-count" id="highCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('high')">+</button></div><div class="priority-tasks" id="highTasks"></div></div>
<div class="priority-section"><div class="priority-header"><span class="priority-pill medium">Medium</span><span class="priority-count" id="mediumCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('medium')">+</button></div><div class="priority-tasks" id="mediumTasks"></div></div>
<div class="priority-section"><div class="priority-header"><span class="priority-pill low">Low</span><span class="priority-count" id="lowCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('low')">+</button></div><div class="priority-tasks" id="lowTasks"></div></div>
<div class="done-section"><div class="done-header" onclick="toggleDone()"><span class="done-pill">Done <span id="doneCount">(0)</span></span><span style="color:var(--gray)">‚ñº</span></div><div class="done-tasks" id="doneTasks"></div></div>
</div>
<div id="personalProjectsView" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="font-family:'Playfair Display',serif;font-size:1.3rem">My Projects</h2><button class="btn btn-primary btn-sm" onclick="openProjectModal()">+ New Project</button></div><div class="projects-grid" id="projectsGrid"></div></div>
<div id="personalProtocolsView" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><div><h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:4px">My Protocols</h2><p style="color:var(--gray);font-size:0.85rem">Pre-built routines</p></div><button class="btn btn-primary btn-sm" onclick="openProtocolModal()">+ New Protocol</button></div><div class="protocols-grid" id="protocolsGrid"></div></div>
</div>
</div>
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()"><div class="modal"><h2>Settings</h2><div class="modal-tabs" id="settingsTabs"></div><div id="settingsContent"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeSettings()">Done</button></div></div></div>
<div class="modal-overlay" id="personalAddModal" onclick="if(event.target===this)closePersonalAddModal()"><div class="modal"><h2>Add To-Do</h2><div class="modal-section"><h3>Task</h3><input type="text" id="pModalTask" placeholder="e.g., Pay rent"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="pModalIcon" placeholder="üìå" style="width:80px"></div><div style="display:flex;gap:16px"><div class="modal-section" style="flex:1"><h3>Priority</h3><select id="pModalPriority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div><div class="modal-section" style="flex:1"><h3>Tag</h3><select id="pModalTag"></select></div></div><div class="modal-section"><h3>Repeat?</h3><select id="pModalRepeat" onchange="toggleRepeatOptions()"><option value="">No repeat</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="habit">30-day Habit</option></select></div><div id="repeatOptions" style="display:none"><div class="modal-section"><h3>Day</h3><select id="pModalDay"><option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option></select></div></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closePersonalAddModal()">Cancel</button><button class="btn btn-primary" onclick="savePersonalModalTask()">Add</button></div></div></div>
<div class="modal-overlay" id="projectModal" onclick="if(event.target===this)closeProjectModal()"><div class="modal"><h2 id="projectModalTitle">New Project</h2><div class="modal-section"><h3>Name</h3><input type="text" id="projectName" placeholder="e.g., Redecorate bedroom"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="projectIcon" placeholder="üéØ" style="width:80px"></div><div class="modal-section"><h3>Status</h3><select id="projectStatus"><option value="someday">Someday</option><option value="active">Active</option><option value="paused">Paused</option></select></div><div class="modal-section"><h3>Subtasks</h3><div id="projectSubtasks"></div><div class="add-inline"><input type="text" id="newSubtask" placeholder="Add subtask" onkeypress="if(event.key==='Enter')addProjectSubtask()"><button class="btn btn-primary btn-sm" onclick="addProjectSubtask()">+</button></div></div><input type="hidden" id="editingProjectId"><div class="modal-actions"><button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button><button class="btn btn-primary" onclick="saveProject()">Save</button></div></div></div>
<div class="modal-overlay" id="protocolModal" onclick="if(event.target===this)closeProtocolModal()"><div class="modal"><h2 id="protocolModalTitle">New Protocol</h2><div class="modal-section"><h3>Name</h3><input type="text" id="protocolName" placeholder="e.g., Morning Routine"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="protocolIcon" placeholder="üåÖ" style="width:80px"></div><div class="modal-section"><h3>Description</h3><textarea id="protocolDesc" placeholder="When to use..."></textarea></div><div class="modal-section"><h3>Tasks</h3><div id="protocolTasks"></div><div class="add-inline"><input type="text" id="newProtocolTask" placeholder="Add task"><input type="text" id="newProtocolTaskIcon" placeholder="üìå" style="width:60px"><button class="btn btn-primary btn-sm" onclick="addProtocolTask()">+</button></div></div><input type="hidden" id="editingProtocolId"><div class="modal-actions"><button class="btn btn-secondary" onclick="closeProtocolModal()">Cancel</button><button class="btn btn-primary" onclick="saveProtocol()">Save</button></div></div></div>
<div class="modal-overlay" id="scanModal" onclick="if(event.target===this)closeScanModal()"><div class="modal wide"><h2>üì∑ Scan Handwritten Notes</h2><div id="scanUploadView"><div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()"><div class="drop-zone-icon">üìù</div><div class="drop-zone-text">Drop image here or click to upload</div><div class="drop-zone-hint">Photos of lists, mind maps, sticky notes</div></div><input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)"></div><div id="scanReviewView" style="display:none"><div class="scan-preview"><img id="scanPreviewImg" class="scan-image" src="" alt=""><div class="scan-instructions"><h3>Review & Edit Tasks</h3><p>Check tasks to add, edit text, set priority/tags.</p><div id="scanStatusBox" class="scan-status"></div></div></div><div id="suggestedTasksList"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="resetScanModal()">‚Üê Different Image</button><button class="btn btn-primary" id="addSelectedBtn" onclick="addSelectedTasks()" disabled>Add Selected</button></div></div></div></div>
<script>
let currentMode='work',workView='priority',personalView='todo',personalTagFilter='',tempSubtasks=[],tempProtocolTasks=[],suggestedTasks=[];
const defaultWorkData={partners:[{id:'haven',name:'Haven Studio',color:'haven',projects:[{id:'rubino',name:'Rubino',deliverables:[{id:'playbook',name:'Social Media Playbook'},{id:'content',name:'Content Creation'},{id:'strategy',name:'Strategy'}]}]},{id:'bonclub',name:'Bonclub',color:'bonclub',projects:[{id:'vanhoutte',name:'Van Houtte',deliverables:[{id:'campaign',name:'Campaign'},{id:'social',name:'Social Media'}]}]},{id:'admin',name:'Admin',color:'admin',projects:[{id:'business',name:'Business',deliverables:[{id:'invoices',name:'Invoices'},{id:'taxes',name:'Taxes'},{id:'linkedin',name:'LinkedIn'}]}]}],tags:[{id:'email',name:'Email',icon:'üìß'},{id:'call',name:'Call',icon:'üìû'},{id:'review',name:'Review',icon:'üëÄ'},{id:'meeting',name:'Meeting',icon:'ü§ù'},{id:'writing',name:'Writing',icon:'‚úçÔ∏è'},{id:'quickwin',name:'Quick Win',icon:'‚ö°'}],tasks:[]};
const defaultPersonalData={tags:[{id:'email',name:'Email',icon:'üìß'},{id:'call',name:'Call',icon:'üìû'},{id:'errand',name:'Errand',icon:'üèÉ'},{id:'home',name:'Home',icon:'üè†'},{id:'order',name:'Order/Return',icon:'üì¶'},{id:'admin',name:'Admin',icon:'üìÅ'},{id:'selfcare',name:'Self-care',icon:'üíÜ'}],tasks:[],projects:[],protocols:[{id:'adhd',name:'ADHD Support',icon:'üß†',active:false,description:'Activate when executive function is struggling.',tasks:[{text:'Take ADHD medication',icon:'üíä'},{text:'Drink water',icon:'üíß'},{text:'Eat a real meal',icon:'üç≥'},{text:'Set 25-min timer',icon:'‚è±Ô∏è'},{text:'5-min movement',icon:'üö∂'},{text:'Write top 3',icon:'üìù'}]},{id:'histamine',name:'Low-Histamine',icon:'ü©π',active:false,description:'During CSU flare-ups.',tasks:[{text:'Take antihistamine',icon:'üíä'},{text:'Avoid high-histamine',icon:'üö´'},{text:'Fresh meals only',icon:'ü•ó'},{text:'Log symptoms',icon:'üìì'},{text:'Gentle exercise',icon:'üßò'},{text:'Extra hydration',icon:'üíß'}]}]};
let workData,personalData,appSettings={apiKey:''};
function loadData(){workData=JSON.parse(localStorage.getItem('mjPlanner_work_v5')||'null')||JSON.parse(JSON.stringify(defaultWorkData));personalData=JSON.parse(localStorage.getItem('mjPlanner_personal_v5')||'null')||JSON.parse(JSON.stringify(defaultPersonalData));appSettings=JSON.parse(localStorage.getItem('mjPlanner_settings')||'null')||{apiKey:''};if(!personalData.projects)personalData.projects=[];}
function saveWork(){localStorage.setItem('mjPlanner_work_v5',JSON.stringify(workData));}
function savePersonal(){localStorage.setItem('mjPlanner_personal_v5',JSON.stringify(personalData));}
function saveSettings(){localStorage.setItem('mjPlanner_settings',JSON.stringify(appSettings));}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2);}
function escapeHtml(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML;}
function setMode(m){currentMode=m;document.body.classList.toggle('personal-mode',m==='personal');document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));document.querySelector('.'+m+'-btn').classList.add('active');m==='work'?renderWork():renderPersonal();}
function populateWorkSelects(){const ps=document.getElementById('workProjectSelect'),ts=document.getElementById('workTagSelect');ps.innerHTML='';workData.partners.forEach(p=>p.projects.forEach(pr=>pr.deliverables.forEach(d=>ps.innerHTML+='<option value="'+p.id+'|'+pr.id+'|'+d.id+'">'+p.name+' ‚Üí '+pr.name+' ‚Üí '+d.name+'</option>')));ts.innerHTML='<option value="">Tag</option>';workData.tags.forEach(t=>ts.innerHTML+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>');}
function addWorkTask(){const input=document.getElementById('workTaskInput'),text=input.value.trim();if(!text)return;const[partnerId,projectId,deliverableId]=document.getElementById('workProjectSelect').value.split('|'),tag=document.getElementById('workTagSelect').value;workData.tasks.push({id:genId(),text,partnerId,projectId,deliverableId,priority:document.getElementById('workPrioritySelect').value,dueDate:document.getElementById('workDueDate').value||null,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()});saveWork();input.value='';renderWork();}
function toggleWorkTask(id){const t=workData.tasks.find(x=>x.id===id);if(t){t.completed=!t.completed;t.completedAt=t.completed?new Date().toISOString():null;saveWork();renderWork();}}
function deleteWorkTask(id){workData.tasks=workData.tasks.filter(x=>x.id!==id);saveWork();renderWork();}
function isOverdue(t){if(!t.dueDate||t.completed)return false;return new Date(t.dueDate)<new Date(new Date().toDateString());}
function getWorkSource(t){const p=workData.partners.find(x=>x.id===t.partnerId);const pr=p?.projects.find(x=>x.id===t.projectId);return p?(p.name+(pr?' ‚Üí '+pr.name:'')):'';}
function renderWorkTaskClean(t){const src=getWorkSource(t);const tags=(t.tags||[]).map(tid=>{const tag=workData.tags.find(x=>x.id===tid);return tag?'<span class="task-tag">'+tag.icon+' '+tag.name+'</span>':'';}).join('');const due=t.dueDate?'<span class="task-due'+(isOverdue(t)?' overdue':'')+'">'+t.dueDate+'</span>':'';return '<div class="work-task-item'+(t.completed?' completed':'')+'"><div class="work-task-checkbox'+(t.completed?' checked':'')+'" onclick="toggleWorkTask(\''+t.id+'\')"></div><div class="work-task-content"><div class="work-task-text">'+escapeHtml(t.text)+'</div><div class="work-task-meta">'+due+tags+(src?'<span class="task-source">'+src+'</span>':'')+'</div></div><button class="delete-task" onclick="deleteWorkTask(\''+t.id+'\')">√ó</button></div>';}
function renderWorkPriority(){const tasks=workData.tasks,high=tasks.filter(t=>t.priority==='high'&&!t.completed),med=tasks.filter(t=>t.priority==='medium'&&!t.completed),low=tasks.filter(t=>t.priority==='low'&&!t.completed),done=tasks.filter(t=>t.completed);document.getElementById('wHighCount').textContent='('+high.length+')';document.getElementById('wMediumCount').textContent='('+med.length+')';document.getElementById('wLowCount').textContent='('+low.length+')';document.getElementById('wDoneCount').textContent='('+done.length+')';document.getElementById('wHighTasks').innerHTML=high.length?high.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No urgent tasks</div>';document.getElementById('wMediumTasks').innerHTML=med.length?med.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No medium</div>';document.getElementById('wLowTasks').innerHTML=low.length?low.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No low</div>';document.getElementById('wDoneTasks').innerHTML=done.length?done.map(renderWorkTaskClean).join(''):'<div class="priority-empty">Nothing done</div>';}
function renderWorkTask(t){const tags=(t.tags||[]).map(tid=>{const tag=workData.tags.find(x=>x.id===tid);return tag?'<span class="task-tag">'+tag.icon+'</span>':'';}).join('');const due=t.dueDate?'<span class="task-due'+(isOverdue(t)?' overdue':'')+'">'+t.dueDate+'</span>':'';return '<div class="task-item'+(t.completed?' completed':'')+'"><div class="task-checkbox'+(t.completed?' checked':'')+'" onclick="toggleWorkTask(\''+t.id+'\')"></div><div class="task-content"><div class="task-text">'+escapeHtml(t.text)+'</div><div class="task-meta">'+due+tags+'</div></div><button class="delete-task" onclick="deleteWorkTask(\''+t.id+'\')">√ó</button></div>';}
function renderWorkProjects(){const c=document.getElementById('workProjectsView');c.innerHTML='';workData.partners.forEach(partner=>{const tasks=workData.tasks.filter(t=>t.partnerId===partner.id),inc=tasks.filter(t=>!t.completed);let html='';partner.projects.forEach(proj=>{let dels='';proj.deliverables.forEach(del=>{const dt=tasks.filter(t=>t.projectId===proj.id&&t.deliverableId===del.id);if(dt.length)dels+='<div class="deliverable-section has-tasks"><div class="deliverable-name">'+del.name+'</div><div class="tasks-list">'+dt.map(renderWorkTask).join('')+'</div></div>';});if(dels)html+='<div class="project-section"><div class="project-header">'+proj.name+'</div>'+dels+'</div>';});c.innerHTML+='<div class="partner-section '+partner.color+'"><div class="partner-header">'+partner.name+'<span class="task-count">'+inc.length+'</span></div>'+(html||'<div class="empty-state">No tasks</div>')+'</div>';});}
function updateWorkStats(){const inc=workData.tasks.filter(t=>!t.completed);document.getElementById('totalTasks').textContent=inc.length;document.getElementById('urgentTasks').textContent=inc.filter(t=>t.priority==='high').length;document.getElementById('overdueTasks').textContent=inc.filter(isOverdue).length;const today=new Date().toDateString();document.getElementById('completedToday').textContent=workData.tasks.filter(t=>t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today).length;}
function setWorkView(v,btn){workView=v;document.querySelectorAll('.work-view .view-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.getElementById('workPriorityView').style.display=v==='priority'?'block':'none';document.getElementById('workProjectsView').style.display=v==='projects'?'grid':'none';renderWork();}
function toggleWorkDone(){document.getElementById('wDoneTasks').classList.toggle('expanded');}
function renderWork(){workView==='priority'?renderWorkPriority():renderWorkProjects();updateWorkStats();}
// Personal
function populatePersonalSelects(){const ts=document.getElementById('personalTagSelect'),mt=document.getElementById('pModalTag');[ts,mt].forEach(s=>{if(!s)return;s.innerHTML='<option value="">No tag</option>';personalData.tags.forEach(t=>s.innerHTML+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>');});renderPersonalTagFilters();}
function renderPersonalTagFilters(){document.getElementById('personalTagFilters').innerHTML=personalData.tags.map(t=>'<button class="filter-btn'+(personalTagFilter===t.id?' active':'')+'" onclick="setPersonalTagFilter(\''+t.id+'\',this)">'+t.icon+' '+t.name+'</button>').join('');}
function setPersonalTagFilter(id,btn){personalTagFilter=id;document.querySelectorAll('#personalFiltersRow .filter-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');else document.querySelector('#personalFiltersRow .filter-btn').classList.add('active');renderPersonal();}
function clearTagFilter(){personalTagFilter='';document.querySelectorAll('#personalFiltersRow .filter-btn').forEach(b=>b.classList.remove('active'));document.querySelector('#personalFiltersRow .filter-btn').classList.add('active');renderPersonal();}
function addPersonalTask(){const input=document.getElementById('personalTaskInput'),text=input.value.trim();if(!text)return;const tag=document.getElementById('personalTagSelect').value,tagObj=personalData.tags.find(t=>t.id===tag);personalData.tasks.push({id:genId(),text,icon:tagObj?.icon||'üìå',priority:document.getElementById('personalPrioritySelect').value,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()});savePersonal();input.value='';renderPersonal();}
function togglePersonalTask(id){const t=personalData.tasks.find(x=>x.id===id);if(t){t.completed=!t.completed;t.completedAt=t.completed?new Date().toISOString():null;if(t.completed&&t.repeat==='habit'&&t.habitDay){t.habitDay++;if(t.habitDay>30){if(confirm('üéâ 30 days! Continue?')){t.habitDay=1;t.completed=false;}}else t.completed=false;}savePersonal();renderPersonal();}}
function deletePersonalTask(id){personalData.tasks=personalData.tasks.filter(x=>x.id!==id);savePersonal();renderPersonal();}
function renderPersonalTask(t,showPriority){let meta='';if(t.repeat==='habit')meta='<span class="habit-badge">Day '+(t.habitDay||1)+'/30</span>';else if(t.repeat==='weekly')meta='<span class="repeat-badge">Every '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][t.repeatDay||0]+'</span>';else if(t.repeat==='daily')meta='<span class="repeat-badge">Daily</span>';const pb=showPriority?'<span class="priority-badge '+t.priority+'">'+t.priority+'</span>':'';return '<div class="personal-task-item'+(t.completed?' completed':'')+'"><div class="personal-task-checkbox'+(t.completed?' checked':'')+'" onclick="togglePersonalTask(\''+t.id+'\')"></div><div class="personal-task-icon">'+(t.icon||'üìå')+'</div><div class="personal-task-content"><div class="personal-task-text">'+escapeHtml(t.text)+'</div><div class="personal-task-meta">'+pb+meta+'</div></div><button class="delete-task" onclick="deletePersonalTask(\''+t.id+'\')">√ó</button></div>';}
function getActiveTasks(){const today=new Date().getDay();personalData.protocols.forEach(p=>{if(p.active)p.tasks.forEach(pt=>{if(!personalData.tasks.find(t=>t.protocolId===p.id&&t.text===pt.text&&!t.completed))personalData.tasks.push({id:genId(),text:pt.text,icon:pt.icon,priority:'high',protocolId:p.id,completed:false,createdAt:new Date().toISOString()});});});savePersonal();return personalData.tasks.filter(t=>!(t.repeat==='weekly'&&t.repeatDay!==today));}
function filterByTag(tasks){return personalTagFilter?tasks.filter(t=>(t.tags||[]).includes(personalTagFilter)):tasks;}
function renderFilteredView(){const tasks=filterByTag(getActiveTasks()),inc=tasks.filter(t=>!t.completed),tag=personalData.tags.find(t=>t.id===personalTagFilter);document.getElementById('filterTagIcon').textContent=tag?.icon||'';document.getElementById('filterTagName').textContent=(tag?.name||'')+' Tasks';document.getElementById('filterTagCount').textContent=inc.length+' task'+(inc.length!==1?'s':'');const sorted=[...inc.filter(t=>t.priority==='high'),...inc.filter(t=>t.priority==='medium'),...inc.filter(t=>t.priority==='low')];document.getElementById('filteredTasksList').innerHTML=sorted.length?sorted.map(t=>renderPersonalTask(t,true)).join(''):'<div class="empty-state">No tasks</div>';}
function renderPersonalTodo(){const tasks=filterByTag(getActiveTasks()),high=tasks.filter(t=>t.priority==='high'&&!t.completed),med=tasks.filter(t=>t.priority==='medium'&&!t.completed),low=tasks.filter(t=>t.priority==='low'&&!t.completed),done=tasks.filter(t=>t.completed);document.getElementById('highCount').textContent='('+high.length+')';document.getElementById('mediumCount').textContent='('+med.length+')';document.getElementById('lowCount').textContent='('+low.length+')';document.getElementById('doneCount').textContent='('+done.length+')';document.getElementById('highTasks').innerHTML=high.length?high.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">No high</div>';document.getElementById('mediumTasks').innerHTML=med.length?med.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">No medium</div>';document.getElementById('lowTasks').innerHTML=low.length?low.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">No low</div>';document.getElementById('doneTasks').innerHTML=done.length?done.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">Nothing done</div>';}
function updatePersonalStats(){const tasks=getActiveTasks(),inc=tasks.filter(t=>!t.completed);document.getElementById('pTotalTasks').textContent=inc.length;document.getElementById('pHighTasks').textContent=inc.filter(t=>t.priority==='high').length;document.getElementById('pHabits').textContent=personalData.tasks.filter(t=>t.repeat==='habit').length;const today=new Date().toDateString();document.getElementById('pCompletedToday').textContent=tasks.filter(t=>t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today).length;}
function setPersonalView(v,btn){personalView=v;document.querySelectorAll('.personal-view .view-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.getElementById('personalTodoView').style.display=v==='todo'&&!personalTagFilter?'block':'none';document.getElementById('personalProjectsView').style.display=v==='projects'?'block':'none';document.getElementById('personalProtocolsView').style.display=v==='protocols'?'block':'none';document.getElementById('personalFiltersRow').style.display=v==='todo'?'flex':'none';document.getElementById('tagFilterBanner').style.display='none';document.getElementById('filteredTasksView').style.display='none';if(v!=='todo')personalTagFilter='';renderPersonal();}
function renderPersonal(){const filtered=personalTagFilter&&personalView==='todo';document.getElementById('tagFilterBanner').style.display=filtered?'flex':'none';document.getElementById('filteredTasksView').style.display=filtered?'block':'none';document.getElementById('personalTodoView').style.display=personalView==='todo'&&!filtered?'block':'none';if(personalView==='todo'){filtered?renderFilteredView():renderPersonalTodo();}else if(personalView==='projects')renderProjects();else if(personalView==='protocols')renderProtocols();updatePersonalStats();}
function toggleDone(){document.getElementById('doneTasks').classList.toggle('expanded');}
function updatePersonalStats(){const tasks=getActiveTasks(),inc=tasks.filter(t=>!t.completed);document.getElementById('pTotalTasks').textContent=inc.length;document.getElementById('pHighTasks').textContent=inc.filter(t=>t.priority==='high').length;document.getElementById('pHabits').textContent=personalData.tasks.filter(t=>t.repeat==='habit').length;const today=new Date().toDateString();document.getElementById('pCompletedToday').textContent=tasks.filter(t=>t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today).length;}
// Projects
function renderProjects(){const g=document.getElementById('projectsGrid');if(!personalData.projects?.length){g.innerHTML='<div class="empty-state" style="grid-column:1/-1">No projects</div>';return;}g.innerHTML=personalData.projects.map(p=>{const subs=p.subtasks||[],done=subs.filter(s=>s.completed).length,pct=subs.length?Math.round(done/subs.length*100):0;return '<div class="project-card" onclick="openProjectModal(\''+p.id+'\')"><div class="project-card-header"><div class="project-card-title">'+(p.icon||'üéØ')+' '+escapeHtml(p.name)+'</div><span class="project-status '+p.status+'">'+p.status+'</span></div><div class="project-card-meta">'+done+'/'+subs.length+'</div><div class="project-progress"><div class="project-progress-bar" style="width:'+pct+'%"></div></div></div>';}).join('');}
function openProjectModal(id){tempSubtasks=[];if(id){const p=personalData.projects.find(x=>x.id===id);if(p){document.getElementById('projectModalTitle').textContent='Edit Project';document.getElementById('projectName').value=p.name;document.getElementById('projectIcon').value=p.icon||'';document.getElementById('projectStatus').value=p.status;document.getElementById('editingProjectId').value=id;tempSubtasks=[...(p.subtasks||[])];}else return;}else{document.getElementById('projectModalTitle').textContent='New Project';document.getElementById('projectName').value='';document.getElementById('projectIcon').value='';document.getElementById('projectStatus').value='someday';document.getElementById('editingProjectId').value='';}renderTempSubtasks();document.getElementById('projectModal').classList.add('active');}
function closeProjectModal(){document.getElementById('projectModal').classList.remove('active');}
function renderTempSubtasks(){document.getElementById('projectSubtasks').innerHTML=tempSubtasks.map((s,i)=>'<div class="subtask-item"><input type="checkbox" '+(s.completed?'checked':'')+' onchange="toggleTempSubtask('+i+')"><span style="flex:1;'+(s.completed?'text-decoration:line-through;color:var(--gray)':'')+'">'+escapeHtml(s.text)+'</span><button onclick="removeTempSubtask('+i+')">√ó</button></div>').join('');}
function addProjectSubtask(){const i=document.getElementById('newSubtask'),t=i.value.trim();if(!t)return;tempSubtasks.push({text:t,completed:false});i.value='';renderTempSubtasks();}
function toggleTempSubtask(i){tempSubtasks[i].completed=!tempSubtasks[i].completed;renderTempSubtasks();}
function removeTempSubtask(i){tempSubtasks.splice(i,1);renderTempSubtasks();}
function saveProject(){const name=document.getElementById('projectName').value.trim();if(!name)return alert('Enter name');const id=document.getElementById('editingProjectId').value,data={name,icon:document.getElementById('projectIcon').value.trim()||'üéØ',status:document.getElementById('projectStatus').value,subtasks:tempSubtasks};if(id){const idx=personalData.projects.findIndex(p=>p.id===id);if(idx>=0)personalData.projects[idx]={...personalData.projects[idx],...data};}else personalData.projects.push({id:genId(),...data});savePersonal();closeProjectModal();renderProjects();}
function deleteProject(id){if(!confirm('Delete?'))return;personalData.projects=personalData.projects.filter(p=>p.id!==id);savePersonal();renderProjects();}
// Protocols
function renderProtocols(){document.getElementById('protocolsGrid').innerHTML=personalData.protocols.map(p=>'<div class="protocol-card'+(p.active?' active':'')+'">'+(p.active?'<div class="protocol-active-badge">Active</div>':'')+'<div class="protocol-card-icon">'+p.icon+'</div><div class="protocol-card-title">'+escapeHtml(p.name)+'</div><div class="protocol-card-desc">'+escapeHtml(p.description||'')+'</div><div class="protocol-tasks-preview">'+p.tasks.length+' tasks</div><div style="display:flex;gap:8px"><button class="protocol-activate-btn" style="flex:1" onclick="toggleProtocol(\''+p.id+'\')">'+(p.active?'Deactivate':'Activate')+'</button><button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();openProtocolModal(\''+p.id+'\')">Edit</button></div></div>').join('');}
function toggleProtocol(id){const p=personalData.protocols.find(x=>x.id===id);if(p){p.active=!p.active;if(!p.active)personalData.tasks=personalData.tasks.filter(t=>t.protocolId!==id);savePersonal();renderProtocols();renderPersonalTodo();}}
function openProtocolModal(id){tempProtocolTasks=[];if(id){const p=personalData.protocols.find(x=>x.id===id);if(p){document.getElementById('protocolModalTitle').textContent='Edit Protocol';document.getElementById('protocolName').value=p.name;document.getElementById('protocolIcon').value=p.icon||'';document.getElementById('protocolDesc').value=p.description||'';document.getElementById('editingProtocolId').value=id;tempProtocolTasks=[...p.tasks];}else return;}else{document.getElementById('protocolModalTitle').textContent='New Protocol';document.getElementById('protocolName').value='';document.getElementById('protocolIcon').value='';document.getElementById('protocolDesc').value='';document.getElementById('editingProtocolId').value='';}renderTempProtocolTasks();document.getElementById('protocolModal').classList.add('active');}
function closeProtocolModal(){document.getElementById('protocolModal').classList.remove('active');}
function renderTempProtocolTasks(){document.getElementById('protocolTasks').innerHTML=tempProtocolTasks.map((t,i)=>'<div class="subtask-item"><span style="margin-right:8px">'+t.icon+'</span><span style="flex:1">'+escapeHtml(t.text)+'</span><button onclick="removeTempProtocolTask('+i+')">√ó</button></div>').join('');}
function addProtocolTask(){const t=document.getElementById('newProtocolTask').value.trim(),ic=document.getElementById('newProtocolTaskIcon').value.trim()||'üìå';if(!t)return;tempProtocolTasks.push({text:t,icon:ic});document.getElementById('newProtocolTask').value='';document.getElementById('newProtocolTaskIcon').value='';renderTempProtocolTasks();}
function removeTempProtocolTask(i){tempProtocolTasks.splice(i,1);renderTempProtocolTasks();}
function saveProtocol(){const name=document.getElementById('protocolName').value.trim();if(!name)return alert('Enter name');if(!tempProtocolTasks.length)return alert('Add tasks');const id=document.getElementById('editingProtocolId').value,data={name,icon:document.getElementById('protocolIcon').value.trim()||'üìã',description:document.getElementById('protocolDesc').value.trim(),tasks:tempProtocolTasks,active:false};if(id){const idx=personalData.protocols.findIndex(p=>p.id===id);if(idx>=0){data.active=personalData.protocols[idx].active;personalData.protocols[idx]={...personalData.protocols[idx],...data};}}else personalData.protocols.push({id:genId(),...data});savePersonal();closeProtocolModal();renderProtocols();}
function openPersonalAddModal(p){document.getElementById('pModalPriority').value=p;document.getElementById('pModalTask').value='';document.getElementById('pModalIcon').value='';document.getElementById('pModalRepeat').value='';document.getElementById('repeatOptions').style.display='none';populatePersonalSelects();document.getElementById('personalAddModal').classList.add('active');}
function closePersonalAddModal(){document.getElementById('personalAddModal').classList.remove('active');}
function toggleRepeatOptions(){document.getElementById('repeatOptions').style.display=document.getElementById('pModalRepeat').value==='weekly'?'block':'none';}
function savePersonalModalTask(){const text=document.getElementById('pModalTask').value.trim();if(!text)return;const icon=document.getElementById('pModalIcon').value.trim()||'üìå',priority=document.getElementById('pModalPriority').value,tag=document.getElementById('pModalTag').value,repeat=document.getElementById('pModalRepeat').value,task={id:genId(),text,icon,priority,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()};if(repeat){task.repeat=repeat;if(repeat==='weekly')task.repeatDay=parseInt(document.getElementById('pModalDay').value);if(repeat==='habit')task.habitDay=1;}personalData.tasks.push(task);savePersonal();closePersonalAddModal();renderPersonal();}
// Settings
function openSettings(){renderSettingsTabs();document.getElementById('settingsModal').classList.add('active');}
function closeSettings(){document.getElementById('settingsModal').classList.remove('active');}
function renderSettingsTabs(){document.getElementById('settingsTabs').innerHTML='<button class="modal-tab active" onclick="renderSettingsTab(\'api\',this)">AI Scan</button><button class="modal-tab" onclick="renderSettingsTab(\'tags\',this)">Tags</button><button class="modal-tab" onclick="renderSettingsTab(\'workprojects\',this)">Projects</button>'+(currentMode==='personal'?'<button class="modal-tab" onclick="renderSettingsTab(\'projects\',this)">Projects</button><button class="modal-tab" onclick="renderSettingsTab(\'protocols\',this)">Protocols</button>':'');renderSettingsTab('api');}
function renderSettingsTab(tab,btn){if(btn){document.querySelectorAll('.modal-tab').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');}var c=document.getElementById('settingsContent');if(tab==='api'){var hasKey=appSettings.apiKey&&appSettings.apiKey.length>10;c.innerHTML='<div class="modal-section"><h3>Anthropic API Key</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Required for scanning handwritten notes.</p><div class="api-key-input"><input type="password" id="apiKeyInput" placeholder="sk-ant-..." value="'+(appSettings.apiKey||'')+'"><button class="btn btn-primary btn-sm" onclick="saveApiKey()">Save</button></div><div class="api-status '+(hasKey?'connected':'disconnected')+'">'+(hasKey?'‚úì Key saved':'‚ö† No key')+'</div><p style="font-size:0.8rem;color:var(--gray);margin-top:12px">Get key: <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a></p></div>';}else if(tab==='tags'){var tags=currentMode==='work'?workData.tags:personalData.tags;c.innerHTML='<div class="modal-section"><h3>Tags</h3>'+tags.map(function(t){return'<div class="settings-item"><div class="settings-item-info"><span style="font-size:1.2rem;margin-right:8px">'+t.icon+'</span>'+escapeHtml(t.name)+'</div><div class="settings-item-actions"><button class="delete" onclick="deleteTag(\''+t.id+'\')">√ó</button></div></div>';}).join('')+'<div class="add-inline"><input type="text" id="newTagIcon" placeholder="üìå" style="width:60px"><input type="text" id="newTagName" placeholder="Tag name"><button class="btn btn-primary btn-sm" onclick="addTag()">Add</button></div></div>';}else if(tab==='workprojects'){var html='<div class="modal-section"><h3>Partners & Projects</h3>';workData.partners.forEach(function(partner){html+='<div style="margin-bottom:16px;padding:12px;background:var(--gray-light);border-radius:10px"><div style="font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">'+escapeHtml(partner.name)+'<button class="delete" onclick="deletePartner(\''+partner.id+'\')">√ó</button></div>';partner.projects.forEach(function(proj){html+='<div style="margin-left:12px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center"><span>‚Ü≥ '+escapeHtml(proj.name)+'</span><button class="delete" onclick="deleteWorkProject(\''+partner.id+'\',\''+proj.id+'\')">√ó</button></div>';proj.deliverables.forEach(function(del){html+='<div style="margin-left:28px;font-size:0.85rem;color:var(--gray);display:flex;justify-content:space-between;align-items:center"><span>‚Ä¢ '+escapeHtml(del.name)+'</span><button class="delete" onclick="deleteDeliverable(\''+partner.id+'\',\''+proj.id+'\',\''+del.id+'\')">√ó</button></div>';});});html+='<div class="add-inline" style="margin-top:8px;margin-left:12px"><input type="text" id="newProj_'+partner.id+'" placeholder="New project name"><button class="btn btn-primary btn-sm" onclick="addWorkProject(\''+partner.id+'\')">+ Project</button></div></div>';});html+='<div class="add-inline" style="margin-top:12px"><input type="text" id="newPartnerName" placeholder="New partner name"><button class="btn btn-primary btn-sm" onclick="addPartner()">+ Partner</button></div></div>';c.innerHTML=html;}else if(tab==='projects'){c.innerHTML='<div class="modal-section"><h3>Projects</h3>'+(personalData.projects.length?personalData.projects.map(function(p){return'<div class="settings-item"><div class="settings-item-info"><div class="settings-item-title">'+(p.icon||'üéØ')+' '+escapeHtml(p.name)+'</div></div><div class="settings-item-actions"><button onclick="closeSettings();openProjectModal(\''+p.id+'\')">‚úé</button><button class="delete" onclick="deleteProject(\''+p.id+'\')">√ó</button></div></div>';}).join(''):'<p style="color:var(--gray)">None</p>')+'<button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="closeSettings();openProjectModal()">+ New</button></div>';}else if(tab==='protocols'){c.innerHTML='<div class="modal-section"><h3>Protocols</h3>'+personalData.protocols.map(function(p){return'<div class="settings-item"><div class="settings-item-info"><div class="settings-item-title">'+p.icon+' '+escapeHtml(p.name)+'</div></div><div class="settings-item-actions"><button onclick="closeSettings();openProtocolModal(\''+p.id+'\')">‚úé</button><button class="delete" onclick="deleteProtocol(\''+p.id+'\')">√ó</button></div></div>';}).join('')+'<button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="closeSettings();openProtocolModal()">+ New</button></div>';}}
function saveApiKey(){appSettings.apiKey=document.getElementById('apiKeyInput').value.trim();saveSettings();renderSettingsTab('api');}
function addTag(){var ic=document.getElementById('newTagIcon').value.trim()||'üè∑Ô∏è',nm=document.getElementById('newTagName').value.trim();if(!nm)return;if(currentMode==='work'){workData.tags.push({id:genId(),name:nm,icon:ic});saveWork();populateWorkSelects();}else{personalData.tags.push({id:genId(),name:nm,icon:ic});savePersonal();populatePersonalSelects();}renderSettingsTab('tags');}
function deleteTag(id){if(currentMode==='work'){workData.tags=workData.tags.filter(function(t){return t.id!==id;});saveWork();populateWorkSelects();}else{personalData.tags=personalData.tags.filter(function(t){return t.id!==id;});savePersonal();populatePersonalSelects();}renderSettingsTab('tags');}
function addPartner(){var nm=document.getElementById('newPartnerName').value.trim();if(!nm)return;workData.partners.push({id:genId(),name:nm,color:'admin',projects:[]});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}
function deletePartner(id){if(!confirm('Delete partner and all its projects?'))return;workData.partners=workData.partners.filter(function(p){return p.id!==id;});workData.tasks=workData.tasks.filter(function(t){return t.partnerId!==id;});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}
function addWorkProject(partnerId){var input=document.getElementById('newProj_'+partnerId);var nm=input.value.trim();if(!nm)return;var partner=workData.partners.find(function(p){return p.id===partnerId;});if(partner){partner.projects.push({id:genId(),name:nm,deliverables:[{id:genId(),name:'General'}]});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}}
function deleteWorkProject(partnerId,projId){var partner=workData.partners.find(function(p){return p.id===partnerId;});if(partner){partner.projects=partner.projects.filter(function(p){return p.id!==projId;});workData.tasks=workData.tasks.filter(function(t){return!(t.partnerId===partnerId&&t.projectId===projId);});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}}
function deleteDeliverable(partnerId,projId,delId){var partner=workData.partners.find(function(p){return p.id===partnerId;});if(partner){var proj=partner.projects.find(function(p){return p.id===projId;});if(proj&&proj.deliverables.length>1){proj.deliverables=proj.deliverables.filter(function(d){return d.id!==delId;});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}else{alert('Cannot delete last deliverable');}}}
function deleteProtocol(id){if(!confirm('Delete?'))return;personalData.protocols=personalData.protocols.filter(function(p){return p.id!==id;});personalData.tasks=personalData.tasks.filter(function(t){return t.protocolId!==id;});savePersonal();renderSettingsTab('protocols');}
// Scan Modal
function openScanModal(){if(!appSettings.apiKey){alert('Add API key in Settings first.');openSettings();return;}resetScanModal();document.getElementById('scanModal').classList.add('active');}
function closeScanModal(){document.getElementById('scanModal').classList.remove('active');resetScanModal();}
function resetScanModal(){document.getElementById('scanUploadView').style.display='block';document.getElementById('scanReviewView').style.display='none';document.getElementById('fileInput').value='';suggestedTasks=[];}
document.addEventListener('DOMContentLoaded',function(){var dz=document.getElementById('dropZone');if(dz){dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('dragover');});dz.addEventListener('dragleave',function(){dz.classList.remove('dragover');});dz.addEventListener('drop',function(e){e.preventDefault();dz.classList.remove('dragover');var f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))processImage(f);});}});
function handleFileSelect(e){var f=e.target.files[0];if(f)processImage(f);}
async function processImage(file){var reader=new FileReader();reader.onload=async function(e){var base64=e.target.result.split(',')[1];document.getElementById('scanPreviewImg').src=e.target.result;document.getElementById('scanUploadView').style.display='none';document.getElementById('scanReviewView').style.display='block';document.getElementById('scanStatusBox').className='scan-status loading';document.getElementById('scanStatusBox').innerHTML='üîÑ Analyzing...';document.getElementById('suggestedTasksList').innerHTML='';document.getElementById('addSelectedBtn').disabled=true;try{var tasks=await analyzeImage(base64,file.type);suggestedTasks=tasks.map(function(t,i){return{id:i,text:t.text,priority:t.priority||'medium',tag:'',selected:true};});renderSuggestedTasks();document.getElementById('scanStatusBox').className='scan-status';document.getElementById('scanStatusBox').innerHTML='‚úì Found '+suggestedTasks.length+' task(s)';}catch(err){document.getElementById('scanStatusBox').className='scan-status error';document.getElementById('scanStatusBox').innerHTML='‚ùå '+err.message;}};reader.readAsDataURL(file);}
async function analyzeImage(base64,mediaType){var r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':appSettings.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:mediaType,data:base64}},{type:'text',text:'Extract tasks from this handwritten note/list. For each, determine priority (high if starred/underlined/circled, medium default, low if marked later/someday). Respond ONLY with JSON array: [{"text":"task","priority":"high|medium|low"}]. Empty array [] if none found.'}]}]})});if(!r.ok){var e=await r.json();throw new Error(e.error?.message||'Failed');}var d=await r.json();var m=d.content[0].text.match(/\[[\s\S]*\]/);if(!m)return[];try{return JSON.parse(m[0]);}catch(x){return[];}}
function renderSuggestedTasks(){var tags=currentMode==='work'?workData.tags:personalData.tags;var opts='<option value="">No tag</option>'+tags.map(function(t){return'<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>';}).join('');document.getElementById('suggestedTasksList').innerHTML=suggestedTasks.map(function(t){return'<div class="suggested-task"><input type="checkbox" '+(t.selected?'checked':'')+' onchange="toggleSuggestedTask('+t.id+')"><div class="suggested-task-content"><input type="text" class="suggested-task-text" value="'+escapeHtml(t.text)+'" onchange="updateSuggestedText('+t.id+',this.value)"><div class="suggested-task-options"><select onchange="updateSuggestedPriority('+t.id+',this.value)"><option value="high"'+(t.priority==='high'?' selected':'')+'>üî¥ High</option><option value="medium"'+(t.priority==='medium'?' selected':'')+'>üü† Medium</option><option value="low"'+(t.priority==='low'?' selected':'')+'>üü£ Low</option></select><select onchange="updateSuggestedTag('+t.id+',this.value)">'+opts+'</select></div></div><button class="remove-btn" onclick="removeSuggestedTask('+t.id+')">√ó</button></div>';}).join('');updateAddBtn();}
function toggleSuggestedTask(id){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.selected=!t.selected;updateAddBtn();}
function updateSuggestedText(id,v){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.text=v;}
function updateSuggestedPriority(id,v){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.priority=v;}
function updateSuggestedTag(id,v){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.tag=v;}
function removeSuggestedTask(id){suggestedTasks=suggestedTasks.filter(function(t){return t.id!==id;});renderSuggestedTasks();}
function updateAddBtn(){const c=suggestedTasks.filter(t=>t.selected).length;document.getElementById('addSelectedBtn').disabled=c===0;document.getElementById('addSelectedBtn').textContent='Add '+c+' Task'+(c!==1?'s':'');}
function addSelectedTasks(){const toAdd=suggestedTasks.filter(t=>t.selected&&t.text.trim());if(currentMode==='work'){const[partnerId,projectId,deliverableId]=document.getElementById('workProjectSelect').value.split('|');toAdd.forEach(t=>{workData.tasks.push({id:genId(),text:t.text.trim(),partnerId,projectId,deliverableId,priority:t.priority,tags:t.tag?[t.tag]:[],completed:false,createdAt:new Date().toISOString()});});saveWork();renderWork();}else{toAdd.forEach(t=>{const tagObj=personalData.tags.find(x=>x.id===t.tag);personalData.tasks.push({id:genId(),text:t.text.trim(),icon:tagObj?.icon||'üìå',priority:t.priority,tags:t.tag?[t.tag]:[],completed:false,createdAt:new Date().toISOString()});});savePersonal();renderPersonal();}closeScanModal();alert('Added '+toAdd.length+' task(s)!');}
// Init
loadData();populateWorkSelects();populatePersonalSelects();renderWork();
</script>
</body>
</html>
