<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MJ's Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--work-orange:#E86F2A;--work-orange-dark:#D4853A;--work-yellow-cream:#F5E6C8;--work-pink:#F8C8D4;--work-pink-light:#FDF2F5;--personal-bg:#F5F5F3;--personal-red:#E57373;--personal-orange:#FFB74D;--personal-purple:#9575CD;--personal-purple-dark:#7E57C2;--personal-blue:#64B5F6;--personal-green:#81C784;--white:#FFFFFF;--dark:#2D2D2D;--gray:#6B6B6B;--gray-light:#F7F7F7;--border:#E8E8E8;--danger:#EF5350;--success:#66BB6A}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--white);min-height:100vh;color:var(--dark);line-height:1.6;transition:background 0.3s ease}
body.personal-mode{background:var(--personal-bg)}
.container{max-width:1200px;margin:0 auto;padding:32px 24px}
header{margin-bottom:32px}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header-left{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
h1{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:600}
.mode-toggle{display:flex;background:var(--white);border-radius:25px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid var(--border)}
.mode-btn{padding:10px 24px;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;background:transparent;color:var(--gray);transition:all 0.2s ease}
.mode-btn.work-btn.active{background:var(--work-orange);color:white}
.mode-btn.personal-btn.active{background:var(--personal-purple-dark);color:white}
.header-actions{display:flex;gap:8px;align-items:center}
.settings-btn{background:var(--white);border:1px solid var(--border);padding:8px 20px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-family:'DM Sans',sans-serif;font-weight:600;transition:all 0.15s ease}
.settings-btn:hover{background:var(--gray-light);border-color:var(--gray)}
.clear-done-btn{background:none;border:1px solid var(--border);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;color:var(--gray);transition:all 0.15s ease}
.clear-done-btn:hover{border-color:var(--danger);color:var(--danger)}
.stats-row{display:flex;flex-direction:row;gap:12px;flex-wrap:nowrap}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 16px;flex:1 1 0;min-width:80px;transition:transform 0.15s ease,background 0.3s ease,border-color 0.3s ease}
.stat-card:hover{transform:translateY(-1px)}
.stat-card.highlight{background:var(--work-pink-light);border-color:var(--work-pink)}
.stat-card.warning{background:#FFF3E0;border-color:var(--work-orange)}
.stat-card.danger{background:#FFEBEE;border-color:var(--personal-red)}
body.personal-mode .stat-card.highlight{background:#EDE7F6;border-color:var(--personal-purple)}
body.personal-mode .stat-card.warning{background:#FFEBEE;border-color:var(--personal-red)}
.stat-number{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:600;line-height:1}
.stat-label{font-size:0.7rem;color:var(--gray);margin-top:2px;font-weight:500}
.quick-add{background:var(--work-yellow-cream);border-radius:16px;padding:24px;margin-bottom:32px;transition:background 0.3s ease}
body.personal-mode .quick-add{background:#EDE7F6}
.quick-add-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.quick-add-primary{display:flex;gap:12px;align-items:center;width:100%}
.quick-add-primary input[type="text"]{flex:1;min-width:200px}
.quick-add-options{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%;margin-top:4px}
.quick-add-options select,.quick-add-options input[type="date"]{padding:10px 14px;font-size:0.85rem}
.quick-add input[type="text"]{flex:1;min-width:200px;padding:14px 18px;border:1px solid var(--border);border-radius:10px;font-size:0.95rem;font-family:'DM Sans',sans-serif;background:var(--white);transition:border-color 0.15s ease}
.quick-add input[type="text"]:focus{outline:none;border-color:var(--work-orange)}
body.personal-mode .quick-add input[type="text"]:focus{border-color:var(--personal-purple-dark)}
.quick-add select,.quick-add input[type="date"]{padding:14px 18px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;background:var(--white)}
.btn{padding:14px 28px;border:none;border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;transition:all 0.15s ease}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--work-orange);color:var(--white)}
.btn-primary:hover{opacity:0.9}
body.personal-mode .btn-primary{background:var(--personal-purple-dark)}
.btn-secondary{background:var(--white);color:var(--dark);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--gray-light)}
.btn-sm{padding:8px 16px;font-size:0.8rem}
.btn-icon{padding:14px 16px;background:var(--white);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:1.2rem;transition:all 0.15s ease}
.btn-icon:hover{background:var(--gray-light);border-color:var(--gray)}
.btn-danger{background:none;border:1px solid var(--border);color:var(--gray);padding:8px 14px;border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer}
.btn-danger:hover{border-color:var(--danger);color:var(--danger);background:#FFF5F5}
.work-view{display:block}body.personal-mode .work-view{display:none}
.personal-view{display:none}body.personal-mode .personal-view{display:block}
.view-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.view-tab{padding:12px 24px;background:var(--white);border:1px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;color:var(--gray);transition:all 0.15s ease}
.view-tab:hover{border-color:var(--gray)}
.view-tab.active{background:var(--work-orange);color:white;border-color:var(--work-orange)}
body.personal-mode .view-tab.active{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:24px}
.filter-label{font-size:0.85rem;font-weight:600;color:var(--gray)}
.filter-btn{padding:8px 16px;background:var(--white);border:1px solid var(--border);border-radius:20px;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;color:var(--gray);transition:all 0.15s ease}
.filter-btn:hover{border-color:var(--gray)}
.filter-btn.active{background:var(--work-orange);color:var(--white);border-color:var(--work-orange)}
body.personal-mode .filter-btn.active{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark);color:white}
.tag-filter-banner{background:var(--work-yellow-cream);padding:16px 24px;border-radius:12px;margin-bottom:24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
body.personal-mode .tag-filter-banner{background:#EDE7F6}
.tag-filter-banner h3{font-family:'Playfair Display',serif;font-size:1.1rem}
.tag-filter-count{background:var(--work-orange);color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:600}
body.personal-mode .tag-filter-count{background:var(--personal-purple-dark)}
.clear-filter-btn{margin-left:auto;padding:8px 16px;background:var(--white);border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer}
.partners-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:24px}
.partner-section{background:var(--white);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.partner-header{padding:16px 24px;font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.partner-header .task-count{background:var(--gray-light);color:var(--gray);padding:4px 12px;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.75rem;font-weight:600}
.haven .partner-header{background:var(--work-pink-light)}.haven .partner-header .task-count{background:var(--work-pink);color:var(--dark)}
.bonclub .partner-header{background:#FFF3E0}.bonclub .partner-header .task-count{background:var(--work-orange);color:white}
.admin .partner-header{background:var(--work-yellow-cream)}.admin .partner-header .task-count{background:var(--work-orange-dark);color:white}
.project-section{border-bottom:1px solid var(--border)}
.project-header{padding:12px 24px;background:var(--gray-light);font-weight:600;font-size:0.85rem;color:var(--gray)}
.deliverable-section{padding:12px 24px;border-left:3px solid transparent}
.deliverable-section.has-tasks{border-left-color:var(--work-orange)}
.deliverable-name{font-size:0.75rem;color:var(--gray);margin-bottom:8px;font-weight:600;text-transform:uppercase}
.task-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.task-item:last-child{border-bottom:none}
.task-checkbox{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;cursor:pointer;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;background:var(--white);transition:all 0.15s ease}
.task-checkbox:hover{border-color:var(--work-orange)}
body.personal-mode .task-checkbox:hover{border-color:var(--personal-purple-dark)}
.task-checkbox.checked{background:var(--work-orange);border-color:var(--work-orange)}
.task-checkbox.checked::after{content:'‚úì';color:white;font-size:12px;font-weight:bold}
body.personal-mode .task-checkbox.checked{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.task-content{flex:1}
.task-text{font-size:0.95rem;font-weight:500}
.task-item.completed{opacity:0.45}
.task-item.completed .task-text{text-decoration:line-through;color:var(--gray)}
.task-meta{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center}
.task-due{font-size:0.75rem;padding:4px 10px;font-weight:600;border-radius:6px;background:var(--gray-light);color:var(--gray)}
.task-due.overdue{background:#FFEBEE;color:#C62828}
.task-due.today{background:#E8F5E9;color:#2E7D32}
.task-due.tomorrow{background:#FFF3E0;color:#E65100}
.task-tag{font-size:0.7rem;padding:4px 10px;font-weight:600;border-radius:6px;background:var(--gray-light);color:var(--gray)}
.task-source{font-size:0.7rem;color:var(--gray);font-style:italic}
.delete-task{opacity:0;background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem;padding:4px 8px;transition:all 0.15s ease}
.task-item:hover .delete-task,.work-task-item:hover .delete-task,.personal-task-item:hover .delete-task{opacity:1}
.delete-task:hover{color:var(--danger)}
.empty-state{text-align:center;padding:32px 20px;color:var(--gray);font-size:0.9rem}
.priority-section{margin-bottom:24px}
.priority-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.priority-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:700;text-transform:uppercase}
.priority-pill.high{background:#FFEBEE;color:var(--personal-red)}.priority-pill.high::before{content:'‚ñ≤';font-size:0.7rem}
.priority-pill.medium{background:#FFF3E0;color:var(--personal-orange)}.priority-pill.medium::before{content:'‚óè';font-size:0.6rem}
.priority-pill.low{background:#EDE7F6;color:var(--personal-purple)}.priority-pill.low::before{content:'‚ñº';font-size:0.7rem}
.priority-count{font-size:0.85rem;color:var(--gray);font-weight:500}
.priority-add-btn{margin-left:auto;background:none;border:none;font-size:1.2rem;color:var(--gray);cursor:pointer;transition:color 0.15s ease}
.priority-add-btn:hover{color:var(--dark)}
.priority-tasks{background:var(--white);border-radius:16px;overflow:hidden;border:1px solid var(--border);border-left:3px solid var(--border)}
.priority-section.p-high .priority-tasks{border-left-color:var(--personal-red)}
.priority-section.p-medium .priority-tasks{border-left-color:var(--personal-orange)}
.priority-section.p-low .priority-tasks{border-left-color:var(--personal-purple);opacity:0.85}
.priority-empty{padding:20px;text-align:center;color:var(--gray);font-size:0.85rem;border:1.5px dashed var(--border);border-radius:12px;margin:8px;opacity:0.7}
.work-task-item,.personal-task-item{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);background:var(--white);transition:background 0.1s ease}
.work-task-item:hover,.personal-task-item:hover{background:var(--gray-light)}
.work-task-item:last-child,.personal-task-item:last-child{border-bottom:none}
.work-task-item.completed,.personal-task-item.completed{opacity:0.45}
.work-task-item.completed .work-task-text,.personal-task-item.completed .personal-task-text{text-decoration:line-through;color:var(--gray)}
.work-task-content,.personal-task-content{flex:1}
.work-task-text,.personal-task-text{font-weight:500}
.work-task-meta,.personal-task-meta{font-size:0.8rem;color:var(--gray);margin-top:4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.work-task-checkbox,.personal-task-checkbox{width:26px;height:26px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s ease}
.work-task-checkbox:hover{border-color:var(--work-orange)}
.personal-task-checkbox:hover{border-color:var(--personal-purple-dark)}
.work-task-checkbox.checked{background:var(--work-orange);border-color:var(--work-orange)}
.work-task-checkbox.checked::after,.personal-task-checkbox.checked::after{content:'‚úì';color:white;font-size:14px;font-weight:bold}
.personal-task-checkbox.checked{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.personal-task-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background:var(--gray-light)}
.habit-badge{background:var(--personal-green);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.repeat-badge{background:var(--personal-blue);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.priority-badge{padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.priority-badge.high{background:#FFEBEE;color:var(--personal-red)}
.priority-badge.medium{background:#FFF3E0;color:var(--personal-orange)}
.priority-badge.low{background:#EDE7F6;color:var(--personal-purple)}
.protocol-source{font-size:0.7rem;color:var(--personal-purple);font-weight:600}
.projects-grid,.protocols-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.project-card{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:20px;cursor:pointer;transition:all 0.15s ease}
.project-card:hover{border-color:var(--personal-purple);box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-2px)}
.project-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.project-card-title{font-weight:600;display:flex;align-items:center;gap:8px}
.project-status{padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
.project-status.active{background:var(--personal-green);color:white}
.project-status.paused{background:var(--personal-orange);color:white}
.project-status.someday{background:var(--gray-light);color:var(--gray)}
.project-card-meta{font-size:0.85rem;color:var(--gray)}
.project-progress{margin-top:12px;height:6px;background:var(--gray-light);border-radius:3px;overflow:hidden}
.project-progress-bar{height:100%;background:var(--personal-purple-dark);transition:width 0.3s ease}
.protocol-card{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:24px;position:relative;transition:all 0.15s ease}
.protocol-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.06)}
.protocol-card.active{border-color:var(--personal-purple);box-shadow:0 0 0 3px rgba(149,117,205,0.2)}
.protocol-card-icon{font-size:2rem;margin-bottom:12px}
.protocol-card-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:600;margin-bottom:8px}
.protocol-card-desc{font-size:0.85rem;color:var(--gray);margin-bottom:16px}
.protocol-tasks-preview{font-size:0.8rem;color:var(--gray);margin-bottom:16px}
.protocol-activate-btn{width:100%;padding:12px;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;background:var(--gray-light);transition:all 0.15s ease}
.protocol-activate-btn:hover{background:var(--personal-purple);color:white}
.protocol-card.active .protocol-activate-btn{background:var(--personal-red);color:white}
.protocol-card.active .protocol-activate-btn:hover{opacity:0.9}
.protocol-active-badge{position:absolute;top:12px;right:12px;background:var(--personal-purple-dark);color:white;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600}
.done-section{margin-top:32px}
.done-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer;user-select:none}
.done-pill{padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:700;text-transform:uppercase;background:var(--gray-light);color:var(--gray)}
.done-toggle{color:var(--gray);transition:transform 0.2s ease;font-size:0.8rem}
.done-toggle.expanded{transform:rotate(180deg)}
.done-tasks{display:none}.done-tasks.expanded{display:block}
.filtered-tasks-list{background:var(--white);border-radius:16px;overflow:hidden;border:1px solid var(--border)}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s ease}
.modal-overlay.active{display:flex;opacity:1}
.modal{background:var(--white);border-radius:20px;padding:32px;max-width:600px;width:90%;max-height:85vh;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.modal::-webkit-scrollbar{width:6px}
.modal::-webkit-scrollbar-track{background:transparent}
.modal::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.modal::-webkit-scrollbar-thumb:hover{background:var(--gray)}
.modal.wide{max-width:800px}
.modal h2{font-family:'Playfair Display',serif;font-weight:600;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.modal-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.modal-tab{padding:10px 20px;background:var(--gray-light);border:none;border-radius:8px;font-size:0.85rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;color:var(--gray);transition:all 0.15s ease}
.modal-tab.active{background:var(--work-orange);color:white}
body.personal-mode .modal-tab.active{background:var(--personal-purple-dark)}
.modal-section{margin-bottom:24px}
.modal-section h3{font-size:0.85rem;color:var(--gray);margin-bottom:12px;font-weight:600}
.modal input,.modal select,.modal textarea{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;margin-bottom:8px;background:var(--white)}
.modal textarea{min-height:80px;resize:vertical}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--gray-light);border-radius:10px;margin-bottom:8px}
.settings-item-info{flex:1}
.settings-item-title{font-weight:600;font-size:0.9rem}
.settings-item-meta{font-size:0.8rem;color:var(--gray)}
.settings-item-actions button{background:none;border:none;color:var(--gray);cursor:pointer;font-size:1rem;padding:4px 8px;transition:color 0.15s ease}
.settings-item-actions button.delete:hover{color:var(--danger)}
.add-inline{display:flex;gap:8px;margin-top:12px}
.add-inline input{flex:1;margin-bottom:0}
.subtask-item{display:flex;align-items:center;gap:8px;padding:8px 0;font-size:0.85rem}
.subtask-item button{background:none;border:none;color:var(--gray);cursor:pointer}
.api-key-input{display:flex;gap:8px}
.api-key-input input{flex:1;margin-bottom:0;font-family:monospace;font-size:0.85rem}
.api-status{padding:8px 12px;border-radius:8px;font-size:0.85rem;margin-top:8px}
.api-status.connected{background:#E8F5E9;color:#2E7D32}
.api-status.disconnected{background:#FFF3E0;color:#E65100}
.scan-preview{display:flex;gap:24px;margin-bottom:24px}
.scan-image{width:200px;height:200px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
.scan-instructions{flex:1}
.scan-instructions h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:8px}
.scan-instructions p{color:var(--gray);font-size:0.9rem;margin-bottom:12px}
.scan-status{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--gray-light);border-radius:10px;font-size:0.9rem}
.scan-status.loading{background:#E3F2FD;color:#1565C0}
.scan-status.error{background:#FFEBEE;color:#C62828}
.suggested-task{display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--gray-light);border-radius:12px;margin-bottom:12px}
.suggested-task input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--work-orange)}
body.personal-mode .suggested-task input[type="checkbox"]{accent-color:var(--personal-purple-dark)}
.suggested-task-content{flex:1}
.suggested-task-text{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:0.9rem;font-family:'DM Sans',sans-serif}
.suggested-task-options{display:flex;gap:8px;margin-top:8px}
.suggested-task-options select{padding:6px 10px;font-size:0.8rem;border:1px solid var(--border);border-radius:6px}
.suggested-task .remove-btn{background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem}
.suggested-task .remove-btn:hover{color:var(--danger)}
.drop-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s ease}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--work-orange);background:var(--work-yellow-cream)}
body.personal-mode .drop-zone:hover,body.personal-mode .drop-zone.dragover{border-color:var(--personal-purple-dark);background:#EDE7F6}
.drop-zone-icon{font-size:3rem;margin-bottom:12px}
.drop-zone-text{font-weight:600;margin-bottom:4px}
.drop-zone-hint{font-size:0.85rem;color:var(--gray)}
/* Toast notification */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--dark);color:white;padding:14px 28px;border-radius:12px;font-size:0.9rem;font-weight:500;z-index:2000;opacity:0;transition:all 0.3s ease;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,0.2)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{background:#2E7D32}
.toast.error{background:#C62828}
/* Keyboard shortcut hint */
.kbd-hint{font-size:0.7rem;color:var(--gray);margin-top:8px;text-align:center}
.kbd{background:var(--gray-light);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-family:monospace;font-size:0.7rem}
/* Google Tasks Sync */
.sync-btn{background:none;border:1px solid var(--border);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;color:var(--gray);transition:all 0.15s ease;display:inline-flex;align-items:center;gap:6px}
.sync-btn:hover{border-color:var(--work-orange);color:var(--work-orange)}
.sync-btn.syncing{pointer-events:none;opacity:0.6}
.sync-btn.syncing .sync-icon{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.sync-badge{background:var(--work-orange);color:white;font-size:0.65rem;font-weight:700;padding:2px 6px;border-radius:10px;margin-left:2px}
.sync-task-item{display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--gray-light);border-radius:12px;margin-bottom:12px}
.sync-task-item input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--work-orange);flex-shrink:0}
.sync-task-content{flex:1}
.sync-task-title{font-weight:600;font-size:0.95rem;margin-bottom:8px}
.sync-task-notes{font-size:0.8rem;color:var(--gray);margin-bottom:8px;font-style:italic}
.sync-task-options{display:flex;gap:8px;flex-wrap:wrap}
.sync-task-options select{padding:8px 12px;font-size:0.8rem;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;background:var(--white)}
.sync-empty{text-align:center;padding:32px 20px;color:var(--gray)}
.sync-empty-icon{font-size:2.5rem;margin-bottom:12px}
.sync-empty-text{font-size:0.95rem;font-weight:500;margin-bottom:4px}
.sync-empty-sub{font-size:0.85rem}
@media(max-width:768px){.container{padding:16px 12px}.partners-grid,.projects-grid,.protocols-grid{grid-template-columns:1fr}.quick-add{padding:16px}.quick-add-primary{flex-wrap:wrap}.quick-add-primary input[type="text"]{width:100%;min-width:0}.quick-add-options{gap:6px}.quick-add-options select,.quick-add-options input[type="date"]{flex:1;min-width:0;padding:10px 12px;font-size:0.8rem}h1{font-size:1.8rem}.header-left{flex-direction:column;align-items:flex-start;gap:12px}.mode-toggle{width:100%;justify-content:center}.scan-preview{flex-direction:column}.scan-image{width:100%;height:150px}.kbd-hint{display:none}.stats-row{flex-wrap:wrap}.stat-card{flex:1 1 45%;min-width:0}.filter-btn{padding:6px 12px;font-size:0.75rem}.view-tab{padding:10px 16px;font-size:0.85rem}.work-task-item,.personal-task-item{padding:12px 16px}.btn{padding:12px 20px}.btn-icon{padding:12px 14px}}
</style>
</head>
<body>
<div class="container">
<header>
<div class="header-top">
<div class="header-left"><h1>MJ's Planner</h1><div class="mode-toggle"><button class="mode-btn work-btn active" onclick="setMode('work')">Work</button><button class="mode-btn personal-btn" onclick="setMode('personal')">Personal</button></div></div>
<div class="header-actions"><button class="sync-btn work-view" id="syncBtn" onclick="syncGoogleTasks()" title="Sync Google Tasks"><span class="sync-icon">üîÑ</span> Sync<span class="sync-badge" id="syncBadge" style="display:none">0</span></button><button class="clear-done-btn" id="clearDoneBtn" onclick="clearCompleted()" style="display:none">Clear Done</button><button class="settings-btn" onclick="openSettings()">‚öô Settings</button></div>
</div>
<div class="stats-row work-view"><div class="stat-card"><div class="stat-number" id="totalTasks">0</div><div class="stat-label">Total</div></div><div class="stat-card warning"><div class="stat-number" id="urgentTasks">0</div><div class="stat-label">Urgent</div></div><div class="stat-card" id="overdueCard"><div class="stat-number" id="overdueTasks">0</div><div class="stat-label">Overdue</div></div><div class="stat-card highlight"><div class="stat-number" id="completedToday">0</div><div class="stat-label">Done Today</div></div></div>
<div class="stats-row personal-view"><div class="stat-card"><div class="stat-number" id="pTotalTasks">0</div><div class="stat-label">To-Do</div></div><div class="stat-card warning"><div class="stat-number" id="pHighTasks">0</div><div class="stat-label">High</div></div><div class="stat-card"><div class="stat-number" id="pHabits">0</div><div class="stat-label">Habits</div></div><div class="stat-card highlight"><div class="stat-number" id="pCompletedToday">0</div><div class="stat-label">Done Today</div></div></div>
</header>
<div class="work-view">
<div class="quick-add"><div class="quick-add-row">
<div class="quick-add-primary">
<input type="text" id="workTaskInput" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter')addWorkTask()">
<button class="btn btn-primary" onclick="addWorkTask()">Add Task</button>
<button class="btn-icon" onclick="openScanModal()" title="Scan handwritten notes">üì∑</button>
</div>
<div class="quick-add-options">
<select id="workProjectSelect"></select>
<select id="workPrioritySelect"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">Urgent</option></select>
<input type="date" id="workDueDate">
<select id="workTagSelect"><option value="">Tag</option></select>
</div>
</div>
<div class="kbd-hint"><span class="kbd">Enter</span> to add ¬∑ <span class="kbd">Tab</span>/<span class="kbd">Shift+Tab</span> to switch modes</div>
</div>
<div class="view-tabs"><button class="view-tab active" onclick="setWorkView('priority',this)">üìã By Priority</button><button class="view-tab" onclick="setWorkView('projects',this)">üìÅ By Project</button></div>
<div id="workPriorityView">
<div class="priority-section p-high"><div class="priority-header"><span class="priority-pill high">Urgent</span><span class="priority-count" id="wHighCount">(0)</span></div><div class="priority-tasks" id="wHighTasks"></div></div>
<div class="priority-section p-medium"><div class="priority-header"><span class="priority-pill medium">Medium</span><span class="priority-count" id="wMediumCount">(0)</span></div><div class="priority-tasks" id="wMediumTasks"></div></div>
<div class="priority-section p-low"><div class="priority-header"><span class="priority-pill low">Low</span><span class="priority-count" id="wLowCount">(0)</span></div><div class="priority-tasks" id="wLowTasks"></div></div>
<div class="done-section"><div class="done-header" onclick="toggleWorkDone()"><span class="done-pill">Done <span id="wDoneCount">(0)</span></span><span class="done-toggle" id="wDoneToggle">‚ñº</span></div><div class="done-tasks" id="wDoneTasks"></div></div>
</div>
<div id="workProjectsView" class="partners-grid" style="display:none"></div>
</div>
<div class="personal-view">
<div class="quick-add"><div class="quick-add-row">
<div class="quick-add-primary">
<input type="text" id="personalTaskInput" placeholder="Add a to-do..." onkeypress="if(event.key==='Enter')addPersonalTask()">
<button class="btn btn-primary" onclick="addPersonalTask()">Add</button>
<button class="btn-icon" onclick="openScanModal()" title="Scan handwritten notes">üì∑</button>
</div>
<div class="quick-add-options">
<select id="personalPrioritySelect"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select>
<select id="personalTagSelect"><option value="">Tag</option></select>
</div>
</div>
<div class="kbd-hint"><span class="kbd">Enter</span> to add ¬∑ <span class="kbd">Tab</span>/<span class="kbd">Shift+Tab</span> to switch modes</div>
</div>
<div class="view-tabs"><button class="view-tab active" onclick="setPersonalView('todo',this)">üìã To-Do</button><button class="view-tab" onclick="setPersonalView('projects',this)">üéØ Projects</button><button class="view-tab" onclick="setPersonalView('protocols',this)">ü©π Protocols</button></div>
<div id="personalFiltersRow" class="filters"><span class="filter-label">Filter:</span><button class="filter-btn active" onclick="setPersonalTagFilter('',this)">All</button><span id="personalTagFilters"></span></div>
<div id="tagFilterBanner" class="tag-filter-banner" style="display:none"><h3><span id="filterTagIcon"></span> <span id="filterTagName"></span></h3><span class="tag-filter-count" id="filterTagCount">0 tasks</span><button class="clear-filter-btn" onclick="clearTagFilter()">√ó Clear</button></div>
<div id="filteredTasksView" style="display:none"><div class="filtered-tasks-list" id="filteredTasksList"></div></div>
<div id="personalTodoView">
<div class="priority-section p-high"><div class="priority-header"><span class="priority-pill high">High</span><span class="priority-count" id="highCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('high')">+</button></div><div class="priority-tasks" id="highTasks"></div></div>
<div class="priority-section p-medium"><div class="priority-header"><span class="priority-pill medium">Medium</span><span class="priority-count" id="mediumCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('medium')">+</button></div><div class="priority-tasks" id="mediumTasks"></div></div>
<div class="priority-section p-low"><div class="priority-header"><span class="priority-pill low">Low</span><span class="priority-count" id="lowCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('low')">+</button></div><div class="priority-tasks" id="lowTasks"></div></div>
<div class="done-section"><div class="done-header" onclick="toggleDone()"><span class="done-pill">Done <span id="doneCount">(0)</span></span><span class="done-toggle" id="pDoneToggle">‚ñº</span></div><div class="done-tasks" id="doneTasks"></div></div>
</div>
<div id="personalProjectsView" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="font-family:'Playfair Display',serif;font-size:1.3rem">My Projects</h2><button class="btn btn-primary btn-sm" onclick="openProjectModal()">+ New Project</button></div><div class="projects-grid" id="projectsGrid"></div></div>
<div id="personalProtocolsView" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><div><h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:4px">My Protocols</h2><p style="color:var(--gray);font-size:0.85rem">Pre-built routines for tough days</p></div><button class="btn btn-primary btn-sm" onclick="openProtocolModal()">+ New Protocol</button></div><div class="protocols-grid" id="protocolsGrid"></div></div>
</div>
</div>
<div class="toast" id="toast"></div>
<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()"><div class="modal"><h2>‚öô Settings</h2><div class="modal-tabs" id="settingsTabs"></div><div id="settingsContent"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeSettings()">Done</button></div></div></div>
<!-- Personal Add Modal -->
<div class="modal-overlay" id="personalAddModal" onclick="if(event.target===this)closePersonalAddModal()"><div class="modal"><h2>Add To-Do</h2><div class="modal-section"><h3>Task</h3><input type="text" id="pModalTask" placeholder="e.g., Pay rent" onkeypress="if(event.key==='Enter')savePersonalModalTask()"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="pModalIcon" placeholder="üìå" style="width:80px"></div><div style="display:flex;gap:16px"><div class="modal-section" style="flex:1"><h3>Priority</h3><select id="pModalPriority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div><div class="modal-section" style="flex:1"><h3>Tag</h3><select id="pModalTag"></select></div></div><div class="modal-section"><h3>Repeat?</h3><select id="pModalRepeat" onchange="toggleRepeatOptions()"><option value="">No repeat</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="habit">30-day Habit</option></select></div><div id="repeatOptions" style="display:none"><div class="modal-section"><h3>Day</h3><select id="pModalDay"><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option></select></div></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closePersonalAddModal()">Cancel</button><button class="btn btn-primary" onclick="savePersonalModalTask()">Add</button></div></div></div>
<!-- Project Modal -->
<div class="modal-overlay" id="projectModal" onclick="if(event.target===this)closeProjectModal()"><div class="modal"><h2 id="projectModalTitle">New Project</h2><div class="modal-section"><h3>Name</h3><input type="text" id="projectName" placeholder="e.g., Redecorate bedroom"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="projectIcon" placeholder="üéØ" style="width:80px"></div><div class="modal-section"><h3>Status</h3><select id="projectStatus"><option value="someday">Someday</option><option value="active">Active</option><option value="paused">Paused</option></select></div><div class="modal-section"><h3>Subtasks</h3><div id="projectSubtasks"></div><div class="add-inline"><input type="text" id="newSubtask" placeholder="Add subtask" onkeypress="if(event.key==='Enter')addProjectSubtask()"><button class="btn btn-primary btn-sm" onclick="addProjectSubtask()">+</button></div></div><input type="hidden" id="editingProjectId"><div class="modal-actions"><button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button><button class="btn btn-primary" onclick="saveProject()">Save</button></div></div></div>
<!-- Protocol Modal -->
<div class="modal-overlay" id="protocolModal" onclick="if(event.target===this)closeProtocolModal()"><div class="modal"><h2 id="protocolModalTitle">New Protocol</h2><div class="modal-section"><h3>Name</h3><input type="text" id="protocolName" placeholder="e.g., Morning Routine"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="protocolIcon" placeholder="üåÖ" style="width:80px"></div><div class="modal-section"><h3>Description</h3><textarea id="protocolDesc" placeholder="When to use this protocol..."></textarea></div><div class="modal-section"><h3>Tasks</h3><div id="protocolTasks"></div><div class="add-inline"><input type="text" id="newProtocolTask" placeholder="Add task" onkeypress="if(event.key==='Enter')addProtocolTask()"><input type="text" id="newProtocolTaskIcon" placeholder="üìå" style="width:60px"><button class="btn btn-primary btn-sm" onclick="addProtocolTask()">+</button></div></div><input type="hidden" id="editingProtocolId"><div class="modal-actions"><button class="btn btn-secondary" onclick="closeProtocolModal()">Cancel</button><button class="btn btn-primary" onclick="saveProtocol()">Save</button></div></div></div>
<!-- Scan Modal -->
<div class="modal-overlay" id="scanModal" onclick="if(event.target===this)closeScanModal()"><div class="modal wide"><h2>üì∑ Scan Handwritten Notes</h2><div id="scanUploadView"><div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()"><div class="drop-zone-icon">üìù</div><div class="drop-zone-text">Drop image here or click to upload</div><div class="drop-zone-hint">Photos of lists, mind maps, sticky notes</div></div><input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)"></div><div id="scanReviewView" style="display:none"><div class="scan-preview"><img id="scanPreviewImg" class="scan-image" src="" alt=""><div class="scan-instructions"><h3>Review & Edit Tasks</h3><p>Check tasks to add, edit text, set priority and tags.</p><div id="scanStatusBox" class="scan-status"></div></div></div><div id="suggestedTasksList"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="resetScanModal()">‚Üê Different Image</button><button class="btn btn-primary" id="addSelectedBtn" onclick="addSelectedTasks()" disabled>Add Selected</button></div></div></div></div>

<!-- Sync Modal -->
<div class="modal-overlay" id="syncModal" onclick="if(event.target===this)closeSyncModal()"><div class="modal wide"><h2>üîÑ Google Tasks</h2><div id="syncContent"><div class="sync-empty"><div class="sync-empty-icon">üì≠</div><div class="sync-empty-text">No new tasks</div></div></div><div class="modal-actions" id="syncActions" style="display:none"><button class="btn btn-secondary" onclick="closeSyncModal()">Cancel</button><button class="btn btn-primary" id="importSyncBtn" onclick="importSyncedTasks()">Import Selected</button></div></div></div>

<script>
let currentMode='work',workView='priority',personalView='todo',personalTagFilter='',tempSubtasks=[],tempProtocolTasks=[],suggestedTasks=[];

const defaultWorkData={partners:[{id:'haven',name:'Haven Studio',color:'haven',projects:[{id:'rubino',name:'Rubino',deliverables:[{id:'playbook',name:'Social Media Playbook'},{id:'content',name:'Content Creation'},{id:'strategy',name:'Strategy'},{id:'influencer',name:'Influencer Campaign'},{id:'casting',name:'Casting'},{id:'toolkit1',name:'ToolKit #1'},{id:'videokids',name:'Video Series - Kids'}]}]},{id:'bonclub',name:'Bonclub',color:'bonclub',projects:[{id:'vanhoutte',name:'Van Houtte',deliverables:[{id:'campaign',name:'Campaign'},{id:'social',name:'Social Media'}]}]},{id:'admin',name:'Admin',color:'admin',projects:[{id:'business',name:'Business',deliverables:[{id:'invoices',name:'Invoices'},{id:'taxes',name:'Taxes'},{id:'linkedin',name:'LinkedIn'}]}]}],tags:[{id:'email',name:'Email',icon:'üìß'},{id:'call',name:'Call',icon:'üìû'},{id:'review',name:'Review',icon:'üëÄ'},{id:'meeting',name:'Meeting',icon:'ü§ù'},{id:'writing',name:'Writing',icon:'‚úçÔ∏è'},{id:'quickwin',name:'Quick Win',icon:'‚ö°'}],tasks:[{id:'t1',text:'Guidelines',partnerId:'haven',projectId:'rubino',deliverableId:'influencer',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:00.000Z'},{id:'t2',text:'Contract',partnerId:'haven',projectId:'rubino',deliverableId:'influencer',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:01.000Z'},{id:'t3',text:'Reporting',partnerId:'haven',projectId:'rubino',deliverableId:'influencer',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:02.000Z'},{id:'t4',text:'Create Social Media Calendar',partnerId:'haven',projectId:'rubino',deliverableId:'toolkit1',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:03.000Z'},{id:'t5',text:'Send Liana host suggestions',partnerId:'haven',projectId:'rubino',deliverableId:'videokids',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:04.000Z'},{id:'t6',text:'Competitive landscape audit + best performing content analysis',partnerId:'bonclub',projectId:'vanhoutte',deliverableId:'social',priority:'medium',tags:[],completed:false,createdAt:'2026-02-06T12:00:05.000Z'},{id:'t7',text:'30-day content calendar blueprint',partnerId:'bonclub',projectId:'vanhoutte',deliverableId:'social',priority:'medium',tags:[],completed:false,createdAt:'2026-02-06T12:00:06.000Z'},{id:'t8',text:'KPIs',partnerId:'bonclub',projectId:'vanhoutte',deliverableId:'social',priority:'medium',tags:[],completed:false,createdAt:'2026-02-06T12:00:07.000Z'},{id:'t9',text:'Rubino #2',partnerId:'admin',projectId:'business',deliverableId:'invoices',priority:'low',tags:[],completed:false,createdAt:'2026-02-06T12:00:08.000Z'},{id:'t10',text:'Cancel Antidote',partnerId:'admin',projectId:'business',deliverableId:'invoices',priority:'low',tags:[],completed:false,createdAt:'2026-02-06T12:00:09.000Z'},{id:'t11',text:'Clean up download and desktop folder',partnerId:'admin',projectId:'business',deliverableId:'invoices',priority:'low',tags:[],completed:false,createdAt:'2026-02-06T12:00:10.000Z'}]};

const defaultPersonalData={tags:[{id:'email',name:'Email',icon:'üìß'},{id:'call',name:'Call',icon:'üìû'},{id:'errand',name:'Errand',icon:'üèÉ'},{id:'home',name:'Home',icon:'üè†'},{id:'order',name:'Order/Return',icon:'üì¶'},{id:'admin',name:'Admin',icon:'üìÅ'},{id:'selfcare',name:'Self-care',icon:'üíÜ'}],tasks:[],projects:[],protocols:[{id:'adhd',name:'ADHD Support',icon:'üß†',active:false,description:'Activate when executive function is struggling.',tasks:[{text:'Take ADHD medication',icon:'üíä'},{text:'Drink water',icon:'üíß'},{text:'Eat a real meal',icon:'üç≥'},{text:'Set 25-min timer',icon:'‚è±Ô∏è'},{text:'5-min movement',icon:'üö∂'},{text:'Write top 3',icon:'üìù'}]},{id:'histamine',name:'Low-Histamine',icon:'ü©π',active:false,description:'During CSU flare-ups.',tasks:[{text:'Take antihistamine',icon:'üíä'},{text:'Avoid high-histamine',icon:'üö´'},{text:'Fresh meals only',icon:'ü•ó'},{text:'Log symptoms',icon:'üìì'},{text:'Gentle exercise',icon:'üßò'},{text:'Extra hydration',icon:'üíß'}]}]};

let workData,personalData,appSettings={apiKey:'',syncUrl:''};

// Toast notification system
function showToast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(type?' '+type:'')+' show';clearTimeout(t._timer);t._timer=setTimeout(()=>t.classList.remove('show'),2500);}

// Data layer
function loadData(){workData=JSON.parse(localStorage.getItem('mjPlanner_work_v5')||'null')||JSON.parse(JSON.stringify(defaultWorkData));personalData=JSON.parse(localStorage.getItem('mjPlanner_personal_v5')||'null')||JSON.parse(JSON.stringify(defaultPersonalData));appSettings=JSON.parse(localStorage.getItem('mjPlanner_settings')||'null')||{apiKey:'',syncUrl:''};if(!personalData.projects)personalData.projects=[];}
function saveWork(){localStorage.setItem('mjPlanner_work_v5',JSON.stringify(workData));}
function savePersonal(){localStorage.setItem('mjPlanner_personal_v5',JSON.stringify(personalData));}
function saveSettings(){localStorage.setItem('mjPlanner_settings',JSON.stringify(appSettings));}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2);}
function escapeHtml(t){const d=document.createElement('div');d.textContent=t||'';return d.innerHTML;}

// Mode switching
function setMode(m){currentMode=m;document.body.classList.toggle('personal-mode',m==='personal');document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));document.querySelector('.'+m+'-btn').classList.add('active');m==='work'?renderWork():renderPersonal();}

// Keyboard shortcuts
document.addEventListener('keydown',function(e){
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
  if(e.key==='Tab'){e.preventDefault();setMode(currentMode==='work'?'personal':'work');}
  if(e.key==='Escape'){closeSettings();closePersonalAddModal();closeProjectModal();closeProtocolModal();closeScanModal();}
});

// Smarter due date display
function formatDue(dateStr){
  if(!dateStr)return '';
  const d=new Date(dateStr+'T00:00:00'),today=new Date();today.setHours(0,0,0,0);
  const diff=Math.round((d-today)/(1000*60*60*24));
  if(diff<0)return{text:'Overdue ('+Math.abs(diff)+'d)',cls:'overdue'};
  if(diff===0)return{text:'Today',cls:'today'};
  if(diff===1)return{text:'Tomorrow',cls:'tomorrow'};
  if(diff<=7)return{text:d.toLocaleDateString('en',{weekday:'short'}),cls:''};
  return{text:d.toLocaleDateString('en',{month:'short',day:'numeric'}),cls:''};
}

// Clear completed tasks
function clearCompleted(){
  const mode=currentMode;
  let count=0;
  if(mode==='work'){count=workData.tasks.filter(t=>t.completed).length;workData.tasks=workData.tasks.filter(t=>!t.completed);saveWork();renderWork();}
  else{count=personalData.tasks.filter(t=>t.completed&&!t.protocolId).length;personalData.tasks=personalData.tasks.filter(t=>!t.completed||t.protocolId);savePersonal();renderPersonal();}
  if(count)showToast('Cleared '+count+' completed task'+(count!==1?'s':''));
}

function updateClearDoneBtn(){
  const tasks=currentMode==='work'?workData.tasks:personalData.tasks;
  const doneCount=tasks.filter(t=>t.completed).length;
  document.getElementById('clearDoneBtn').style.display=doneCount>0?'inline-block':'none';
}

// Work selects
function populateWorkSelects(){const ps=document.getElementById('workProjectSelect'),ts=document.getElementById('workTagSelect');ps.innerHTML='';workData.partners.forEach(p=>p.projects.forEach(pr=>pr.deliverables.forEach(d=>ps.innerHTML+='<option value="'+p.id+'|'+pr.id+'|'+d.id+'">'+p.name+' ‚Üí '+pr.name+' ‚Üí '+d.name+'</option>')));ts.innerHTML='<option value="">Tag</option>';workData.tags.forEach(t=>ts.innerHTML+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>');}

// Work tasks
function addWorkTask(){const input=document.getElementById('workTaskInput'),text=input.value.trim();if(!text)return;const[partnerId,projectId,deliverableId]=document.getElementById('workProjectSelect').value.split('|'),tag=document.getElementById('workTagSelect').value;workData.tasks.push({id:genId(),text,partnerId,projectId,deliverableId,priority:document.getElementById('workPrioritySelect').value,dueDate:document.getElementById('workDueDate').value||null,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()});saveWork();input.value='';document.getElementById('workDueDate').value='';document.getElementById('workTagSelect').value='';renderWork();showToast('Task added','success');}

function toggleWorkTask(id){const t=workData.tasks.find(x=>x.id===id);if(t){t.completed=!t.completed;t.completedAt=t.completed?new Date().toISOString():null;saveWork();renderWork();if(t.completed)showToast('‚úì Done!','success');}}
function deleteWorkTask(id){workData.tasks=workData.tasks.filter(x=>x.id!==id);saveWork();renderWork();}
function isOverdue(t){if(!t.dueDate||t.completed)return false;return new Date(t.dueDate+'T00:00:00')<new Date(new Date().toDateString());}

function getWorkSource(t){const p=workData.partners.find(x=>x.id===t.partnerId);const pr=p?.projects.find(x=>x.id===t.projectId);return p?(p.name+(pr?' ‚Üí '+pr.name:'')):'';}

function renderWorkTaskClean(t){const src=getWorkSource(t);const tags=(t.tags||[]).map(tid=>{const tag=workData.tags.find(x=>x.id===tid);return tag?'<span class="task-tag">'+tag.icon+' '+tag.name+'</span>':'';}).join('');const dueInfo=formatDue(t.dueDate);const due=dueInfo?'<span class="task-due'+(dueInfo.cls?' '+dueInfo.cls:'')+'">'+dueInfo.text+'</span>':'';return '<div class="work-task-item'+(t.completed?' completed':'')+'"><div class="work-task-checkbox'+(t.completed?' checked':'')+'" onclick="toggleWorkTask(\''+t.id+'\')"></div><div class="work-task-content"><div class="work-task-text">'+escapeHtml(t.text)+'</div><div class="work-task-meta">'+due+tags+(src?'<span class="task-source">'+src+'</span>':'')+'</div></div><button class="delete-task" onclick="deleteWorkTask(\''+t.id+'\')" title="Delete">√ó</button></div>';}

function renderWorkPriority(){const tasks=workData.tasks,high=tasks.filter(t=>t.priority==='high'&&!t.completed),med=tasks.filter(t=>t.priority==='medium'&&!t.completed),low=tasks.filter(t=>t.priority==='low'&&!t.completed),done=tasks.filter(t=>t.completed);
// Sort overdue to top within each group
const sortByDue=arr=>arr.sort((a,b)=>{if(isOverdue(a)&&!isOverdue(b))return -1;if(!isOverdue(a)&&isOverdue(b))return 1;if(a.dueDate&&b.dueDate)return new Date(a.dueDate)-new Date(b.dueDate);if(a.dueDate)return -1;if(b.dueDate)return 1;return 0;});
sortByDue(high);sortByDue(med);sortByDue(low);
document.getElementById('wHighCount').textContent='('+high.length+')';document.getElementById('wMediumCount').textContent='('+med.length+')';document.getElementById('wLowCount').textContent='('+low.length+')';document.getElementById('wDoneCount').textContent='('+done.length+')';document.getElementById('wHighTasks').innerHTML=high.length?high.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No urgent tasks üéâ</div>';document.getElementById('wMediumTasks').innerHTML=med.length?med.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No medium tasks</div>';document.getElementById('wLowTasks').innerHTML=low.length?low.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No low tasks</div>';document.getElementById('wDoneTasks').innerHTML=done.length?done.map(renderWorkTaskClean).join(''):'<div class="priority-empty">Nothing done yet</div>';}

function renderWorkTask(t){const tags=(t.tags||[]).map(tid=>{const tag=workData.tags.find(x=>x.id===tid);return tag?'<span class="task-tag">'+tag.icon+'</span>':'';}).join('');const dueInfo=formatDue(t.dueDate);const due=dueInfo?'<span class="task-due'+(dueInfo.cls?' '+dueInfo.cls:'')+'">'+dueInfo.text+'</span>':'';return '<div class="task-item'+(t.completed?' completed':'')+'"><div class="task-checkbox'+(t.completed?' checked':'')+'" onclick="toggleWorkTask(\''+t.id+'\')"></div><div class="task-content"><div class="task-text">'+escapeHtml(t.text)+'</div><div class="task-meta">'+due+tags+'</div></div><button class="delete-task" onclick="deleteWorkTask(\''+t.id+'\')" title="Delete">√ó</button></div>';}

function renderWorkProjects(){const c=document.getElementById('workProjectsView');c.innerHTML='';workData.partners.forEach(partner=>{const tasks=workData.tasks.filter(t=>t.partnerId===partner.id),inc=tasks.filter(t=>!t.completed);let html='';partner.projects.forEach(proj=>{let dels='';proj.deliverables.forEach(del=>{const dt=tasks.filter(t=>t.projectId===proj.id&&t.deliverableId===del.id);if(dt.length)dels+='<div class="deliverable-section has-tasks"><div class="deliverable-name">'+del.name+'</div><div class="tasks-list">'+dt.map(renderWorkTask).join('')+'</div></div>';});if(dels)html+='<div class="project-section"><div class="project-header">'+proj.name+'</div>'+dels+'</div>';});c.innerHTML+='<div class="partner-section '+partner.color+'"><div class="partner-header">'+partner.name+'<span class="task-count">'+inc.length+'</span></div>'+(html||'<div class="empty-state">No tasks</div>')+'</div>';});}

function updateWorkStats(){const inc=workData.tasks.filter(t=>!t.completed),overdueCount=inc.filter(isOverdue).length;document.getElementById('totalTasks').textContent=inc.length;document.getElementById('urgentTasks').textContent=inc.filter(t=>t.priority==='high').length;document.getElementById('overdueTasks').textContent=overdueCount;
// Highlight overdue card red when > 0
const card=document.getElementById('overdueCard');card.className='stat-card'+(overdueCount>0?' danger':'');
const today=new Date().toDateString();document.getElementById('completedToday').textContent=workData.tasks.filter(t=>t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today).length;updateClearDoneBtn();}

function setWorkView(v,btn){workView=v;document.querySelectorAll('.work-view .view-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.getElementById('workPriorityView').style.display=v==='priority'?'block':'none';document.getElementById('workProjectsView').style.display=v==='projects'?'grid':'none';renderWork();}
function toggleWorkDone(){const el=document.getElementById('wDoneTasks');el.classList.toggle('expanded');document.getElementById('wDoneToggle').classList.toggle('expanded');}
function renderWork(){workView==='priority'?renderWorkPriority():renderWorkProjects();updateWorkStats();}

// Personal
function populatePersonalSelects(){const ts=document.getElementById('personalTagSelect'),mt=document.getElementById('pModalTag');[ts,mt].forEach(s=>{if(!s)return;s.innerHTML='<option value="">No tag</option>';personalData.tags.forEach(t=>s.innerHTML+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>');});renderPersonalTagFilters();}
function renderPersonalTagFilters(){document.getElementById('personalTagFilters').innerHTML=personalData.tags.map(t=>'<button class="filter-btn'+(personalTagFilter===t.id?' active':'')+'" onclick="setPersonalTagFilter(\''+t.id+'\',this)">'+t.icon+' '+t.name+'</button>').join('');}
function setPersonalTagFilter(id,btn){personalTagFilter=id;document.querySelectorAll('#personalFiltersRow .filter-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');else document.querySelector('#personalFiltersRow .filter-btn').classList.add('active');renderPersonal();}
function clearTagFilter(){personalTagFilter='';document.querySelectorAll('#personalFiltersRow .filter-btn').forEach(b=>b.classList.remove('active'));document.querySelector('#personalFiltersRow .filter-btn').classList.add('active');renderPersonal();}
function addPersonalTask(){const input=document.getElementById('personalTaskInput'),text=input.value.trim();if(!text)return;const tag=document.getElementById('personalTagSelect').value,tagObj=personalData.tags.find(t=>t.id===tag);personalData.tasks.push({id:genId(),text,icon:tagObj?.icon||'üìå',priority:document.getElementById('personalPrioritySelect').value,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()});savePersonal();input.value='';document.getElementById('personalTagSelect').value='';renderPersonal();showToast('Task added','success');}

function togglePersonalTask(id){const t=personalData.tasks.find(x=>x.id===id);if(t){t.completed=!t.completed;t.completedAt=t.completed?new Date().toISOString():null;if(t.completed&&t.repeat==='habit'&&t.habitDay){t.habitDay++;if(t.habitDay>30){showToast('üéâ 30-day habit complete!','success');if(confirm('üéâ 30 days done! Reset and keep going?')){t.habitDay=1;}}}else if(t.completed){showToast('‚úì Done!','success');}savePersonal();renderPersonal();}}

function deletePersonalTask(id){personalData.tasks=personalData.tasks.filter(x=>x.id!==id);savePersonal();renderPersonal();}

function renderPersonalTask(t,showPriority){let meta='';if(t.repeat==='habit')meta='<span class="habit-badge">Day '+(t.habitDay||1)+'/30</span>';else if(t.repeat==='weekly')meta='<span class="repeat-badge">Every '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][t.repeatDay||0]+'</span>';else if(t.repeat==='daily')meta='<span class="repeat-badge">Daily</span>';if(t.protocolId){const proto=personalData.protocols.find(p=>p.id===t.protocolId);if(proto)meta+='<span class="protocol-source">'+proto.icon+' '+escapeHtml(proto.name)+'</span>';}const pb=showPriority?'<span class="priority-badge '+t.priority+'">'+t.priority+'</span>':'';return '<div class="personal-task-item'+(t.completed?' completed':'')+'"><div class="personal-task-checkbox'+(t.completed?' checked':'')+'" onclick="togglePersonalTask(\''+t.id+'\')"></div><div class="personal-task-icon">'+(t.icon||'üìå')+'</div><div class="personal-task-content"><div class="personal-task-text">'+escapeHtml(t.text)+'</div><div class="personal-task-meta">'+pb+meta+'</div></div><button class="delete-task" onclick="deletePersonalTask(\''+t.id+'\')" title="Delete">√ó</button></div>';}

function getActiveTasks(){const today=new Date().getDay();let changed=false;personalData.protocols.forEach(p=>{if(p.active)p.tasks.forEach(pt=>{if(!personalData.tasks.find(t=>t.protocolId===p.id&&t.text===pt.text)){personalData.tasks.push({id:genId(),text:pt.text,icon:pt.icon,priority:'high',protocolId:p.id,completed:false,createdAt:new Date().toISOString()});changed=true;}});});if(changed)savePersonal();return personalData.tasks.filter(t=>!(t.repeat==='weekly'&&t.repeatDay!==today));}

function filterByTag(tasks){return personalTagFilter?tasks.filter(t=>(t.tags||[]).includes(personalTagFilter)):tasks;}
function renderFilteredView(){const tasks=filterByTag(getActiveTasks()),inc=tasks.filter(t=>!t.completed),tag=personalData.tags.find(t=>t.id===personalTagFilter);document.getElementById('filterTagIcon').textContent=tag?.icon||'';document.getElementById('filterTagName').textContent=(tag?.name||'')+' Tasks';document.getElementById('filterTagCount').textContent=inc.length+' task'+(inc.length!==1?'s':'');const sorted=[...inc.filter(t=>t.priority==='high'),...inc.filter(t=>t.priority==='medium'),...inc.filter(t=>t.priority==='low')];document.getElementById('filteredTasksList').innerHTML=sorted.length?sorted.map(t=>renderPersonalTask(t,true)).join(''):'<div class="empty-state">No tasks with this tag</div>';}
function renderPersonalTodo(){const tasks=filterByTag(getActiveTasks()),high=tasks.filter(t=>t.priority==='high'&&!t.completed),med=tasks.filter(t=>t.priority==='medium'&&!t.completed),low=tasks.filter(t=>t.priority==='low'&&!t.completed),done=tasks.filter(t=>t.completed);document.getElementById('highCount').textContent='('+high.length+')';document.getElementById('mediumCount').textContent='('+med.length+')';document.getElementById('lowCount').textContent='('+low.length+')';document.getElementById('doneCount').textContent='('+done.length+')';document.getElementById('highTasks').innerHTML=high.length?high.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">No high priority</div>';document.getElementById('mediumTasks').innerHTML=med.length?med.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">No medium priority</div>';document.getElementById('lowTasks').innerHTML=low.length?low.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">No low priority</div>';document.getElementById('doneTasks').innerHTML=done.length?done.map(t=>renderPersonalTask(t)).join(''):'<div class="priority-empty">Nothing done yet</div>';}
function updatePersonalStats(){const tasks=getActiveTasks(),inc=tasks.filter(t=>!t.completed);document.getElementById('pTotalTasks').textContent=inc.length;document.getElementById('pHighTasks').textContent=inc.filter(t=>t.priority==='high').length;document.getElementById('pHabits').textContent=personalData.tasks.filter(t=>t.repeat==='habit').length;const today=new Date().toDateString();document.getElementById('pCompletedToday').textContent=tasks.filter(t=>t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today).length;updateClearDoneBtn();}
function setPersonalView(v,btn){personalView=v;document.querySelectorAll('.personal-view .view-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.getElementById('personalTodoView').style.display=v==='todo'&&!personalTagFilter?'block':'none';document.getElementById('personalProjectsView').style.display=v==='projects'?'block':'none';document.getElementById('personalProtocolsView').style.display=v==='protocols'?'block':'none';document.getElementById('personalFiltersRow').style.display=v==='todo'?'flex':'none';document.getElementById('tagFilterBanner').style.display='none';document.getElementById('filteredTasksView').style.display='none';if(v!=='todo')personalTagFilter='';renderPersonal();}
function renderPersonal(){const filtered=personalTagFilter&&personalView==='todo';document.getElementById('tagFilterBanner').style.display=filtered?'flex':'none';document.getElementById('filteredTasksView').style.display=filtered?'block':'none';document.getElementById('personalTodoView').style.display=personalView==='todo'&&!filtered?'block':'none';if(personalView==='todo'){filtered?renderFilteredView():renderPersonalTodo();}else if(personalView==='projects')renderProjects();else if(personalView==='protocols')renderProtocols();updatePersonalStats();}
function toggleDone(){const el=document.getElementById('doneTasks');el.classList.toggle('expanded');document.getElementById('pDoneToggle').classList.toggle('expanded');}

// Projects
function renderProjects(){const g=document.getElementById('projectsGrid');if(!personalData.projects?.length){g.innerHTML='<div class="empty-state" style="grid-column:1/-1">No projects yet ‚Äî create one to track bigger goals</div>';return;}g.innerHTML=personalData.projects.map(p=>{const subs=p.subtasks||[],done=subs.filter(s=>s.completed).length,pct=subs.length?Math.round(done/subs.length*100):0;return '<div class="project-card" onclick="openProjectModal(\''+p.id+'\')"><div class="project-card-header"><div class="project-card-title">'+(p.icon||'üéØ')+' '+escapeHtml(p.name)+'</div><span class="project-status '+p.status+'">'+p.status+'</span></div><div class="project-card-meta">'+done+'/'+subs.length+' subtasks</div><div class="project-progress"><div class="project-progress-bar" style="width:'+pct+'%"></div></div></div>';}).join('');}
function openProjectModal(id){tempSubtasks=[];if(id){const p=personalData.projects.find(x=>x.id===id);if(p){document.getElementById('projectModalTitle').textContent='Edit Project';document.getElementById('projectName').value=p.name;document.getElementById('projectIcon').value=p.icon||'';document.getElementById('projectStatus').value=p.status;document.getElementById('editingProjectId').value=id;tempSubtasks=[...(p.subtasks||[])];}else return;}else{document.getElementById('projectModalTitle').textContent='New Project';document.getElementById('projectName').value='';document.getElementById('projectIcon').value='';document.getElementById('projectStatus').value='someday';document.getElementById('editingProjectId').value='';}renderTempSubtasks();document.getElementById('projectModal').classList.add('active');}
function closeProjectModal(){document.getElementById('projectModal').classList.remove('active');}
function renderTempSubtasks(){document.getElementById('projectSubtasks').innerHTML=tempSubtasks.map((s,i)=>'<div class="subtask-item"><input type="checkbox" '+(s.completed?'checked':'')+' onchange="toggleTempSubtask('+i+')"><span style="flex:1;'+(s.completed?'text-decoration:line-through;color:var(--gray)':'')+'">'+escapeHtml(s.text)+'</span><button onclick="removeTempSubtask('+i+')">√ó</button></div>').join('');}
function addProjectSubtask(){const i=document.getElementById('newSubtask'),t=i.value.trim();if(!t)return;tempSubtasks.push({text:t,completed:false});i.value='';renderTempSubtasks();}
function toggleTempSubtask(i){tempSubtasks[i].completed=!tempSubtasks[i].completed;renderTempSubtasks();}
function removeTempSubtask(i){tempSubtasks.splice(i,1);renderTempSubtasks();}
function saveProject(){const name=document.getElementById('projectName').value.trim();if(!name)return alert('Enter a project name');const id=document.getElementById('editingProjectId').value,data={name,icon:document.getElementById('projectIcon').value.trim()||'üéØ',status:document.getElementById('projectStatus').value,subtasks:tempSubtasks};if(id){const idx=personalData.projects.findIndex(p=>p.id===id);if(idx>=0)personalData.projects[idx]={...personalData.projects[idx],...data};}else personalData.projects.push({id:genId(),...data});savePersonal();closeProjectModal();renderProjects();showToast('Project saved','success');}
function deleteProject(id){if(!confirm('Delete this project?'))return;personalData.projects=personalData.projects.filter(p=>p.id!==id);savePersonal();renderProjects();}

// Protocols
function renderProtocols(){document.getElementById('protocolsGrid').innerHTML=personalData.protocols.map(p=>'<div class="protocol-card'+(p.active?' active':'')+'">'+(p.active?'<div class="protocol-active-badge">Active</div>':'')+'<div class="protocol-card-icon">'+p.icon+'</div><div class="protocol-card-title">'+escapeHtml(p.name)+'</div><div class="protocol-card-desc">'+escapeHtml(p.description||'')+'</div><div class="protocol-tasks-preview">'+p.tasks.length+' tasks</div><div style="display:flex;gap:8px"><button class="protocol-activate-btn" style="flex:1" onclick="toggleProtocol(\''+p.id+'\')">'+(p.active?'Deactivate':'Activate')+'</button><button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();openProtocolModal(\''+p.id+'\')">Edit</button></div></div>').join('');}
function toggleProtocol(id){const p=personalData.protocols.find(x=>x.id===id);if(p){p.active=!p.active;if(!p.active){personalData.tasks=personalData.tasks.filter(t=>t.protocolId!==id);showToast(p.icon+' '+p.name+' deactivated');}else{showToast(p.icon+' '+p.name+' activated ‚Äî tasks added','success');}savePersonal();renderProtocols();renderPersonal();}}
function openProtocolModal(id){tempProtocolTasks=[];if(id){const p=personalData.protocols.find(x=>x.id===id);if(p){document.getElementById('protocolModalTitle').textContent='Edit Protocol';document.getElementById('protocolName').value=p.name;document.getElementById('protocolIcon').value=p.icon||'';document.getElementById('protocolDesc').value=p.description||'';document.getElementById('editingProtocolId').value=id;tempProtocolTasks=[...p.tasks];}else return;}else{document.getElementById('protocolModalTitle').textContent='New Protocol';document.getElementById('protocolName').value='';document.getElementById('protocolIcon').value='';document.getElementById('protocolDesc').value='';document.getElementById('editingProtocolId').value='';}renderTempProtocolTasks();document.getElementById('protocolModal').classList.add('active');}
function closeProtocolModal(){document.getElementById('protocolModal').classList.remove('active');}
function renderTempProtocolTasks(){document.getElementById('protocolTasks').innerHTML=tempProtocolTasks.map((t,i)=>'<div class="subtask-item"><span style="margin-right:8px">'+t.icon+'</span><span style="flex:1">'+escapeHtml(t.text)+'</span><button onclick="removeTempProtocolTask('+i+')">√ó</button></div>').join('');}
function addProtocolTask(){const t=document.getElementById('newProtocolTask').value.trim(),ic=document.getElementById('newProtocolTaskIcon').value.trim()||'üìå';if(!t)return;tempProtocolTasks.push({text:t,icon:ic});document.getElementById('newProtocolTask').value='';document.getElementById('newProtocolTaskIcon').value='';renderTempProtocolTasks();}
function removeTempProtocolTask(i){tempProtocolTasks.splice(i,1);renderTempProtocolTasks();}
function saveProtocol(){const name=document.getElementById('protocolName').value.trim();if(!name)return alert('Enter a protocol name');if(!tempProtocolTasks.length)return alert('Add at least one task');const id=document.getElementById('editingProtocolId').value,data={name,icon:document.getElementById('protocolIcon').value.trim()||'üìã',description:document.getElementById('protocolDesc').value.trim(),tasks:tempProtocolTasks,active:false};if(id){const idx=personalData.protocols.findIndex(p=>p.id===id);if(idx>=0){data.active=personalData.protocols[idx].active;personalData.protocols[idx]={...personalData.protocols[idx],...data};}}else personalData.protocols.push({id:genId(),...data});savePersonal();closeProtocolModal();renderProtocols();showToast('Protocol saved','success');}
function openPersonalAddModal(p){document.getElementById('pModalPriority').value=p;document.getElementById('pModalTask').value='';document.getElementById('pModalIcon').value='';document.getElementById('pModalRepeat').value='';document.getElementById('repeatOptions').style.display='none';populatePersonalSelects();document.getElementById('personalAddModal').classList.add('active');setTimeout(()=>document.getElementById('pModalTask').focus(),100);}
function closePersonalAddModal(){document.getElementById('personalAddModal').classList.remove('active');}
function toggleRepeatOptions(){document.getElementById('repeatOptions').style.display=document.getElementById('pModalRepeat').value==='weekly'?'block':'none';}
function savePersonalModalTask(){const text=document.getElementById('pModalTask').value.trim();if(!text)return;const icon=document.getElementById('pModalIcon').value.trim()||'üìå',priority=document.getElementById('pModalPriority').value,tag=document.getElementById('pModalTag').value,repeat=document.getElementById('pModalRepeat').value,task={id:genId(),text,icon,priority,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()};if(repeat){task.repeat=repeat;if(repeat==='weekly')task.repeatDay=parseInt(document.getElementById('pModalDay').value);if(repeat==='habit')task.habitDay=1;}personalData.tasks.push(task);savePersonal();closePersonalAddModal();renderPersonal();showToast('Task added','success');}

// Settings
function openSettings(){renderSettingsTabs();document.getElementById('settingsModal').classList.add('active');}
function closeSettings(){document.getElementById('settingsModal').classList.remove('active');}
function renderSettingsTabs(){const tabs=['<button class="modal-tab active" onclick="renderSettingsTab(\'api\',this)">AI Scan</button>','<button class="modal-tab" onclick="renderSettingsTab(\'sync\',this)">Google Tasks</button>','<button class="modal-tab" onclick="renderSettingsTab(\'tags\',this)">Tags</button>','<button class="modal-tab" onclick="renderSettingsTab(\'workprojects\',this)">Work Projects</button>'];if(currentMode==='personal'){tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\'projects\',this)">Personal Projects</button>');tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\'protocols\',this)">Protocols</button>');}tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\'data\',this)">Data</button>');document.getElementById('settingsTabs').innerHTML=tabs.join('');renderSettingsTab('api');}
function renderSettingsTab(tab,btn){if(btn){document.querySelectorAll('.modal-tab').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');}var c=document.getElementById('settingsContent');if(tab==='api'){var hasKey=appSettings.apiKey&&appSettings.apiKey.length>10;c.innerHTML='<div class="modal-section"><h3>Anthropic API Key</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Required for scanning handwritten notes with AI.</p><div class="api-key-input"><input type="password" id="apiKeyInput" placeholder="sk-ant-..." value="'+(appSettings.apiKey||'')+'"><button class="btn btn-primary btn-sm" onclick="saveApiKey()">Save</button></div><div class="api-status '+(hasKey?'connected':'disconnected')+'">'+(hasKey?'‚úì Key saved':'‚ö† No key ‚Äî scanning disabled')+'</div><p style="font-size:0.8rem;color:var(--gray);margin-top:12px">Get your key: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--work-orange)">console.anthropic.com</a></p></div>';}else if(tab==='sync'){var hasUrl=appSettings.syncUrl&&appSettings.syncUrl.length>10;c.innerHTML='<div class="modal-section"><h3>Google Tasks Sync</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Connect your Google Tasks to auto-import email tasks. Requires a Google Apps Script deployment.</p><div class="api-key-input"><input type="url" id="syncUrlInput" placeholder="https://script.google.com/macros/s/..." value="'+(appSettings.syncUrl||'')+'"><button class="btn btn-primary btn-sm" onclick="saveSyncUrl()">Save</button></div><div class="api-status '+(hasUrl?'connected':'disconnected')+'">'+(hasUrl?'‚úì Sync URL saved':'‚ö† No sync URL ‚Äî sync disabled')+'</div><p style="font-size:0.8rem;color:var(--gray);margin-top:12px">Setup: Create a Google Apps Script with the provided code, deploy as Web App, and paste the URL here.</p></div>';}else if(tab==='tags'){var tags=currentMode==='work'?workData.tags:personalData.tags;c.innerHTML='<div class="modal-section"><h3>'+(currentMode==='work'?'Work':'Personal')+' Tags</h3>'+tags.map(function(t){return'<div class="settings-item"><div class="settings-item-info"><span style="font-size:1.2rem;margin-right:8px">'+t.icon+'</span>'+escapeHtml(t.name)+'</div><div class="settings-item-actions"><button class="delete" onclick="deleteTag(\''+t.id+'\')">√ó</button></div></div>';}).join('')+'<div class="add-inline"><input type="text" id="newTagIcon" placeholder="üìå" style="width:60px"><input type="text" id="newTagName" placeholder="Tag name" onkeypress="if(event.key===\'Enter\')addTag()"><button class="btn btn-primary btn-sm" onclick="addTag()">Add</button></div></div>';}else if(tab==='workprojects'){var html='<div class="modal-section"><h3>Partners & Projects</h3>';workData.partners.forEach(function(partner){html+='<div style="margin-bottom:16px;padding:12px;background:var(--gray-light);border-radius:10px"><div style="font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">'+escapeHtml(partner.name)+'<button class="delete" onclick="deletePartner(\''+partner.id+'\')">√ó</button></div>';partner.projects.forEach(function(proj){html+='<div style="margin-left:12px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center"><span>‚Ü≥ '+escapeHtml(proj.name)+'</span><button class="delete" onclick="deleteWorkProject(\''+partner.id+'\',\''+proj.id+'\')">√ó</button></div>';proj.deliverables.forEach(function(del){html+='<div style="margin-left:28px;font-size:0.85rem;color:var(--gray);display:flex;justify-content:space-between;align-items:center"><span>‚Ä¢ '+escapeHtml(del.name)+'</span><button class="delete" onclick="deleteDeliverable(\''+partner.id+'\',\''+proj.id+'\',\''+del.id+'\')">√ó</button></div>';});});html+='<div class="add-inline" style="margin-top:8px;margin-left:12px"><input type="text" id="newProj_'+partner.id+'" placeholder="New project name" onkeypress="if(event.key===\'Enter\')addWorkProject(\''+partner.id+'\')"><button class="btn btn-primary btn-sm" onclick="addWorkProject(\''+partner.id+'\')">+ Project</button></div></div>';});html+='<div class="add-inline" style="margin-top:12px"><input type="text" id="newPartnerName" placeholder="New partner name" onkeypress="if(event.key===\'Enter\')addPartner()"><button class="btn btn-primary btn-sm" onclick="addPartner()">+ Partner</button></div></div>';c.innerHTML=html;}else if(tab==='projects'){c.innerHTML='<div class="modal-section"><h3>Personal Projects</h3>'+(personalData.projects.length?personalData.projects.map(function(p){return'<div class="settings-item"><div class="settings-item-info"><div class="settings-item-title">'+(p.icon||'üéØ')+' '+escapeHtml(p.name)+'</div></div><div class="settings-item-actions"><button onclick="closeSettings();openProjectModal(\''+p.id+'\')">‚úé</button><button class="delete" onclick="deleteProject(\''+p.id+'\')">√ó</button></div></div>';}).join(''):'<p style="color:var(--gray)">No projects yet</p>')+'<button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="closeSettings();openProjectModal()">+ New Project</button></div>';}else if(tab==='protocols'){c.innerHTML='<div class="modal-section"><h3>Protocols</h3>'+personalData.protocols.map(function(p){return'<div class="settings-item"><div class="settings-item-info"><div class="settings-item-title">'+p.icon+' '+escapeHtml(p.name)+(p.active?' <span style="color:var(--personal-green);font-size:0.75rem">‚óè Active</span>':'')+'</div></div><div class="settings-item-actions"><button onclick="closeSettings();openProtocolModal(\''+p.id+'\')">‚úé</button><button class="delete" onclick="deleteProtocol(\''+p.id+'\')">√ó</button></div></div>';}).join('')+'<button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="closeSettings();openProtocolModal()">+ New Protocol</button></div>';}else if(tab==='data'){c.innerHTML='<div class="modal-section"><h3>Export / Reset</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:16px">Your data is stored in your browser\'s localStorage.</p><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-secondary btn-sm" onclick="exportData()">üì• Export JSON</button><button class="btn btn-secondary btn-sm" onclick="document.getElementById(\'importInput\').click()">üì§ Import JSON</button><input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)"></div><div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)"><button class="btn-danger" onclick="resetAllData()">‚ö† Reset All Data</button><p style="font-size:0.8rem;color:var(--gray);margin-top:8px">This permanently deletes all tasks, projects, and settings.</p></div></div>';}}

function saveApiKey(){appSettings.apiKey=document.getElementById('apiKeyInput').value.trim();saveSettings();renderSettingsTab('api');showToast('API key saved','success');}
function addTag(){var ic=document.getElementById('newTagIcon').value.trim()||'üè∑Ô∏è',nm=document.getElementById('newTagName').value.trim();if(!nm)return;if(currentMode==='work'){workData.tags.push({id:genId(),name:nm,icon:ic});saveWork();populateWorkSelects();}else{personalData.tags.push({id:genId(),name:nm,icon:ic});savePersonal();populatePersonalSelects();}renderSettingsTab('tags');showToast('Tag added');}
function deleteTag(id){if(currentMode==='work'){workData.tags=workData.tags.filter(function(t){return t.id!==id;});saveWork();populateWorkSelects();}else{personalData.tags=personalData.tags.filter(function(t){return t.id!==id;});savePersonal();populatePersonalSelects();}renderSettingsTab('tags');}
function addPartner(){var nm=document.getElementById('newPartnerName').value.trim();if(!nm)return;workData.partners.push({id:genId(),name:nm,color:'admin',projects:[]});saveWork();populateWorkSelects();renderSettingsTab('workprojects');showToast('Partner added');}
function deletePartner(id){if(!confirm('Delete this partner and all its projects?'))return;workData.partners=workData.partners.filter(function(p){return p.id!==id;});workData.tasks=workData.tasks.filter(function(t){return t.partnerId!==id;});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}
function addWorkProject(partnerId){var input=document.getElementById('newProj_'+partnerId);var nm=input.value.trim();if(!nm)return;var partner=workData.partners.find(function(p){return p.id===partnerId;});if(partner){partner.projects.push({id:genId(),name:nm,deliverables:[{id:genId(),name:'General'}]});saveWork();populateWorkSelects();renderSettingsTab('workprojects');showToast('Project added');}}
function deleteWorkProject(partnerId,projId){var partner=workData.partners.find(function(p){return p.id===partnerId;});if(partner){partner.projects=partner.projects.filter(function(p){return p.id!==projId;});workData.tasks=workData.tasks.filter(function(t){return!(t.partnerId===partnerId&&t.projectId===projId);});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}}
function deleteDeliverable(partnerId,projId,delId){var partner=workData.partners.find(function(p){return p.id===partnerId;});if(partner){var proj=partner.projects.find(function(p){return p.id===projId;});if(proj&&proj.deliverables.length>1){proj.deliverables=proj.deliverables.filter(function(d){return d.id!==delId;});saveWork();populateWorkSelects();renderSettingsTab('workprojects');}else{alert('Cannot delete the last deliverable');}}}
function deleteProtocol(id){if(!confirm('Delete this protocol?'))return;personalData.protocols=personalData.protocols.filter(function(p){return p.id!==id;});personalData.tasks=personalData.tasks.filter(function(t){return t.protocolId!==id;});savePersonal();renderSettingsTab('protocols');}

// Data management
function exportData(){const data={version:1,exportedAt:new Date().toISOString(),work:workData,personal:personalData,settings:appSettings};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='mj-planner-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url);showToast('Data exported','success');}
function importData(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(ev){try{const data=JSON.parse(ev.target.result);if(data.work)workData=data.work;if(data.personal)personalData=data.personal;if(data.settings)appSettings=data.settings;saveWork();savePersonal();saveSettings();populateWorkSelects();populatePersonalSelects();currentMode==='work'?renderWork():renderPersonal();showToast('Data imported successfully','success');}catch(err){showToast('Invalid file format','error');}};reader.readAsText(file);e.target.value='';}
function resetAllData(){if(!confirm('This will permanently delete ALL your data. Are you sure?'))return;if(!confirm('Really? This cannot be undone.'))return;localStorage.removeItem('mjPlanner_work_v5');localStorage.removeItem('mjPlanner_personal_v5');localStorage.removeItem('mjPlanner_settings');loadData();populateWorkSelects();populatePersonalSelects();currentMode==='work'?renderWork():renderPersonal();closeSettings();showToast('All data reset');}

// Scan Modal
function openScanModal(){if(!appSettings.apiKey){alert('Add your API key in Settings first.');openSettings();return;}resetScanModal();document.getElementById('scanModal').classList.add('active');}
function closeScanModal(){document.getElementById('scanModal').classList.remove('active');resetScanModal();}
function resetScanModal(){document.getElementById('scanUploadView').style.display='block';document.getElementById('scanReviewView').style.display='none';document.getElementById('fileInput').value='';suggestedTasks=[];}
document.addEventListener('DOMContentLoaded',function(){var dz=document.getElementById('dropZone');if(dz){dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('dragover');});dz.addEventListener('dragleave',function(){dz.classList.remove('dragover');});dz.addEventListener('drop',function(e){e.preventDefault();dz.classList.remove('dragover');var f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))processImage(f);});}});
function handleFileSelect(e){var f=e.target.files[0];if(f)processImage(f);}
async function processImage(file){var reader=new FileReader();reader.onload=async function(e){var base64=e.target.result.split(',')[1];document.getElementById('scanPreviewImg').src=e.target.result;document.getElementById('scanUploadView').style.display='none';document.getElementById('scanReviewView').style.display='block';document.getElementById('scanStatusBox').className='scan-status loading';document.getElementById('scanStatusBox').innerHTML='üîÑ Analyzing your notes...';document.getElementById('suggestedTasksList').innerHTML='';document.getElementById('addSelectedBtn').disabled=true;try{var tasks=await analyzeImage(base64,file.type);suggestedTasks=tasks.map(function(t,i){return{id:i,text:t.text,priority:t.priority||'medium',tag:'',selected:true};});renderSuggestedTasks();document.getElementById('scanStatusBox').className='scan-status';document.getElementById('scanStatusBox').innerHTML='‚úì Found '+suggestedTasks.length+' task'+(suggestedTasks.length!==1?'s':'');}catch(err){document.getElementById('scanStatusBox').className='scan-status error';document.getElementById('scanStatusBox').innerHTML='‚ùå '+err.message;}};reader.readAsDataURL(file);}
async function analyzeImage(base64,mediaType){var r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':appSettings.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:mediaType,data:base64}},{type:'text',text:'Extract tasks from this handwritten note/list. For each, determine priority (high if starred/underlined/circled, medium default, low if marked later/someday). Respond ONLY with JSON array: [{"text":"task","priority":"high|medium|low"}]. Empty array [] if none found.'}]}]})});if(!r.ok){var e=await r.json();throw new Error(e.error?.message||'API request failed');}var d=await r.json();var m=d.content[0].text.match(/\[[\s\S]*\]/);if(!m)return[];try{return JSON.parse(m[0]);}catch(x){return[];}}
function renderSuggestedTasks(){var tags=currentMode==='work'?workData.tags:personalData.tags;var opts='<option value="">No tag</option>'+tags.map(function(t){return'<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>';}).join('');document.getElementById('suggestedTasksList').innerHTML=suggestedTasks.map(function(t){return'<div class="suggested-task"><input type="checkbox" '+(t.selected?'checked':'')+' onchange="toggleSuggestedTask('+t.id+')"><div class="suggested-task-content"><input type="text" class="suggested-task-text" value="'+escapeHtml(t.text)+'" onchange="updateSuggestedText('+t.id+',this.value)"><div class="suggested-task-options"><select onchange="updateSuggestedPriority('+t.id+',this.value)"><option value="high"'+(t.priority==='high'?' selected':'')+'>üî¥ High</option><option value="medium"'+(t.priority==='medium'?' selected':'')+'>üü† Medium</option><option value="low"'+(t.priority==='low'?' selected':'')+'>üü£ Low</option></select><select onchange="updateSuggestedTag('+t.id+',this.value)">'+opts+'</select></div></div><button class="remove-btn" onclick="removeSuggestedTask('+t.id+')">√ó</button></div>';}).join('');updateAddBtn();}
function toggleSuggestedTask(id){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.selected=!t.selected;updateAddBtn();}
function updateSuggestedText(id,v){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.text=v;}
function updateSuggestedPriority(id,v){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.priority=v;}
function updateSuggestedTag(id,v){var t=suggestedTasks.find(function(x){return x.id===id;});if(t)t.tag=v;}
function removeSuggestedTask(id){suggestedTasks=suggestedTasks.filter(function(t){return t.id!==id;});renderSuggestedTasks();}
function updateAddBtn(){const c=suggestedTasks.filter(t=>t.selected).length;document.getElementById('addSelectedBtn').disabled=c===0;document.getElementById('addSelectedBtn').textContent='Add '+c+' Task'+(c!==1?'s':'');}
function addSelectedTasks(){const toAdd=suggestedTasks.filter(t=>t.selected&&t.text.trim());if(currentMode==='work'){const[partnerId,projectId,deliverableId]=document.getElementById('workProjectSelect').value.split('|');toAdd.forEach(t=>{workData.tasks.push({id:genId(),text:t.text.trim(),partnerId,projectId,deliverableId,priority:t.priority,tags:t.tag?[t.tag]:[],completed:false,createdAt:new Date().toISOString()});});saveWork();renderWork();}else{toAdd.forEach(t=>{const tagObj=personalData.tags.find(x=>x.id===t.tag);personalData.tasks.push({id:genId(),text:t.text.trim(),icon:tagObj?.icon||'üìå',priority:t.priority,tags:t.tag?[t.tag]:[],completed:false,createdAt:new Date().toISOString()});});savePersonal();renderPersonal();}closeScanModal();showToast('Added '+toAdd.length+' task'+(toAdd.length!==1?'s':'')+'!','success');}

// Google Tasks Sync
let syncTasks=[];
function saveSyncUrl(){appSettings.syncUrl=document.getElementById('syncUrlInput').value.trim();saveSettings();renderSettingsTab('sync');if(appSettings.syncUrl)showToast('Sync URL saved','success');}

async function syncGoogleTasks(){
  if(!appSettings.syncUrl){showToast('Add sync URL in Settings first');openSettings();return;}
  const btn=document.getElementById('syncBtn');
  btn.classList.add('syncing');
  try{
    const r=await fetch(appSettings.syncUrl);
    if(!r.ok)throw new Error('Fetch failed ('+r.status+')');
    const data=await r.json();
    if(data.error)throw new Error(data.error);
    // Filter out tasks already imported (tracked by Google Task ID)
    const imported=JSON.parse(localStorage.getItem('mjPlanner_imported_gtasks')||'[]');
    syncTasks=(data.tasks||[]).filter(t=>!imported.includes(t.id)).map(t=>({...t,selected:true,priority:'medium',assignTo:''}));
    btn.classList.remove('syncing');
    if(syncTasks.length===0){showToast('No new tasks to import');updateSyncBadge(0);return;}
    updateSyncBadge(syncTasks.length);
    openSyncModal();
  }catch(err){btn.classList.remove('syncing');showToast('Sync failed: '+err.message,'error');}
}

function updateSyncBadge(count){const b=document.getElementById('syncBadge');if(count>0){b.textContent=count;b.style.display='inline';}else{b.style.display='none';}}

function openSyncModal(){
  const c=document.getElementById('syncContent'),a=document.getElementById('syncActions');
  if(!syncTasks.length){c.innerHTML='<div class="sync-empty"><div class="sync-empty-icon">üì≠</div><div class="sync-empty-text">No new tasks from Google</div><div class="sync-empty-sub">Tasks you add via Gmail will appear here</div></div>';a.style.display='none';document.getElementById('syncModal').classList.add('active');return;}
  // Build project options
  let opts='<option value="">‚Äî Assign to project ‚Äî</option>';
  workData.partners.forEach(p=>p.projects.forEach(pr=>pr.deliverables.forEach(d=>{opts+='<option value="'+p.id+'|'+pr.id+'|'+d.id+'">'+p.name+' ‚Üí '+pr.name+' ‚Üí '+d.name+'</option>';})));
  c.innerHTML=syncTasks.map((t,i)=>'<div class="sync-task-item"><input type="checkbox" '+(t.selected?'checked':'')+' onchange="toggleSyncTask('+i+')"><div class="sync-task-content"><div class="sync-task-title">'+escapeHtml(t.title)+'</div>'+(t.notes?'<div class="sync-task-notes">'+escapeHtml(t.notes)+'</div>':'')+'<div class="sync-task-options"><select onchange="updateSyncProject('+i+',this.value)">'+opts+'</select><select onchange="updateSyncPriority('+i+',this.value)"><option value="high">üî¥ Urgent</option><option value="medium" selected>üü† Medium</option><option value="low">üü£ Low</option></select></div></div></div>').join('');
  a.style.display='flex';
  updateImportBtn();
  document.getElementById('syncModal').classList.add('active');
}

function closeSyncModal(){document.getElementById('syncModal').classList.remove('active');}
function toggleSyncTask(i){syncTasks[i].selected=!syncTasks[i].selected;updateImportBtn();}
function updateSyncPriority(i,v){syncTasks[i].priority=v;}
function updateSyncProject(i,v){syncTasks[i].assignTo=v;}
function updateImportBtn(){const c=syncTasks.filter(t=>t.selected).length;const btn=document.getElementById('importSyncBtn');btn.disabled=c===0;btn.textContent='Import '+c+' Task'+(c!==1?'s':'');}

async function importSyncedTasks(){
  const toImport=syncTasks.filter(t=>t.selected&&t.title.trim());
  if(!toImport.length)return;
  // Add tasks to work data
  toImport.forEach(t=>{
    let partnerId='admin',projectId='business',deliverableId='invoices';
    if(t.assignTo){const parts=t.assignTo.split('|');partnerId=parts[0];projectId=parts[1];deliverableId=parts[2];}
    workData.tasks.push({id:genId(),text:t.title.trim(),partnerId,projectId,deliverableId,priority:t.priority,tags:[],completed:false,createdAt:new Date().toISOString(),googleTaskId:t.id});
  });
  saveWork();
  // Track imported task IDs to prevent duplicates
  const imported=JSON.parse(localStorage.getItem('mjPlanner_imported_gtasks')||'[]');
  toImport.forEach(t=>imported.push(t.id));
  localStorage.setItem('mjPlanner_imported_gtasks',JSON.stringify(imported));
  // Mark as completed in Google Tasks
  try{
    const listId=toImport[0].listId;
    await fetch(appSettings.syncUrl,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({listId:listId,taskIds:toImport.map(t=>t.id)})});
  }catch(err){console.warn('Could not mark tasks as completed in Google:',err);}
  closeSyncModal();
  updateSyncBadge(0);
  renderWork();
  showToast('Imported '+toImport.length+' task'+(toImport.length!==1?'s':'')+'!','success');
}

// Auto-sync on load if URL is configured
function autoSync(){if(appSettings.syncUrl&&currentMode==='work'){syncGoogleTasks();}}
setTimeout(autoSync,1500);

// Init
loadData();populateWorkSelects();populatePersonalSelects();renderWork();
</script>
</body>
</html>
