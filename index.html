<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MJ's Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--work-orange:#E86F2A;--work-orange-dark:#D4853A;--work-yellow-cream:#F5E6C8;--work-pink:#F8C8D4;--work-pink-light:#FDF2F5;--personal-bg:#F5F5F3;--personal-red:#E57373;--personal-orange:#FFB74D;--personal-purple:#9575CD;--personal-purple-dark:#7E57C2;--personal-blue:#64B5F6;--personal-green:#81C784;--white:#FFFFFF;--dark:#2D2D2D;--gray:#6B6B6B;--gray-light:#F7F7F7;--border:#E8E8E8;--danger:#EF5350;--success:#66BB6A}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--white);min-height:100vh;color:var(--dark);line-height:1.6;transition:background 0.3s ease}
body.personal-mode{background:var(--personal-bg)}
.container{max-width:1200px;margin:0 auto;padding:32px 24px}
header{margin-bottom:32px}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.header-left{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
h1{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:600}
.mode-toggle{display:flex;background:var(--white);border-radius:25px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.08);border:1px solid var(--border)}
.mode-btn{padding:10px 24px;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;background:transparent;color:var(--gray);transition:all 0.2s ease}
.mode-btn.work-btn.active{background:var(--work-orange);color:white}
.mode-btn.personal-btn.active{background:var(--personal-purple-dark);color:white}
.header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.settings-btn{background:var(--white);border:1px solid var(--border);padding:8px 20px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-family:'DM Sans',sans-serif;font-weight:600;transition:all 0.15s ease}
.settings-btn:hover{background:var(--gray-light);border-color:var(--gray)}
.clear-done-btn{background:none;border:1px solid var(--border);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;color:var(--gray);transition:all 0.15s ease}
.clear-done-btn:hover{border-color:var(--danger);color:var(--danger)}
.sync-status{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:0.75rem;font-weight:600;border:1px solid var(--border);background:var(--white);cursor:pointer}
.sync-status .dot{width:8px;height:8px;border-radius:50%}
.sync-status.synced .dot{background:var(--success)}
.sync-status.syncing .dot{background:var(--personal-orange);animation:pulse 1s infinite}
.sync-status.offline .dot{background:var(--gray)}
.sync-status.error .dot{background:var(--danger)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

.stats-row{display:flex;flex-direction:row;gap:12px;flex-wrap:nowrap}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:12px 16px;flex:1 1 0;min-width:80px;transition:transform 0.15s ease,background 0.3s ease,border-color 0.3s ease}
.stat-card:hover{transform:translateY(-1px)}
.stat-card.highlight{background:var(--work-pink-light);border-color:var(--work-pink)}
.stat-card.warning{background:#FFF3E0;border-color:var(--work-orange)}
.stat-card.danger{background:#FFEBEE;border-color:var(--personal-red)}
body.personal-mode .stat-card.highlight{background:#EDE7F6;border-color:var(--personal-purple)}
body.personal-mode .stat-card.warning{background:#FFEBEE;border-color:var(--personal-red)}
.stat-number{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:600;line-height:1}
.stat-label{font-size:0.7rem;color:var(--gray);margin-top:2px;font-weight:500}
.quick-add{background:var(--work-yellow-cream);border-radius:16px;padding:24px;margin-bottom:32px;transition:background 0.3s ease}
body.personal-mode .quick-add{background:#EDE7F6}
.quick-add-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.quick-add-primary{display:flex;gap:12px;align-items:center;width:100%}
.quick-add-primary input[type="text"]{flex:1;min-width:200px}
.quick-add-options{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%;margin-top:4px}
.quick-add-options select,.quick-add-options input[type="date"]{padding:10px 14px;font-size:0.85rem}
.quick-add input[type="text"]{flex:1;min-width:200px;padding:14px 18px;border:1px solid var(--border);border-radius:10px;font-size:0.95rem;font-family:'DM Sans',sans-serif;background:var(--white);transition:border-color 0.15s ease}
.quick-add input[type="text"]:focus{outline:none;border-color:var(--work-orange)}
body.personal-mode .quick-add input[type="text"]:focus{border-color:var(--personal-purple-dark)}
.quick-add select,.quick-add input[type="date"]{padding:14px 18px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;background:var(--white)}
.btn{padding:14px 28px;border:none;border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;transition:all 0.15s ease}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--work-orange);color:var(--white)}
.btn-primary:hover{opacity:0.9}
body.personal-mode .btn-primary{background:var(--personal-purple-dark)}
.btn-secondary{background:var(--white);color:var(--dark);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--gray-light)}
.btn-sm{padding:8px 16px;font-size:0.8rem}
.btn-icon{padding:14px 16px;background:var(--white);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:1.2rem;transition:all 0.15s ease}
.btn-icon:hover{background:var(--gray-light);border-color:var(--gray)}
.btn-danger{background:none;border:1px solid var(--border);color:var(--gray);padding:8px 14px;border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer}
.btn-danger:hover{border-color:var(--danger);color:var(--danger);background:#FFF5F5}
.work-view{display:block}body.personal-mode .work-view{display:none}
.personal-view{display:none}body.personal-mode .personal-view{display:block}
.view-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.view-tab{padding:12px 24px;background:var(--white);border:1px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:600;cursor:pointer;color:var(--gray);transition:all 0.15s ease}
.view-tab:hover{border-color:var(--gray)}
.view-tab.active{background:var(--work-orange);color:white;border-color:var(--work-orange)}
body.personal-mode .view-tab.active{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:24px}
.filter-label{font-size:0.85rem;font-weight:600;color:var(--gray)}
.filter-btn{padding:8px 16px;background:var(--white);border:1px solid var(--border);border-radius:20px;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;color:var(--gray);transition:all 0.15s ease}
.filter-btn:hover{border-color:var(--gray)}
.filter-btn.active{background:var(--work-orange);color:var(--white);border-color:var(--work-orange)}
body.personal-mode .filter-btn.active{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark);color:white}
.tag-filter-banner{background:var(--work-yellow-cream);padding:16px 24px;border-radius:12px;margin-bottom:24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
body.personal-mode .tag-filter-banner{background:#EDE7F6}
.tag-filter-banner h3{font-family:'Playfair Display',serif;font-size:1.1rem}
.tag-filter-count{background:var(--work-orange);color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:600}
body.personal-mode .tag-filter-count{background:var(--personal-purple-dark)}
.clear-filter-btn{margin-left:auto;padding:8px 16px;background:var(--white);border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:0.8rem;cursor:pointer}
.partners-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:24px}
.partner-section{background:var(--white);border:1px solid var(--border);border-radius:16px;overflow:hidden}
.partner-header{padding:16px 24px;font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.partner-header .task-count{background:var(--gray-light);color:var(--gray);padding:4px 12px;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.75rem;font-weight:600}
.haven .partner-header{background:var(--work-pink-light)}.haven .partner-header .task-count{background:var(--work-pink);color:var(--dark)}
.bonclub .partner-header{background:#FFF3E0}.bonclub .partner-header .task-count{background:var(--work-orange);color:white}
.admin .partner-header{background:var(--work-yellow-cream)}.admin .partner-header .task-count{background:var(--work-orange-dark);color:white}
.project-section{border-bottom:1px solid var(--border)}
.project-header{padding:12px 24px;background:var(--gray-light);font-weight:600;font-size:0.85rem;color:var(--gray)}
.deliverable-section{padding:12px 24px;border-left:3px solid transparent}
.deliverable-section.has-tasks{border-left-color:var(--work-orange)}
.deliverable-name{font-size:0.75rem;color:var(--gray);margin-bottom:8px;font-weight:600;text-transform:uppercase}
.task-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)}
.task-item:last-child{border-bottom:none}
.task-checkbox{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;cursor:pointer;flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;background:var(--white);transition:all 0.15s ease}
.task-checkbox:hover{border-color:var(--work-orange)}
body.personal-mode .task-checkbox:hover{border-color:var(--personal-purple-dark)}
.task-checkbox.checked{background:var(--work-orange);border-color:var(--work-orange)}
.task-checkbox.checked::after{content:'\2713';color:white;font-size:12px;font-weight:bold}
body.personal-mode .task-checkbox.checked{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.task-content{flex:1}.task-text{font-size:0.95rem;font-weight:500}
.task-item.completed{opacity:0.45}.task-item.completed .task-text{text-decoration:line-through;color:var(--gray)}
.task-meta{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center}
.task-due{font-size:0.75rem;padding:4px 10px;font-weight:600;border-radius:6px;background:var(--gray-light);color:var(--gray)}
.task-due.overdue{background:#FFEBEE;color:#C62828}
.task-due.today{background:#E8F5E9;color:#2E7D32}
.task-due.tomorrow{background:#FFF3E0;color:#E65100}
.task-tag{font-size:0.7rem;padding:4px 10px;font-weight:600;border-radius:6px;background:var(--gray-light);color:var(--gray)}
.task-source{font-size:0.7rem;color:var(--gray);font-style:italic}
.delete-task{opacity:0;background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem;padding:4px 8px;transition:all 0.15s ease}
.task-item:hover .delete-task,.work-task-item:hover .delete-task,.personal-task-item:hover .delete-task{opacity:1}
.delete-task:hover{color:var(--danger)}
.empty-state{text-align:center;padding:32px 20px;color:var(--gray);font-size:0.9rem}
.priority-section{margin-bottom:24px}
.priority-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.priority-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:700;text-transform:uppercase}
.priority-pill.high{background:#FFEBEE;color:var(--personal-red)}.priority-pill.high::before{content:'\25B2';font-size:0.7rem}
.priority-pill.medium{background:#FFF3E0;color:var(--personal-orange)}.priority-pill.medium::before{content:'\25CF';font-size:0.6rem}
.priority-pill.low{background:#EDE7F6;color:var(--personal-purple)}.priority-pill.low::before{content:'\25BC';font-size:0.7rem}
.priority-count{font-size:0.85rem;color:var(--gray);font-weight:500}
.priority-add-btn{margin-left:auto;background:none;border:none;font-size:1.2rem;color:var(--gray);cursor:pointer}
.priority-add-btn:hover{color:var(--dark)}
.priority-tasks{background:var(--white);border-radius:16px;overflow:hidden;border:1px solid var(--border);border-left:3px solid var(--border)}
.priority-section.p-high .priority-tasks{border-left-color:var(--personal-red)}
.priority-section.p-medium .priority-tasks{border-left-color:var(--personal-orange)}
.priority-section.p-low .priority-tasks{border-left-color:var(--personal-purple);opacity:0.85}
.priority-empty{padding:20px;text-align:center;color:var(--gray);font-size:0.85rem;border:1.5px dashed var(--border);border-radius:12px;margin:8px;opacity:0.7}
.work-task-item,.personal-task-item{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);background:var(--white);transition:background 0.1s ease}
.work-task-item:hover,.personal-task-item:hover{background:var(--gray-light)}
.work-task-item:last-child,.personal-task-item:last-child{border-bottom:none}
.work-task-item.completed,.personal-task-item.completed{opacity:0.45}
.work-task-item.completed .work-task-text,.personal-task-item.completed .personal-task-text{text-decoration:line-through;color:var(--gray)}
.work-task-content,.personal-task-content{flex:1}
.work-task-text,.personal-task-text{font-weight:500}
.work-task-meta,.personal-task-meta{font-size:0.8rem;color:var(--gray);margin-top:4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.work-task-checkbox,.personal-task-checkbox{width:26px;height:26px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s ease}
.work-task-checkbox:hover{border-color:var(--work-orange)}
.personal-task-checkbox:hover{border-color:var(--personal-purple-dark)}
.work-task-checkbox.checked{background:var(--work-orange);border-color:var(--work-orange)}
.work-task-checkbox.checked::after,.personal-task-checkbox.checked::after{content:'\2713';color:white;font-size:14px;font-weight:bold}
.personal-task-checkbox.checked{background:var(--personal-purple-dark);border-color:var(--personal-purple-dark)}
.personal-task-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background:var(--gray-light)}
.habit-badge{background:var(--personal-green);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.repeat-badge{background:var(--personal-blue);color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.priority-badge{padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.priority-badge.high{background:#FFEBEE;color:var(--personal-red)}
.priority-badge.medium{background:#FFF3E0;color:var(--personal-orange)}
.priority-badge.low{background:#EDE7F6;color:var(--personal-purple)}
.protocol-source{font-size:0.7rem;color:var(--personal-purple);font-weight:600}
.projects-grid,.protocols-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.project-card{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:20px;cursor:pointer;transition:all 0.15s ease}
.project-card:hover{border-color:var(--personal-purple);box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-2px)}
.project-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.project-card-title{font-weight:600;display:flex;align-items:center;gap:8px}
.project-status{padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600;text-transform:uppercase}
.project-status.active{background:var(--personal-green);color:white}
.project-status.paused{background:var(--personal-orange);color:white}
.project-status.someday{background:var(--gray-light);color:var(--gray)}
.project-card-meta{font-size:0.85rem;color:var(--gray)}
.project-progress{margin-top:12px;height:6px;background:var(--gray-light);border-radius:3px;overflow:hidden}
.project-progress-bar{height:100%;background:var(--personal-purple-dark);transition:width 0.3s ease}
.protocol-card{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:24px;position:relative;transition:all 0.15s ease}
.protocol-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.06)}
.protocol-card.active{border-color:var(--personal-purple);box-shadow:0 0 0 3px rgba(149,117,205,0.2)}
.protocol-card-icon{font-size:2rem;margin-bottom:12px}
.protocol-card-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:600;margin-bottom:8px}
.protocol-card-desc{font-size:0.85rem;color:var(--gray);margin-bottom:16px}
.protocol-tasks-preview{font-size:0.8rem;color:var(--gray);margin-bottom:16px}
.protocol-activate-btn{width:100%;padding:12px;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;background:var(--gray-light);transition:all 0.15s ease}
.protocol-activate-btn:hover{background:var(--personal-purple);color:white}
.protocol-card.active .protocol-activate-btn{background:var(--personal-red);color:white}
.protocol-active-badge{position:absolute;top:12px;right:12px;background:var(--personal-purple-dark);color:white;padding:4px 10px;border-radius:12px;font-size:0.7rem;font-weight:600}
.done-section{margin-top:32px}
.done-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer;user-select:none}
.done-pill{padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:700;text-transform:uppercase;background:var(--gray-light);color:var(--gray)}
.done-toggle{color:var(--gray);transition:transform 0.2s ease;font-size:0.8rem}
.done-toggle.expanded{transform:rotate(180deg)}
.done-tasks{display:none}.done-tasks.expanded{display:block}
.filtered-tasks-list{background:var(--white);border-radius:16px;overflow:hidden;border:1px solid var(--border)}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s ease}
.modal-overlay.active{display:flex;opacity:1}
.modal{background:var(--white);border-radius:20px;padding:32px;max-width:600px;width:90%;max-height:85vh;overflow-y:auto}
.modal.wide{max-width:800px}
.modal h2{font-family:'Playfair Display',serif;font-weight:600;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.modal-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
.modal-tab{padding:10px 20px;background:var(--gray-light);border:none;border-radius:8px;font-size:0.85rem;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;color:var(--gray)}
.modal-tab.active{background:var(--work-orange);color:white}
body.personal-mode .modal-tab.active{background:var(--personal-purple-dark)}
.modal-section{margin-bottom:24px}
.modal-section h3{font-size:0.85rem;color:var(--gray);margin-bottom:12px;font-weight:600}
.modal input,.modal select,.modal textarea{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;margin-bottom:8px;background:var(--white)}
.modal textarea{min-height:80px;resize:vertical}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--gray-light);border-radius:10px;margin-bottom:8px}
.settings-item-info{flex:1}
.settings-item-title{font-weight:600;font-size:0.9rem}
.settings-item-meta{font-size:0.8rem;color:var(--gray)}
.settings-item-actions button{background:none;border:none;color:var(--gray);cursor:pointer;font-size:1rem;padding:4px 8px}
.settings-item-actions button.delete:hover{color:var(--danger)}
.add-inline{display:flex;gap:8px;margin-top:12px}
.add-inline input{flex:1;margin-bottom:0}
.subtask-item{display:flex;align-items:center;gap:8px;padding:8px 0;font-size:0.85rem}
.subtask-item button{background:none;border:none;color:var(--gray);cursor:pointer}
.api-key-input{display:flex;gap:8px}
.api-key-input input{flex:1;margin-bottom:0;font-family:monospace;font-size:0.85rem}
.api-status{padding:8px 12px;border-radius:8px;font-size:0.85rem;margin-top:8px}
.api-status.connected{background:#E8F5E9;color:#2E7D32}
.api-status.disconnected{background:#FFF3E0;color:#E65100}
.drop-zone{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s ease}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--work-orange);background:var(--work-yellow-cream)}
body.personal-mode .drop-zone:hover,body.personal-mode .drop-zone.dragover{border-color:var(--personal-purple-dark);background:#EDE7F6}
.drop-zone-icon{font-size:3rem;margin-bottom:12px}
.drop-zone-text{font-weight:600;margin-bottom:4px}
.drop-zone-hint{font-size:0.85rem;color:var(--gray)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--dark);color:white;padding:14px 28px;border-radius:12px;font-size:0.9rem;font-weight:500;z-index:2000;opacity:0;transition:all 0.3s ease;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,0.2)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{background:#2E7D32}.toast.error{background:#C62828}
.kbd-hint{font-size:0.7rem;color:var(--gray);margin-top:8px;text-align:center}
.kbd{background:var(--gray-light);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-family:monospace;font-size:0.7rem}
.sync-btn{background:none;border:1px solid var(--border);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-family:'DM Sans',sans-serif;font-weight:600;color:var(--gray);display:inline-flex;align-items:center;gap:6px}
.sync-btn:hover{border-color:var(--work-orange);color:var(--work-orange)}
.sync-btn.syncing{pointer-events:none;opacity:0.6}
.sync-btn.syncing .sync-icon{animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.sync-badge{background:var(--work-orange);color:white;font-size:0.65rem;font-weight:700;padding:2px 6px;border-radius:10px;margin-left:2px}
.scan-preview{display:flex;gap:24px;margin-bottom:24px}
.scan-image{width:200px;height:200px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
.scan-instructions{flex:1}
.scan-instructions h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:8px}
.scan-instructions p{color:var(--gray);font-size:0.9rem;margin-bottom:12px}
.scan-status{display:flex;align-items:center;gap:8px;padding:12px 16px;background:var(--gray-light);border-radius:10px;font-size:0.9rem}
.scan-status.loading{background:#E3F2FD;color:#1565C0}
.scan-status.error{background:#FFEBEE;color:#C62828}
.suggested-task{display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--gray-light);border-radius:12px;margin-bottom:12px}
.suggested-task input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--work-orange)}
body.personal-mode .suggested-task input[type="checkbox"]{accent-color:var(--personal-purple-dark)}
.suggested-task-content{flex:1}
.suggested-task-text{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:0.9rem;font-family:'DM Sans',sans-serif}
.suggested-task-options{display:flex;gap:8px;margin-top:8px}
.suggested-task-options select{padding:6px 10px;font-size:0.8rem;border:1px solid var(--border);border-radius:6px}
.suggested-task .remove-btn{background:none;border:none;color:var(--gray);cursor:pointer;font-size:1.2rem}
.suggested-task .remove-btn:hover{color:var(--danger)}
.setup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:3000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.setup-card{background:var(--white);border-radius:24px;padding:40px;max-width:520px;width:90%;box-shadow:0 24px 48px rgba(0,0,0,0.15)}
.setup-card h2{font-family:'Playfair Display',serif;font-size:1.6rem;margin-bottom:8px}
.setup-card p{color:var(--gray);font-size:0.9rem;margin-bottom:24px;line-height:1.6}
.setup-card label{display:block;font-weight:600;font-size:0.85rem;margin-bottom:6px;color:var(--dark)}
.setup-card input{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-size:0.9rem;font-family:'DM Sans',sans-serif;margin-bottom:16px}
.setup-card input:focus{outline:none;border-color:var(--personal-purple-dark)}
.setup-error{background:#FFEBEE;color:#C62828;padding:10px 14px;border-radius:8px;font-size:0.85rem;margin-bottom:16px;display:none}
.setup-hint{font-size:0.8rem;color:var(--gray);margin-top:16px;padding:12px;background:var(--gray-light);border-radius:10px;line-height:1.6}
.setup-hint a{color:var(--personal-purple-dark);text-decoration:none;font-weight:600}
.setup-hint ol{margin:8px 0 0 16px}.setup-hint li{margin-bottom:4px}
.sync-task-item{display:flex;align-items:flex-start;gap:12px;padding:16px;background:var(--gray-light);border-radius:12px;margin-bottom:12px}
.sync-task-item input[type="checkbox"]{width:20px;height:20px;margin-top:2px;accent-color:var(--work-orange);flex-shrink:0}
.sync-task-content{flex:1}
.sync-task-title{font-weight:600;font-size:0.95rem;margin-bottom:8px}
.sync-task-notes{font-size:0.8rem;color:var(--gray);margin-bottom:8px;font-style:italic}
.sync-task-options{display:flex;gap:8px;flex-wrap:wrap}
.sync-task-options select{padding:8px 12px;font-size:0.8rem;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;background:var(--white)}
.sync-empty{text-align:center;padding:32px 20px;color:var(--gray)}
.sync-empty-icon{font-size:2.5rem;margin-bottom:12px}
.sync-empty-text{font-size:0.95rem;font-weight:500;margin-bottom:4px}
.sync-empty-sub{font-size:0.85rem}
@media(max-width:768px){.container{padding:16px 12px}.partners-grid,.projects-grid,.protocols-grid{grid-template-columns:1fr}.quick-add{padding:16px}.quick-add-primary{flex-wrap:wrap}.quick-add-primary input[type="text"]{width:100%;min-width:0}.quick-add-options{gap:6px}.quick-add-options select,.quick-add-options input[type="date"]{flex:1;min-width:0;padding:10px 12px;font-size:0.8rem}h1{font-size:1.8rem}.header-left{flex-direction:column;align-items:flex-start;gap:12px}.mode-toggle{width:100%;justify-content:center}.scan-preview{flex-direction:column}.scan-image{width:100%;height:150px}.kbd-hint{display:none}.stats-row{flex-wrap:wrap}.stat-card{flex:1 1 45%;min-width:0}.filter-btn{padding:6px 12px;font-size:0.75rem}.view-tab{padding:10px 16px;font-size:0.85rem}.work-task-item,.personal-task-item{padding:12px 16px}.btn{padding:12px 20px}.btn-icon{padding:12px 14px}}
</style>
</head>
<body>
<div class="setup-overlay" id="setupOverlay" style="display:none">
<div class="setup-card">
<h2>&#x1F525; Connect Firebase</h2>
<p>Your planner needs Firebase to sync across devices. Create a free Firebase project and paste your config below.</p>
<div class="setup-error" id="setupError"></div>
<label>Firebase API Key</label>
<input type="text" id="setupApiKey" placeholder="AIzaSy...">
<label>Firebase Project ID</label>
<input type="text" id="setupProjectId" placeholder="my-planner-12345">
<label>Firebase App ID</label>
<input type="text" id="setupAppId" placeholder="1:123456789:web:abc123">
<div style="display:flex;gap:12px;margin-top:8px"><button class="btn btn-primary" onclick="saveFirebaseConfig()" style="flex:1">Connect & Sync</button></div>
<div class="setup-hint"><strong>Quick setup:</strong><ol>
<li>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> &rarr; Create Project</li>
<li>Add a Web App (click <strong>&lt;/&gt;</strong> icon)</li>
<li>Copy apiKey, projectId, and appId values</li>
<li>Go to Build &rarr; Realtime Database &rarr; Create Database</li>
<li>In Rules tab, set: <code>{"rules":{".read":"auth != null",".write":"auth != null"}}</code></li>
<li>Go to Build &rarr; Authentication &rarr; Enable Anonymous sign-in</li>
</ol></div>
</div></div>

<div class="container">
<header>
<div class="header-top">
<div class="header-left"><h1>MJ's Planner</h1><div class="mode-toggle"><button class="mode-btn work-btn active" onclick="setMode('work')">Work</button><button class="mode-btn personal-btn" onclick="setMode('personal')">Personal</button></div></div>
<div class="header-actions">
<div class="sync-status offline" id="syncStatusIndicator" onclick="openSettings()"><span class="dot"></span><span id="syncStatusText">Local</span></div>
<button class="sync-btn work-view" id="syncBtn" onclick="syncGoogleTasks()" title="Sync Google Tasks"><span class="sync-icon">&#x1F504;</span> Sync<span class="sync-badge" id="syncBadge" style="display:none">0</span></button>
<button class="clear-done-btn" id="clearDoneBtn" onclick="clearCompleted()" style="display:none">Clear Done</button>
<button class="settings-btn" onclick="openSettings()">&#x2699; Settings</button>
</div></div>
<div class="stats-row work-view"><div class="stat-card"><div class="stat-number" id="totalTasks">0</div><div class="stat-label">Total</div></div><div class="stat-card warning"><div class="stat-number" id="urgentTasks">0</div><div class="stat-label">Urgent</div></div><div class="stat-card" id="overdueCard"><div class="stat-number" id="overdueTasks">0</div><div class="stat-label">Overdue</div></div><div class="stat-card highlight"><div class="stat-number" id="completedToday">0</div><div class="stat-label">Done Today</div></div></div>
<div class="stats-row personal-view"><div class="stat-card"><div class="stat-number" id="pTotalTasks">0</div><div class="stat-label">To-Do</div></div><div class="stat-card warning"><div class="stat-number" id="pHighTasks">0</div><div class="stat-label">High</div></div><div class="stat-card"><div class="stat-number" id="pHabits">0</div><div class="stat-label">Habits</div></div><div class="stat-card highlight"><div class="stat-number" id="pCompletedToday">0</div><div class="stat-label">Done Today</div></div></div>
</header>
<div class="work-view">
<div class="quick-add"><div class="quick-add-row"><div class="quick-add-primary"><input type="text" id="workTaskInput" placeholder="What needs to be done?" onkeypress="if(event.key==='Enter')addWorkTask()"><button class="btn btn-primary" onclick="addWorkTask()">Add Task</button><button class="btn-icon" onclick="openScanModal()" title="Scan handwritten notes">&#x1F4F7;</button></div><div class="quick-add-options"><select id="workProjectSelect"></select><select id="workPrioritySelect"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">Urgent</option></select><input type="date" id="workDueDate"><select id="workTagSelect"><option value="">Tag</option></select></div></div><div class="kbd-hint"><span class="kbd">Enter</span> to add &middot; <span class="kbd">Tab</span>/<span class="kbd">Shift+Tab</span> to switch modes</div></div>
<div class="view-tabs"><button class="view-tab active" onclick="setWorkView('priority',this)">&#x1F4CB; By Priority</button><button class="view-tab" onclick="setWorkView('projects',this)">&#x1F4C1; By Project</button></div>
<div id="workPriorityView">
<div class="priority-section p-high"><div class="priority-header"><span class="priority-pill high">Urgent</span><span class="priority-count" id="wHighCount">(0)</span></div><div class="priority-tasks" id="wHighTasks"></div></div>
<div class="priority-section p-medium"><div class="priority-header"><span class="priority-pill medium">Medium</span><span class="priority-count" id="wMediumCount">(0)</span></div><div class="priority-tasks" id="wMediumTasks"></div></div>
<div class="priority-section p-low"><div class="priority-header"><span class="priority-pill low">Low</span><span class="priority-count" id="wLowCount">(0)</span></div><div class="priority-tasks" id="wLowTasks"></div></div>
<div class="done-section"><div class="done-header" onclick="toggleWorkDone()"><span class="done-pill">Done <span id="wDoneCount">(0)</span></span><span class="done-toggle" id="wDoneToggle">&#x25BC;</span></div><div class="done-tasks" id="wDoneTasks"></div></div>
</div><div id="workProjectsView" class="partners-grid" style="display:none"></div></div>
<div class="personal-view">
<div class="quick-add"><div class="quick-add-row"><div class="quick-add-primary"><input type="text" id="personalTaskInput" placeholder="Add a to-do..." onkeypress="if(event.key==='Enter')addPersonalTask()"><button class="btn btn-primary" onclick="addPersonalTask()">Add</button><button class="btn-icon" onclick="openScanModal()" title="Scan handwritten notes">&#x1F4F7;</button></div><div class="quick-add-options"><select id="personalPrioritySelect"><option value="high">High</option><option value="medium" selected>Medium</option><option value="low">Low</option></select><select id="personalTagSelect"><option value="">Tag</option></select></div></div><div class="kbd-hint"><span class="kbd">Enter</span> to add &middot; <span class="kbd">Tab</span>/<span class="kbd">Shift+Tab</span> to switch modes</div></div>
<div class="view-tabs"><button class="view-tab active" onclick="setPersonalView('todo',this)">&#x1F4CB; To-Do</button><button class="view-tab" onclick="setPersonalView('projects',this)">&#x1F3AF; Projects</button><button class="view-tab" onclick="setPersonalView('protocols',this)">&#x1FA79; Protocols</button></div>
<div id="personalFiltersRow" class="filters"><span class="filter-label">Filter:</span><button class="filter-btn active" onclick="setPersonalTagFilter('',this)">All</button><span id="personalTagFilters"></span></div>
<div id="tagFilterBanner" class="tag-filter-banner" style="display:none"><h3><span id="filterTagIcon"></span> <span id="filterTagName"></span></h3><span class="tag-filter-count" id="filterTagCount">0 tasks</span><button class="clear-filter-btn" onclick="clearTagFilter()">&times; Clear</button></div>
<div id="filteredTasksView" style="display:none"><div class="filtered-tasks-list" id="filteredTasksList"></div></div>
<div id="personalTodoView">
<div class="priority-section p-high"><div class="priority-header"><span class="priority-pill high">High</span><span class="priority-count" id="highCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('high')">+</button></div><div class="priority-tasks" id="highTasks"></div></div>
<div class="priority-section p-medium"><div class="priority-header"><span class="priority-pill medium">Medium</span><span class="priority-count" id="mediumCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('medium')">+</button></div><div class="priority-tasks" id="mediumTasks"></div></div>
<div class="priority-section p-low"><div class="priority-header"><span class="priority-pill low">Low</span><span class="priority-count" id="lowCount">(0)</span><button class="priority-add-btn" onclick="openPersonalAddModal('low')">+</button></div><div class="priority-tasks" id="lowTasks"></div></div>
<div class="done-section"><div class="done-header" onclick="toggleDone()"><span class="done-pill">Done <span id="doneCount">(0)</span></span><span class="done-toggle" id="pDoneToggle">&#x25BC;</span></div><div class="done-tasks" id="doneTasks"></div></div>
</div>
<div id="personalProjectsView" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="font-family:'Playfair Display',serif;font-size:1.3rem">My Projects</h2><button class="btn btn-primary btn-sm" onclick="openProjectModal()">+ New Project</button></div><div class="projects-grid" id="projectsGrid"></div></div>
<div id="personalProtocolsView" style="display:none"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><div><h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:4px">My Protocols</h2><p style="color:var(--gray);font-size:0.85rem">Pre-built routines for tough days</p></div><button class="btn btn-primary btn-sm" onclick="openProtocolModal()">+ New Protocol</button></div><div class="protocols-grid" id="protocolsGrid"></div></div>
</div></div>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()"><div class="modal"><h2>&#x2699; Settings</h2><div class="modal-tabs" id="settingsTabs"></div><div id="settingsContent"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeSettings()">Done</button></div></div></div>
<div class="modal-overlay" id="personalAddModal" onclick="if(event.target===this)closePersonalAddModal()"><div class="modal"><h2>Add To-Do</h2><div class="modal-section"><h3>Task</h3><input type="text" id="pModalTask" placeholder="e.g., Pay rent" onkeypress="if(event.key==='Enter')savePersonalModalTask()"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="pModalIcon" placeholder="&#x1F4CC;" style="width:80px"></div><div style="display:flex;gap:16px"><div class="modal-section" style="flex:1"><h3>Priority</h3><select id="pModalPriority"><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select></div><div class="modal-section" style="flex:1"><h3>Tag</h3><select id="pModalTag"></select></div></div><div class="modal-section"><h3>Repeat?</h3><select id="pModalRepeat" onchange="toggleRepeatOptions()"><option value="">No repeat</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="habit">30-day Habit</option></select></div><div id="repeatOptions" style="display:none"><div class="modal-section"><h3>Day</h3><select id="pModalDay"><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option></select></div></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closePersonalAddModal()">Cancel</button><button class="btn btn-primary" onclick="savePersonalModalTask()">Add</button></div></div></div>
<div class="modal-overlay" id="projectModal" onclick="if(event.target===this)closeProjectModal()"><div class="modal"><h2 id="projectModalTitle">New Project</h2><div class="modal-section"><h3>Name</h3><input type="text" id="projectName" placeholder="e.g., Redecorate bedroom"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="projectIcon" placeholder="&#x1F3AF;" style="width:80px"></div><div class="modal-section"><h3>Status</h3><select id="projectStatus"><option value="someday">Someday</option><option value="active">Active</option><option value="paused">Paused</option></select></div><div class="modal-section"><h3>Subtasks</h3><div id="projectSubtasks"></div><div class="add-inline"><input type="text" id="newSubtask" placeholder="Add subtask" onkeypress="if(event.key==='Enter')addProjectSubtask()"><button class="btn btn-primary btn-sm" onclick="addProjectSubtask()">+</button></div></div><input type="hidden" id="editingProjectId"><div class="modal-actions"><button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button><button class="btn btn-primary" onclick="saveProject()">Save</button></div></div></div>
<div class="modal-overlay" id="protocolModal" onclick="if(event.target===this)closeProtocolModal()"><div class="modal"><h2 id="protocolModalTitle">New Protocol</h2><div class="modal-section"><h3>Name</h3><input type="text" id="protocolName" placeholder="e.g., Morning Routine"></div><div class="modal-section"><h3>Icon</h3><input type="text" id="protocolIcon" placeholder="&#x1F305;" style="width:80px"></div><div class="modal-section"><h3>Description</h3><textarea id="protocolDesc" placeholder="When to use this protocol..."></textarea></div><div class="modal-section"><h3>Tasks</h3><div id="protocolTasks"></div><div class="add-inline"><input type="text" id="newProtocolTask" placeholder="Add task" onkeypress="if(event.key==='Enter')addProtocolTask()"><input type="text" id="newProtocolTaskIcon" placeholder="&#x1F4CC;" style="width:60px"><button class="btn btn-primary btn-sm" onclick="addProtocolTask()">+</button></div></div><input type="hidden" id="editingProtocolId"><div class="modal-actions"><button class="btn btn-secondary" onclick="closeProtocolModal()">Cancel</button><button class="btn btn-primary" onclick="saveProtocol()">Save</button></div></div></div>
<div class="modal-overlay" id="scanModal" onclick="if(event.target===this)closeScanModal()"><div class="modal wide"><h2>&#x1F4F7; Scan Handwritten Notes</h2><div id="scanUploadView"><div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()"><div class="drop-zone-icon">&#x1F4DD;</div><div class="drop-zone-text">Drop image here or click to upload</div><div class="drop-zone-hint">Photos of lists, mind maps, sticky notes</div></div><input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)"></div><div id="scanReviewView" style="display:none"><div class="scan-preview"><img id="scanPreviewImg" class="scan-image" src="" alt=""><div class="scan-instructions"><h3>Review &amp; Edit Tasks</h3><p>Check tasks to add, edit text, set priority and tags.</p><div id="scanStatusBox" class="scan-status"></div></div></div><div id="suggestedTasksList"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="resetScanModal()">&larr; Different Image</button><button class="btn btn-primary" id="addSelectedBtn" onclick="addSelectedTasks()" disabled>Add Selected</button></div></div></div></div>
<div class="modal-overlay" id="syncModal" onclick="if(event.target===this)closeSyncModal()"><div class="modal wide"><h2>&#x1F504; Google Tasks</h2><div id="syncContent"><div class="sync-empty"><div class="sync-empty-icon">&#x1F4ED;</div><div class="sync-empty-text">No new tasks</div></div></div><div class="modal-actions" id="syncActions" style="display:none"><button class="btn btn-secondary" onclick="closeSyncModal()">Cancel</button><button class="btn btn-primary" id="importSyncBtn" onclick="importSyncedTasks()">Import Selected</button></div></div></div>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script>
// ══════════════════════════════════════════
// FIREBASE SYNC LAYER
// ══════════════════════════════════════════
let db=null,userId=null,firebaseReady=false,_swt=null,_spt=null,_sst=null;
function getFirebaseConfig(){try{return JSON.parse(localStorage.getItem('mjPlanner_firebase_config'))}catch(e){return null}}
function setSyncStatus(s,t){var e=document.getElementById('syncStatusIndicator'),x=document.getElementById('syncStatusText');e.className='sync-status '+s;x.textContent=t||s.charAt(0).toUpperCase()+s.slice(1)}
function ensureArrays(d,type){
  if(type==='work'){if(!d.tasks)d.tasks=[];if(!d.partners)d.partners=[];if(!d.tags)d.tags=[];d.partners.forEach(function(p){if(!p.projects)p.projects=[];p.projects.forEach(function(pr){if(!pr.deliverables)pr.deliverables=[]})});}
  if(type==='personal'){if(!d.tasks)d.tasks=[];if(!d.tags)d.tags=[];if(!d.projects)d.projects=[];if(!d.protocols)d.protocols=[];d.protocols.forEach(function(p){if(!p.tasks)p.tasks=[]});}
  return d;
}
async function initFirebase(){
  var config=getFirebaseConfig();
  if(!config){document.getElementById('setupOverlay').style.display='flex';loadDataLocal();initApp();setSyncStatus('offline','Local only');return}
  try{
    firebase.initializeApp({apiKey:config.apiKey,authDomain:config.projectId+'.firebaseapp.com',databaseURL:'https://'+config.projectId+'-default-rtdb.firebaseio.com',projectId:config.projectId,appId:config.appId});
    setSyncStatus('syncing','Connecting...');
    firebase.auth().onAuthStateChanged(async function(user){
      if(user){userId=user.uid;localStorage.setItem('mjPlanner_firebase_uid',userId);db=firebase.database();firebaseReady=true;
        await loadDataFirebase();initApp();listenForUpdates();setSyncStatus('synced','Synced');
        firebase.database().ref('.info/connected').on('value',function(s){setSyncStatus(s.val()?'synced':'offline',s.val()?'Synced':'Offline')});
      }
    });
    await firebase.auth().signInAnonymously();
  }catch(err){console.error('Firebase init:',err);setSyncStatus('error','Error');showToast('Firebase: '+err.message,'error');loadDataLocal();initApp()}
}
async function loadDataFirebase(){
  try{
    var ws=await db.ref('users/'+userId+'/work').once('value'),ps=await db.ref('users/'+userId+'/personal').once('value'),ss=await db.ref('users/'+userId+'/settings').once('value');
    if(ws.val()){workData=ensureArrays(ws.val(),'work');localStorage.setItem('mjPlanner_work_v5',JSON.stringify(workData))}
    else{loadDataLocal();if(workData)await db.ref('users/'+userId+'/work').set(workData);if(personalData)await db.ref('users/'+userId+'/personal').set(personalData);if(appSettings)await db.ref('users/'+userId+'/settings').set(appSettings);showToast('Local data synced to cloud','success');return}
    if(ps.val()){personalData=ensureArrays(ps.val(),'personal');localStorage.setItem('mjPlanner_personal_v5',JSON.stringify(personalData))}else{personalData=JSON.parse(JSON.stringify(defaultPersonalData))}
    if(ss.val()){appSettings=ss.val();localStorage.setItem('mjPlanner_settings',JSON.stringify(appSettings))}else{appSettings={apiKey:'',syncUrl:''}}
  }catch(err){console.error('Firebase read:',err);loadDataLocal()}
}
function listenForUpdates(){
  if(!db||!userId)return;
  db.ref('users/'+userId+'/work').on('value',function(s){var d=s.val();if(!d)return;workData=ensureArrays(d,'work');localStorage.setItem('mjPlanner_work_v5',JSON.stringify(workData));if(currentMode==='work')renderWork();populateWorkSelects()});
  db.ref('users/'+userId+'/personal').on('value',function(s){var d=s.val();if(!d)return;personalData=ensureArrays(d,'personal');localStorage.setItem('mjPlanner_personal_v5',JSON.stringify(personalData));if(currentMode==='personal')renderPersonal();populatePersonalSelects()});
  db.ref('users/'+userId+'/settings').on('value',function(s){var d=s.val();if(d){appSettings=d;localStorage.setItem('mjPlanner_settings',JSON.stringify(appSettings))}});
}
function saveWork(){localStorage.setItem('mjPlanner_work_v5',JSON.stringify(workData));if(firebaseReady&&db&&userId){clearTimeout(_swt);_swt=setTimeout(function(){setSyncStatus('syncing','Saving...');db.ref('users/'+userId+'/work').set(workData).then(function(){setSyncStatus('synced','Synced')}).catch(function(e){setSyncStatus('error','Save failed')})},300)}}
function savePersonal(){localStorage.setItem('mjPlanner_personal_v5',JSON.stringify(personalData));if(firebaseReady&&db&&userId){clearTimeout(_spt);_spt=setTimeout(function(){setSyncStatus('syncing','Saving...');db.ref('users/'+userId+'/personal').set(personalData).then(function(){setSyncStatus('synced','Synced')}).catch(function(e){setSyncStatus('error','Save failed')})},300)}}
function saveSettings(){localStorage.setItem('mjPlanner_settings',JSON.stringify(appSettings));if(firebaseReady&&db&&userId){clearTimeout(_sst);_sst=setTimeout(function(){db.ref('users/'+userId+'/settings').set(appSettings)},300)}}
function saveFirebaseConfig(){var a=document.getElementById('setupApiKey').value.trim(),p=document.getElementById('setupProjectId').value.trim(),i=document.getElementById('setupAppId').value.trim(),e=document.getElementById('setupError');if(!a||!p||!i){e.textContent='All three fields are required.';e.style.display='block';return}localStorage.setItem('mjPlanner_firebase_config',JSON.stringify({apiKey:a,projectId:p,appId:i}));document.getElementById('setupOverlay').style.display='none';showToast('Connecting to Firebase...','success');window.location.reload()}
function disconnectFirebase(){if(!confirm('Disconnect Firebase? Data stays in the cloud but this device goes offline-only.'))return;localStorage.removeItem('mjPlanner_firebase_config');localStorage.removeItem('mjPlanner_firebase_uid');window.location.reload()}

// ══════════════════════════════════════════
// APP CORE (identical logic to original)
// ══════════════════════════════════════════
let currentMode='work',workView='priority',personalView='todo',personalTagFilter='',tempSubtasks=[],tempProtocolTasks=[],suggestedTasks=[];
const defaultWorkData={partners:[{id:'haven',name:'Haven Studio',color:'haven',projects:[{id:'rubino',name:'Rubino',deliverables:[{id:'playbook',name:'Social Media Playbook'},{id:'content',name:'Content Creation'},{id:'strategy',name:'Strategy'},{id:'influencer',name:'Influencer Campaign'},{id:'casting',name:'Casting'},{id:'toolkit1',name:'ToolKit #1'},{id:'videokids',name:'Video Series - Kids'}]}]},{id:'bonclub',name:'Bonclub',color:'bonclub',projects:[{id:'vanhoutte',name:'Van Houtte',deliverables:[{id:'campaign',name:'Campaign'},{id:'social',name:'Social Media'}]}]},{id:'admin',name:'Admin',color:'admin',projects:[{id:'business',name:'Business',deliverables:[{id:'invoices',name:'Invoices'},{id:'taxes',name:'Taxes'},{id:'linkedin',name:'LinkedIn'}]}]}],tags:[{id:'email',name:'Email',icon:'📧'},{id:'call',name:'Call',icon:'📞'},{id:'review',name:'Review',icon:'👀'},{id:'meeting',name:'Meeting',icon:'🤝'},{id:'writing',name:'Writing',icon:'✍️'},{id:'quickwin',name:'Quick Win',icon:'⚡'}],tasks:[{id:'t1',text:'Guidelines',partnerId:'haven',projectId:'rubino',deliverableId:'influencer',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:00.000Z'},{id:'t2',text:'Contract',partnerId:'haven',projectId:'rubino',deliverableId:'influencer',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:01.000Z'},{id:'t3',text:'Reporting',partnerId:'haven',projectId:'rubino',deliverableId:'influencer',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:02.000Z'},{id:'t4',text:'Create Social Media Calendar',partnerId:'haven',projectId:'rubino',deliverableId:'toolkit1',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:03.000Z'},{id:'t5',text:'Send Liana host suggestions',partnerId:'haven',projectId:'rubino',deliverableId:'videokids',priority:'high',tags:[],completed:false,createdAt:'2026-02-06T12:00:04.000Z'},{id:'t6',text:'Competitive landscape audit + best performing content analysis',partnerId:'bonclub',projectId:'vanhoutte',deliverableId:'social',priority:'medium',tags:[],completed:false,createdAt:'2026-02-06T12:00:05.000Z'},{id:'t7',text:'30-day content calendar blueprint',partnerId:'bonclub',projectId:'vanhoutte',deliverableId:'social',priority:'medium',tags:[],completed:false,createdAt:'2026-02-06T12:00:06.000Z'},{id:'t8',text:'KPIs',partnerId:'bonclub',projectId:'vanhoutte',deliverableId:'social',priority:'medium',tags:[],completed:false,createdAt:'2026-02-06T12:00:07.000Z'},{id:'t9',text:'Rubino #2',partnerId:'admin',projectId:'business',deliverableId:'invoices',priority:'low',tags:[],completed:false,createdAt:'2026-02-06T12:00:08.000Z'},{id:'t10',text:'Cancel Antidote',partnerId:'admin',projectId:'business',deliverableId:'invoices',priority:'low',tags:[],completed:false,createdAt:'2026-02-06T12:00:09.000Z'},{id:'t11',text:'Clean up download and desktop folder',partnerId:'admin',projectId:'business',deliverableId:'invoices',priority:'low',tags:[],completed:false,createdAt:'2026-02-06T12:00:10.000Z'}]};
const defaultPersonalData={tags:[{id:'email',name:'Email',icon:'📧'},{id:'call',name:'Call',icon:'📞'},{id:'errand',name:'Errand',icon:'🏃'},{id:'home',name:'Home',icon:'🏠'},{id:'order',name:'Order/Return',icon:'📦'},{id:'admin',name:'Admin',icon:'📁'},{id:'selfcare',name:'Self-care',icon:'💆'}],tasks:[],projects:[],protocols:[{id:'adhd',name:'ADHD Support',icon:'🧠',active:false,description:'Activate when executive function is struggling.',tasks:[{text:'Take ADHD medication',icon:'💊'},{text:'Drink water',icon:'💧'},{text:'Eat a real meal',icon:'🍳'},{text:'Set 25-min timer',icon:'⏱️'},{text:'5-min movement',icon:'🚶'},{text:'Write top 3',icon:'📝'}]},{id:'histamine',name:'Low-Histamine',icon:'🩹',active:false,description:'During CSU flare-ups.',tasks:[{text:'Take antihistamine',icon:'💊'},{text:'Avoid high-histamine',icon:'🚫'},{text:'Fresh meals only',icon:'🥗'},{text:'Log symptoms',icon:'📓'},{text:'Gentle exercise',icon:'🧘'},{text:'Extra hydration',icon:'💧'}]}]};
let workData,personalData,appSettings={apiKey:'',syncUrl:''};
function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(type?' '+type:'')+' show';clearTimeout(t._timer);t._timer=setTimeout(function(){t.classList.remove('show')},2500)}
function loadDataLocal(){workData=JSON.parse(localStorage.getItem('mjPlanner_work_v5')||'null')||JSON.parse(JSON.stringify(defaultWorkData));personalData=JSON.parse(localStorage.getItem('mjPlanner_personal_v5')||'null')||JSON.parse(JSON.stringify(defaultPersonalData));appSettings=JSON.parse(localStorage.getItem('mjPlanner_settings')||'null')||{apiKey:'',syncUrl:''};if(!personalData.projects)personalData.projects=[]}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}
function escapeHtml(t){var d=document.createElement('div');d.textContent=t||'';return d.innerHTML}
function setMode(m){currentMode=m;document.body.classList.toggle('personal-mode',m==='personal');document.querySelectorAll('.mode-btn').forEach(function(b){b.classList.remove('active')});document.querySelector('.'+m+'-btn').classList.add('active');m==='work'?renderWork():renderPersonal()}
document.addEventListener('keydown',function(e){if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;if(e.key==='Tab'){e.preventDefault();setMode(currentMode==='work'?'personal':'work')}if(e.key==='Escape'){closeSettings();closePersonalAddModal();closeProjectModal();closeProtocolModal();closeScanModal()}});
function formatDue(ds){if(!ds)return '';var d=new Date(ds+'T00:00:00'),today=new Date();today.setHours(0,0,0,0);var diff=Math.round((d-today)/(864e5));if(diff<0)return{text:'Overdue ('+Math.abs(diff)+'d)',cls:'overdue'};if(diff===0)return{text:'Today',cls:'today'};if(diff===1)return{text:'Tomorrow',cls:'tomorrow'};if(diff<=7)return{text:d.toLocaleDateString('en',{weekday:'short'}),cls:''};return{text:d.toLocaleDateString('en',{month:'short',day:'numeric'}),cls:''}}
function clearCompleted(){var mode=currentMode,count=0;if(mode==='work'){count=workData.tasks.filter(function(t){return t.completed}).length;workData.tasks=workData.tasks.filter(function(t){return!t.completed});saveWork();renderWork()}else{count=personalData.tasks.filter(function(t){return t.completed&&!t.protocolId}).length;personalData.tasks=personalData.tasks.filter(function(t){return!t.completed||t.protocolId});savePersonal();renderPersonal()}if(count)showToast('Cleared '+count+' completed task'+(count!==1?'s':''))}
function updateClearDoneBtn(){var tasks=currentMode==='work'?workData.tasks:personalData.tasks;document.getElementById('clearDoneBtn').style.display=tasks.filter(function(t){return t.completed}).length>0?'inline-block':'none'}
function populateWorkSelects(){var ps=document.getElementById('workProjectSelect'),ts=document.getElementById('workTagSelect');ps.innerHTML='';workData.partners.forEach(function(p){p.projects.forEach(function(pr){pr.deliverables.forEach(function(d){ps.innerHTML+='<option value="'+p.id+'|'+pr.id+'|'+d.id+'">'+p.name+' → '+pr.name+' → '+d.name+'</option>'})})});ts.innerHTML='<option value="">Tag</option>';workData.tags.forEach(function(t){ts.innerHTML+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>'})}
function addWorkTask(){var input=document.getElementById('workTaskInput'),text=input.value.trim();if(!text)return;var parts=document.getElementById('workProjectSelect').value.split('|'),tag=document.getElementById('workTagSelect').value;workData.tasks.push({id:genId(),text:text,partnerId:parts[0],projectId:parts[1],deliverableId:parts[2],priority:document.getElementById('workPrioritySelect').value,dueDate:document.getElementById('workDueDate').value||null,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()});saveWork();input.value='';document.getElementById('workDueDate').value='';document.getElementById('workTagSelect').value='';renderWork();showToast('Task added','success')}
function toggleWorkTask(id){var t=workData.tasks.find(function(x){return x.id===id});if(t){t.completed=!t.completed;t.completedAt=t.completed?new Date().toISOString():null;saveWork();renderWork();if(t.completed)showToast('✓ Done!','success')}}
function deleteWorkTask(id){workData.tasks=workData.tasks.filter(function(x){return x.id!==id});saveWork();renderWork()}
function isOverdue(t){if(!t.dueDate||t.completed)return false;return new Date(t.dueDate+'T00:00:00')<new Date(new Date().toDateString())}
function getWorkSource(t){var p=workData.partners.find(function(x){return x.id===t.partnerId});var pr=p?p.projects.find(function(x){return x.id===t.projectId}):null;return p?(p.name+(pr?' → '+pr.name:'')):''}
function renderWorkTaskClean(t){var src=getWorkSource(t);var tags=(t.tags||[]).map(function(tid){var tag=workData.tags.find(function(x){return x.id===tid});return tag?'<span class="task-tag">'+tag.icon+' '+tag.name+'</span>':''}).join('');var dueInfo=formatDue(t.dueDate);var due=dueInfo?'<span class="task-due'+(dueInfo.cls?' '+dueInfo.cls:'')+'">'+dueInfo.text+'</span>':'';return '<div class="work-task-item'+(t.completed?' completed':'')+'"><div class="work-task-checkbox'+(t.completed?' checked':'')+'" onclick="toggleWorkTask(\''+t.id+'\')"></div><div class="work-task-content"><div class="work-task-text">'+escapeHtml(t.text)+'</div><div class="work-task-meta">'+due+tags+(src?'<span class="task-source">'+src+'</span>':'')+'</div></div><button class="delete-task" onclick="deleteWorkTask(\''+t.id+'\')" title="Delete">×</button></div>'}
function renderWorkPriority(){var tasks=workData.tasks,high=tasks.filter(function(t){return t.priority==='high'&&!t.completed}),med=tasks.filter(function(t){return t.priority==='medium'&&!t.completed}),low=tasks.filter(function(t){return t.priority==='low'&&!t.completed}),done=tasks.filter(function(t){return t.completed});var sortByDue=function(arr){return arr.sort(function(a,b){if(isOverdue(a)&&!isOverdue(b))return-1;if(!isOverdue(a)&&isOverdue(b))return 1;if(a.dueDate&&b.dueDate)return new Date(a.dueDate)-new Date(b.dueDate);if(a.dueDate)return-1;if(b.dueDate)return 1;return 0})};sortByDue(high);sortByDue(med);sortByDue(low);document.getElementById('wHighCount').textContent='('+high.length+')';document.getElementById('wMediumCount').textContent='('+med.length+')';document.getElementById('wLowCount').textContent='('+low.length+')';document.getElementById('wDoneCount').textContent='('+done.length+')';document.getElementById('wHighTasks').innerHTML=high.length?high.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No urgent tasks 🎉</div>';document.getElementById('wMediumTasks').innerHTML=med.length?med.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No medium tasks</div>';document.getElementById('wLowTasks').innerHTML=low.length?low.map(renderWorkTaskClean).join(''):'<div class="priority-empty">No low tasks</div>';document.getElementById('wDoneTasks').innerHTML=done.length?done.map(renderWorkTaskClean).join(''):'<div class="priority-empty">Nothing done yet</div>'}
function renderWorkTask(t){var tags=(t.tags||[]).map(function(tid){var tag=workData.tags.find(function(x){return x.id===tid});return tag?'<span class="task-tag">'+tag.icon+'</span>':''}).join('');var dueInfo=formatDue(t.dueDate);var due=dueInfo?'<span class="task-due'+(dueInfo.cls?' '+dueInfo.cls:'')+'">'+dueInfo.text+'</span>':'';return '<div class="task-item'+(t.completed?' completed':'')+'"><div class="task-checkbox'+(t.completed?' checked':'')+'" onclick="toggleWorkTask(\''+t.id+'\')"></div><div class="task-content"><div class="task-text">'+escapeHtml(t.text)+'</div><div class="task-meta">'+due+tags+'</div></div><button class="delete-task" onclick="deleteWorkTask(\''+t.id+'\')" title="Delete">×</button></div>'}
function renderWorkProjects(){var c=document.getElementById('workProjectsView');c.innerHTML='';workData.partners.forEach(function(partner){var tasks=workData.tasks.filter(function(t){return t.partnerId===partner.id}),inc=tasks.filter(function(t){return!t.completed});var html='';partner.projects.forEach(function(proj){var dels='';proj.deliverables.forEach(function(del){var dt=tasks.filter(function(t){return t.projectId===proj.id&&t.deliverableId===del.id});if(dt.length)dels+='<div class="deliverable-section has-tasks"><div class="deliverable-name">'+del.name+'</div><div class="tasks-list">'+dt.map(renderWorkTask).join('')+'</div></div>'});if(dels)html+='<div class="project-section"><div class="project-header">'+proj.name+'</div>'+dels+'</div>'});c.innerHTML+='<div class="partner-section '+partner.color+'"><div class="partner-header">'+partner.name+'<span class="task-count">'+inc.length+'</span></div>'+(html||'<div class="empty-state">No tasks</div>')+'</div>'})}
function updateWorkStats(){var inc=workData.tasks.filter(function(t){return!t.completed}),oc=inc.filter(isOverdue).length;document.getElementById('totalTasks').textContent=inc.length;document.getElementById('urgentTasks').textContent=inc.filter(function(t){return t.priority==='high'}).length;document.getElementById('overdueTasks').textContent=oc;document.getElementById('overdueCard').className='stat-card'+(oc>0?' danger':'');var today=new Date().toDateString();document.getElementById('completedToday').textContent=workData.tasks.filter(function(t){return t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today}).length;updateClearDoneBtn()}
function setWorkView(v,btn){workView=v;document.querySelectorAll('.work-view .view-tab').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');document.getElementById('workPriorityView').style.display=v==='priority'?'block':'none';document.getElementById('workProjectsView').style.display=v==='projects'?'grid':'none';renderWork()}
function toggleWorkDone(){document.getElementById('wDoneTasks').classList.toggle('expanded');document.getElementById('wDoneToggle').classList.toggle('expanded')}
function renderWork(){workView==='priority'?renderWorkPriority():renderWorkProjects();updateWorkStats()}
function populatePersonalSelects(){var ts=document.getElementById('personalTagSelect'),mt=document.getElementById('pModalTag');[ts,mt].forEach(function(s){if(!s)return;s.innerHTML='<option value="">No tag</option>';personalData.tags.forEach(function(t){s.innerHTML+='<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>'})});renderPersonalTagFilters()}
function renderPersonalTagFilters(){document.getElementById('personalTagFilters').innerHTML=personalData.tags.map(function(t){return '<button class="filter-btn'+(personalTagFilter===t.id?' active':'')+'" onclick="setPersonalTagFilter(\''+t.id+'\',this)">'+t.icon+' '+t.name+'</button>'}).join('')}
function setPersonalTagFilter(id,btn){personalTagFilter=id;document.querySelectorAll('#personalFiltersRow .filter-btn').forEach(function(b){b.classList.remove('active')});if(btn)btn.classList.add('active');else document.querySelector('#personalFiltersRow .filter-btn').classList.add('active');renderPersonal()}
function clearTagFilter(){personalTagFilter='';document.querySelectorAll('#personalFiltersRow .filter-btn').forEach(function(b){b.classList.remove('active')});document.querySelector('#personalFiltersRow .filter-btn').classList.add('active');renderPersonal()}
function addPersonalTask(){var input=document.getElementById('personalTaskInput'),text=input.value.trim();if(!text)return;var tag=document.getElementById('personalTagSelect').value,tagObj=personalData.tags.find(function(t){return t.id===tag});personalData.tasks.push({id:genId(),text:text,icon:tagObj?tagObj.icon:'📌',priority:document.getElementById('personalPrioritySelect').value,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()});savePersonal();input.value='';document.getElementById('personalTagSelect').value='';renderPersonal();showToast('Task added','success')}
function togglePersonalTask(id){var t=personalData.tasks.find(function(x){return x.id===id});if(t){t.completed=!t.completed;t.completedAt=t.completed?new Date().toISOString():null;if(t.completed&&t.repeat==='habit'&&t.habitDay){t.habitDay++;if(t.habitDay>30){showToast('🎉 30-day habit complete!','success');if(confirm('🎉 30 days done! Reset?'))t.habitDay=1}}else if(t.completed)showToast('✓ Done!','success');savePersonal();renderPersonal()}}
function deletePersonalTask(id){personalData.tasks=personalData.tasks.filter(function(x){return x.id!==id});savePersonal();renderPersonal()}
function renderPersonalTask(t,showP){var meta='';if(t.repeat==='habit')meta='<span class="habit-badge">Day '+(t.habitDay||1)+'/30</span>';else if(t.repeat==='weekly')meta='<span class="repeat-badge">Every '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][t.repeatDay||0]+'</span>';else if(t.repeat==='daily')meta='<span class="repeat-badge">Daily</span>';if(t.protocolId){var proto=personalData.protocols.find(function(p){return p.id===t.protocolId});if(proto)meta+='<span class="protocol-source">'+proto.icon+' '+escapeHtml(proto.name)+'</span>'}var pb=showP?'<span class="priority-badge '+t.priority+'">'+t.priority+'</span>':'';return '<div class="personal-task-item'+(t.completed?' completed':'')+'"><div class="personal-task-checkbox'+(t.completed?' checked':'')+'" onclick="togglePersonalTask(\''+t.id+'\')"></div><div class="personal-task-icon">'+(t.icon||'📌')+'</div><div class="personal-task-content"><div class="personal-task-text">'+escapeHtml(t.text)+'</div><div class="personal-task-meta">'+pb+meta+'</div></div><button class="delete-task" onclick="deletePersonalTask(\''+t.id+'\')" title="Delete">×</button></div>'}
function getActiveTasks(){var today=new Date().getDay(),changed=false;personalData.protocols.forEach(function(p){if(p.active)p.tasks.forEach(function(pt){if(!personalData.tasks.find(function(t){return t.protocolId===p.id&&t.text===pt.text})){personalData.tasks.push({id:genId(),text:pt.text,icon:pt.icon,priority:'high',protocolId:p.id,completed:false,createdAt:new Date().toISOString()});changed=true}})});if(changed)savePersonal();return personalData.tasks.filter(function(t){return!(t.repeat==='weekly'&&t.repeatDay!==today)})}
function filterByTag(tasks){return personalTagFilter?tasks.filter(function(t){return(t.tags||[]).includes(personalTagFilter)}):tasks}
function renderFilteredView(){var tasks=filterByTag(getActiveTasks()),inc=tasks.filter(function(t){return!t.completed}),tag=personalData.tags.find(function(t){return t.id===personalTagFilter});document.getElementById('filterTagIcon').textContent=tag?tag.icon:'';document.getElementById('filterTagName').textContent=(tag?tag.name:'')+' Tasks';document.getElementById('filterTagCount').textContent=inc.length+' task'+(inc.length!==1?'s':'');var sorted=inc.filter(function(t){return t.priority==='high'}).concat(inc.filter(function(t){return t.priority==='medium'})).concat(inc.filter(function(t){return t.priority==='low'}));document.getElementById('filteredTasksList').innerHTML=sorted.length?sorted.map(function(t){return renderPersonalTask(t,true)}).join(''):'<div class="empty-state">No tasks with this tag</div>'}
function renderPersonalTodo(){var tasks=filterByTag(getActiveTasks()),high=tasks.filter(function(t){return t.priority==='high'&&!t.completed}),med=tasks.filter(function(t){return t.priority==='medium'&&!t.completed}),low=tasks.filter(function(t){return t.priority==='low'&&!t.completed}),done=tasks.filter(function(t){return t.completed});document.getElementById('highCount').textContent='('+high.length+')';document.getElementById('mediumCount').textContent='('+med.length+')';document.getElementById('lowCount').textContent='('+low.length+')';document.getElementById('doneCount').textContent='('+done.length+')';document.getElementById('highTasks').innerHTML=high.length?high.map(function(t){return renderPersonalTask(t)}).join(''):'<div class="priority-empty">No high priority</div>';document.getElementById('mediumTasks').innerHTML=med.length?med.map(function(t){return renderPersonalTask(t)}).join(''):'<div class="priority-empty">No medium priority</div>';document.getElementById('lowTasks').innerHTML=low.length?low.map(function(t){return renderPersonalTask(t)}).join(''):'<div class="priority-empty">No low priority</div>';document.getElementById('doneTasks').innerHTML=done.length?done.map(function(t){return renderPersonalTask(t)}).join(''):'<div class="priority-empty">Nothing done yet</div>'}
function updatePersonalStats(){var tasks=getActiveTasks(),inc=tasks.filter(function(t){return!t.completed});document.getElementById('pTotalTasks').textContent=inc.length;document.getElementById('pHighTasks').textContent=inc.filter(function(t){return t.priority==='high'}).length;document.getElementById('pHabits').textContent=personalData.tasks.filter(function(t){return t.repeat==='habit'}).length;var today=new Date().toDateString();document.getElementById('pCompletedToday').textContent=tasks.filter(function(t){return t.completed&&t.completedAt&&new Date(t.completedAt).toDateString()===today}).length;updateClearDoneBtn()}
function setPersonalView(v,btn){personalView=v;document.querySelectorAll('.personal-view .view-tab').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');document.getElementById('personalTodoView').style.display=v==='todo'&&!personalTagFilter?'block':'none';document.getElementById('personalProjectsView').style.display=v==='projects'?'block':'none';document.getElementById('personalProtocolsView').style.display=v==='protocols'?'block':'none';document.getElementById('personalFiltersRow').style.display=v==='todo'?'flex':'none';document.getElementById('tagFilterBanner').style.display='none';document.getElementById('filteredTasksView').style.display='none';if(v!=='todo')personalTagFilter='';renderPersonal()}
function renderPersonal(){var filtered=personalTagFilter&&personalView==='todo';document.getElementById('tagFilterBanner').style.display=filtered?'flex':'none';document.getElementById('filteredTasksView').style.display=filtered?'block':'none';document.getElementById('personalTodoView').style.display=personalView==='todo'&&!filtered?'block':'none';if(personalView==='todo'){filtered?renderFilteredView():renderPersonalTodo()}else if(personalView==='projects')renderProjects();else if(personalView==='protocols')renderProtocols();updatePersonalStats()}
function toggleDone(){document.getElementById('doneTasks').classList.toggle('expanded');document.getElementById('pDoneToggle').classList.toggle('expanded')}
function removeTempProtocolTask(i){tempProtocolTasks.splice(i,1);renderTempProtocolTasks()}
function saveProtocol(){var name=document.getElementById('protocolName').value.trim();if(!name)return alert('Enter a protocol name');if(!tempProtocolTasks.length)return alert('Add at least one task');var id=document.getElementById('editingProtocolId').value,data={name:name,icon:document.getElementById('protocolIcon').value.trim()||'📋',description:document.getElementById('protocolDesc').value.trim(),tasks:tempProtocolTasks,active:false};if(id){var idx=personalData.protocols.findIndex(function(p){return p.id===id});if(idx>=0){data.active=personalData.protocols[idx].active;Object.assign(personalData.protocols[idx],data)}}else personalData.protocols.push(Object.assign({id:genId()},data));savePersonal();closeProtocolModal();renderProtocols();showToast('Protocol saved','success')}
function openPersonalAddModal(p){document.getElementById('pModalPriority').value=p;document.getElementById('pModalTask').value='';document.getElementById('pModalIcon').value='';document.getElementById('pModalRepeat').value='';document.getElementById('repeatOptions').style.display='none';populatePersonalSelects();document.getElementById('personalAddModal').classList.add('active');setTimeout(function(){document.getElementById('pModalTask').focus()},100)}
function closePersonalAddModal(){document.getElementById('personalAddModal').classList.remove('active')}
function toggleRepeatOptions(){document.getElementById('repeatOptions').style.display=document.getElementById('pModalRepeat').value==='weekly'?'block':'none'}
function savePersonalModalTask(){var text=document.getElementById('pModalTask').value.trim();if(!text)return;var icon=document.getElementById('pModalIcon').value.trim()||'📌',priority=document.getElementById('pModalPriority').value,tag=document.getElementById('pModalTag').value,repeat=document.getElementById('pModalRepeat').value,task={id:genId(),text:text,icon:icon,priority:priority,tags:tag?[tag]:[],completed:false,createdAt:new Date().toISOString()};if(repeat){task.repeat=repeat;if(repeat==='weekly')task.repeatDay=parseInt(document.getElementById('pModalDay').value);if(repeat==='habit')task.habitDay=1}personalData.tasks.push(task);savePersonal();closePersonalAddModal();renderPersonal();showToast('Task added','success')}
function openSettings(){renderSettingsTabs();document.getElementById('settingsModal').classList.add('active')}
function closeSettings(){document.getElementById('settingsModal').classList.remove('active')}
function renderSettingsTabs(){var tabs=[];tabs.push('<button class="modal-tab active" onclick="renderSettingsTab(\x27firebase\x27,this)">☁️ Firebase</button>');tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\x27api\x27,this)">AI Scan</button>');tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\x27sync\x27,this)">Google Tasks</button>');tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\x27tags\x27,this)">Tags</button>');tabs.push('<button class="modal-tab" onclick="renderSettingsTab(\x27data\x27,this)">Data</button>');document.getElementById('settingsTabs').innerHTML=tabs.join('');renderSettingsTab('firebase')}
function renderSettingsTab(tab,btn){
if(btn){document.querySelectorAll('.modal-tab').forEach(function(b){b.classList.remove('active')});btn.classList.add('active')}
var c=document.getElementById('settingsContent');
if(tab==='firebase'){
  var config=getFirebaseConfig(),connected=firebaseReady&&userId;
  var status=connected?'<div class="api-status connected">✓ Connected — syncing across devices</div>':'<div class="api-status disconnected">⚠ Not connected — data stays local only</div>';
  var actions=config?'<div style="margin-top:16px"><div class="settings-item"><div class="settings-item-info"><div class="settings-item-title">Project: '+escapeHtml(config.projectId)+'</div></div></div><button class="btn-danger" style="margin-top:12px" onclick="disconnectFirebase()">Disconnect Firebase</button></div>':'<button class="btn btn-primary btn-sm" style="margin-top:16px" id="connectFbBtn">Connect Firebase</button>';
  c.innerHTML='<div class="modal-section"><h3>Firebase Cloud Sync</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Syncs your tasks across all devices in real-time.</p>'+status+actions+'</div>';
  var cfb=document.getElementById('connectFbBtn');
  if(cfb)cfb.onclick=function(){closeSettings();document.getElementById('setupOverlay').style.display='flex'};
}
else if(tab==='api'){
  var hasKey=appSettings.apiKey&&appSettings.apiKey.length>10;
  c.innerHTML='<div class="modal-section"><h3>Anthropic API Key</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Required for scanning handwritten notes.</p><div class="api-key-input"><input type="password" id="apiKeyInput" placeholder="sk-ant-..." value="'+(appSettings.apiKey||'')+'"><button class="btn btn-primary btn-sm" id="saveApiBtn">Save</button></div><div class="api-status '+(hasKey?'connected':'disconnected')+'">'+(hasKey?'✓ Key saved':'⚠ No key')+'</div></div>';
  document.getElementById('saveApiBtn').onclick=function(){saveApiKey()};
}
else if(tab==='tags'){
  var tags=currentMode==='work'?workData.tags:personalData.tags;
  var html='<div class="modal-section"><h3>Tags</h3>';
  tags.forEach(function(t){
    html+='<div class="settings-item"><div class="settings-item-info"><span style="font-size:1.2rem;margin-right:8px">'+t.icon+'</span>'+escapeHtml(t.name)+'</div><div class="settings-item-actions"><button class="delete" data-deltagid="'+t.id+'">×</button></div></div>';
  });
  html+='<div class="add-inline"><input type="text" id="newTagIcon" placeholder="📌" style="width:60px"><input type="text" id="newTagName" placeholder="Tag name"><button class="btn btn-primary btn-sm" id="addTagBtn">Add</button></div></div>';
  c.innerHTML=html;
  document.getElementById('addTagBtn').onclick=function(){addTag()};
  document.getElementById('newTagName').onkeypress=function(e){if(e.key==='Enter')addTag()};
  c.querySelectorAll('[data-deltagid]').forEach(function(btn){btn.onclick=function(){deleteTag(btn.getAttribute('data-deltagid'))}});
}
else if(tab==='data'){
  c.innerHTML='<div class="modal-section"><h3>Export / Reset</h3><p style="font-size:0.85rem;color:var(--gray);margin-bottom:16px">Your data is stored in Firebase'+(firebaseReady?' (synced)':' (local only)')+'.</p><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-secondary btn-sm" id="exportBtn">📥 Export JSON</button><button class="btn btn-secondary btn-sm" id="importBtn">📤 Import JSON</button><input type="file" id="importInput" accept=".json" style="display:none"></div><div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)"><button class="btn-danger" id="resetBtn">⚠ Reset All Data</button></div></div>';
  document.getElementById('exportBtn').onclick=function(){exportData()};
  document.getElementById('importBtn').onclick=function(){document.getElementById('importInput').click()};
  document.getElementById('importInput').onchange=function(e){importData(e)};
  document.getElementById('resetBtn').onclick=function(){resetAllData()};
}
else if(tab==='sync'){
  var hasUrl=appSettings.syncUrl&&appSettings.syncUrl.length>10;
  c.innerHTML='<div class="modal-section"><h3>Google Tasks Sync</h3><div class="api-key-input"><input type="url" id="syncUrlInput" placeholder="https://script.google.com/macros/s/..." value="'+(appSettings.syncUrl||'')+'"><button class="btn btn-primary btn-sm" id="saveSyncBtn">Save</button></div><div class="api-status '+(hasUrl?'connected':'disconnected')+'">'+(hasUrl?'✓ Sync URL saved':'⚠ No sync URL')+'</div></div>';
  document.getElementById('saveSyncBtn').onclick=function(){saveSyncUrl()};
}
}

function saveApiKey(){appSettings.apiKey=document.getElementById('apiKeyInput').value.trim();saveSettings();renderSettingsTab('api');showToast('API key saved','success')}
function saveSyncUrl(){appSettings.syncUrl=document.getElementById('syncUrlInput').value.trim();saveSettings();renderSettingsTab('sync');if(appSettings.syncUrl)showToast('Sync URL saved','success')}
function addTag(){var ic=document.getElementById('newTagIcon').value.trim()||'🏷️',nm=document.getElementById('newTagName').value.trim();if(!nm)return;if(currentMode==='work'){workData.tags.push({id:genId(),name:nm,icon:ic});saveWork();populateWorkSelects()}else{personalData.tags.push({id:genId(),name:nm,icon:ic});savePersonal();populatePersonalSelects()}renderSettingsTab('tags');showToast('Tag added')}
function deleteTag(id){if(currentMode==='work'){workData.tags=workData.tags.filter(function(t){return t.id!==id});saveWork();populateWorkSelects()}else{personalData.tags=personalData.tags.filter(function(t){return t.id!==id});savePersonal();populatePersonalSelects()}renderSettingsTab('tags')}
function exportData(){var data={version:1,exportedAt:new Date().toISOString(),work:workData,personal:personalData,settings:appSettings};var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='mj-planner-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(url);showToast('Data exported','success')}
function importData(e){var file=e.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(ev){try{var data=JSON.parse(ev.target.result);if(data.work)workData=data.work;if(data.personal)personalData=data.personal;if(data.settings)appSettings=data.settings;saveWork();savePersonal();saveSettings();populateWorkSelects();populatePersonalSelects();currentMode==='work'?renderWork():renderPersonal();showToast('Data imported','success')}catch(err){showToast('Invalid file','error')}};reader.readAsText(file);e.target.value=''}
function resetAllData(){if(!confirm('Delete ALL data?'))return;if(!confirm('Really?'))return;localStorage.removeItem('mjPlanner_work_v5');localStorage.removeItem('mjPlanner_personal_v5');localStorage.removeItem('mjPlanner_settings');if(firebaseReady&&db&&userId)db.ref('users/'+userId).remove();workData=JSON.parse(JSON.stringify(defaultWorkData));personalData=JSON.parse(JSON.stringify(defaultPersonalData));appSettings={apiKey:'',syncUrl:''};saveWork();savePersonal();saveSettings();populateWorkSelects();populatePersonalSelects();currentMode==='work'?renderWork():renderPersonal();closeSettings();showToast('All data reset')}
function openScanModal(){if(!appSettings.apiKey){alert('Add your API key in Settings first.');openSettings();return}resetScanModal();document.getElementById('scanModal').classList.add('active')}
function closeScanModal(){document.getElementById('scanModal').classList.remove('active');resetScanModal()}
function resetScanModal(){document.getElementById('scanUploadView').style.display='block';document.getElementById('scanReviewView').style.display='none';document.getElementById('fileInput').value='';suggestedTasks=[]}
document.addEventListener('DOMContentLoaded',function(){var dz=document.getElementById('dropZone');if(dz){dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('dragover')});dz.addEventListener('dragleave',function(){dz.classList.remove('dragover')});dz.addEventListener('drop',function(e){e.preventDefault();dz.classList.remove('dragover');var f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))processImage(f)})}})
function handleFileSelect(e){var f=e.target.files[0];if(f)processImage(f)}
async function processImage(file){var reader=new FileReader();reader.onload=async function(e){var base64=e.target.result.split(',')[1];document.getElementById('scanPreviewImg').src=e.target.result;document.getElementById('scanUploadView').style.display='none';document.getElementById('scanReviewView').style.display='block';document.getElementById('scanStatusBox').className='scan-status loading';document.getElementById('scanStatusBox').innerHTML='Analyzing...';try{var tasks=await analyzeImage(base64,file.type);suggestedTasks=tasks.map(function(t,i){return{id:i,text:t.text,priority:t.priority||'medium',tag:'',selected:true}});renderSuggestedTasks();document.getElementById('scanStatusBox').className='scan-status';document.getElementById('scanStatusBox').innerHTML='Found '+suggestedTasks.length+' tasks'}catch(err){document.getElementById('scanStatusBox').className='scan-status error';document.getElementById('scanStatusBox').innerHTML=err.message}};reader.readAsDataURL(file)}
async function analyzeImage(b64,mt){var r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':appSettings.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1024,messages:[{role:'user',content:[{type:'image',source:{type:'base64',media_type:mt,data:b64}},{type:'text',text:'Extract tasks from this image. Respond ONLY with JSON array: [{"text":"task","priority":"high|medium|low"}]. Empty [] if none.'}]}]})});if(!r.ok){var e=await r.json();throw new Error(e.error?.message||'API error')}var d=await r.json(),m=d.content[0].text.match(/\[[\s\S]*\]/);if(!m)return[];try{return JSON.parse(m[0])}catch(x){return[]}}
function renderSuggestedTasks(){var tags=currentMode==='work'?workData.tags:personalData.tags;var opts='<option value="">No tag</option>'+tags.map(function(t){return '<option value="'+t.id+'">'+t.icon+' '+t.name+'</option>'}).join('');document.getElementById('suggestedTasksList').innerHTML=suggestedTasks.map(function(t){return '<div class="suggested-task"><input type="checkbox" '+(t.selected?'checked':'')+' onchange="toggleSuggestedTask('+t.id+')"><div class="suggested-task-content"><input type="text" class="suggested-task-text" value="'+escapeHtml(t.text)+'" onchange="updateSuggestedText('+t.id+',this.value)"><div class="suggested-task-options"><select onchange="updateSuggestedPriority('+t.id+',this.value)"><option value="high"'+(t.priority==='high'?' selected':'')+'>High</option><option value="medium"'+(t.priority==='medium'?' selected':'')+'>Medium</option><option value="low"'+(t.priority==='low'?' selected':'')+'>Low</option></select><select onchange="updateSuggestedTag('+t.id+',this.value)">'+opts+'</select></div></div><button class="remove-btn" onclick="removeSuggestedTask('+t.id+')">&times;</button></div>'}).join('');updateAddBtn()}
function toggleSuggestedTask(id){var t=suggestedTasks.find(function(x){return x.id===id});if(t)t.selected=!t.selected;updateAddBtn()}
function updateSuggestedText(id,v){var t=suggestedTasks.find(function(x){return x.id===id});if(t)t.text=v}
function updateSuggestedPriority(id,v){var t=suggestedTasks.find(function(x){return x.id===id});if(t)t.priority=v}
function updateSuggestedTag(id,v){var t=suggestedTasks.find(function(x){return x.id===id});if(t)t.tag=v}
function removeSuggestedTask(id){suggestedTasks=suggestedTasks.filter(function(t){return t.id!==id});renderSuggestedTasks()}
function updateAddBtn(){var c=suggestedTasks.filter(function(t){return t.selected}).length;document.getElementById('addSelectedBtn').disabled=c===0;document.getElementById('addSelectedBtn').textContent='Add '+c+' Task'+(c!==1?'s':'')}
function addSelectedTasks(){var toAdd=suggestedTasks.filter(function(t){return t.selected&&t.text.trim()});if(currentMode==='work'){var parts=document.getElementById('workProjectSelect').value.split('|');toAdd.forEach(function(t){workData.tasks.push({id:genId(),text:t.text.trim(),partnerId:parts[0],projectId:parts[1],deliverableId:parts[2],priority:t.priority,tags:t.tag?[t.tag]:[],completed:false,createdAt:new Date().toISOString()})});saveWork();renderWork()}else{toAdd.forEach(function(t){var tagObj=personalData.tags.find(function(x){return x.id===t.tag});personalData.tasks.push({id:genId(),text:t.text.trim(),icon:tagObj?tagObj.icon:'📌',priority:t.priority,tags:t.tag?[t.tag]:[],completed:false,createdAt:new Date().toISOString()})});savePersonal();renderPersonal()}closeScanModal();showToast('Added '+toAdd.length+' tasks','success')}
var syncTasks=[];
async function syncGoogleTasks(){if(!appSettings.syncUrl){showToast('Add sync URL in Settings');openSettings();return}var btn=document.getElementById('syncBtn');btn.classList.add('syncing');try{var data=await fetchViaJsonp(appSettings.syncUrl);if(data.error)throw new Error(data.error);var imported=JSON.parse(localStorage.getItem('mjPlanner_imported_gtasks')||'[]');syncTasks=(data.tasks||[]).filter(function(t){return!imported.includes(t.id)}).map(function(t){return Object.assign({},t,{selected:true,priority:'medium',assignTo:''})});btn.classList.remove('syncing');if(!syncTasks.length){showToast('No new tasks');updateSyncBadge(0);return}updateSyncBadge(syncTasks.length);openSyncModal()}catch(err){btn.classList.remove('syncing');showToast('Sync failed: '+err.message,'error')}}
function fetchViaJsonp(url){return new Promise(function(resolve,reject){var cb='_cb_'+Date.now(),timeout=setTimeout(function(){cleanup();reject(new Error('Timeout'))},15000),script=document.createElement('script');function cleanup(){clearTimeout(timeout);delete window[cb];if(script.parentNode)script.parentNode.removeChild(script)}window[cb]=function(d){cleanup();resolve(d)};script.onerror=function(){cleanup();reject(new Error('Failed'))};script.src=url+(url.includes('?')?'&':'?')+'callback='+cb;document.head.appendChild(script)})}
function updateSyncBadge(n){var b=document.getElementById('syncBadge');b.style.display=n>0?'inline':'none';b.textContent=n}
function openSyncModal(){var c=document.getElementById('syncContent'),a=document.getElementById('syncActions');if(!syncTasks.length){c.innerHTML='<div class="sync-empty"><div class="sync-empty-icon">📭</div><div class="sync-empty-text">No new tasks</div></div>';a.style.display='none';document.getElementById('syncModal').classList.add('active');return}var opts='<option value="">— Assign —</option>';workData.partners.forEach(function(p){p.projects.forEach(function(pr){pr.deliverables.forEach(function(d){opts+='<option value="'+p.id+'|'+pr.id+'|'+d.id+'">'+p.name+' → '+d.name+'</option>'})})});c.innerHTML=syncTasks.map(function(t,i){return '<div class="sync-task-item"><input type="checkbox" '+(t.selected?'checked':'')+' onchange="toggleSyncTask('+i+')"><div class="sync-task-content"><div class="sync-task-title">'+escapeHtml(t.title)+'</div><div class="sync-task-options"><select onchange="updateSyncProject('+i+',this.value)">'+opts+'</select><select onchange="updateSyncPriority('+i+',this.value)"><option value="high">Urgent</option><option value="medium" selected>Medium</option><option value="low">Low</option></select></div></div></div>'}).join('');a.style.display='flex';updateImportBtn();document.getElementById('syncModal').classList.add('active')}
function closeSyncModal(){document.getElementById('syncModal').classList.remove('active')}
function toggleSyncTask(i){syncTasks[i].selected=!syncTasks[i].selected;updateImportBtn()}
function updateSyncPriority(i,v){syncTasks[i].priority=v}
function updateSyncProject(i,v){syncTasks[i].assignTo=v}
function updateImportBtn(){var c=syncTasks.filter(function(t){return t.selected}).length;var btn=document.getElementById('importSyncBtn');btn.disabled=c===0;btn.textContent='Import '+c+' Task'+(c!==1?'s':'')}
async function importSyncedTasks(){var toImport=syncTasks.filter(function(t){return t.selected&&t.title.trim()});if(!toImport.length)return;toImport.forEach(function(t){var pid='admin',prid='business',did='invoices';if(t.assignTo){var p=t.assignTo.split('|');pid=p[0];prid=p[1];did=p[2]}workData.tasks.push({id:genId(),text:t.title.trim(),partnerId:pid,projectId:prid,deliverableId:did,priority:t.priority,tags:[],completed:false,createdAt:new Date().toISOString(),googleTaskId:t.id})});saveWork();var imported=JSON.parse(localStorage.getItem('mjPlanner_imported_gtasks')||'[]');toImport.forEach(function(t){imported.push(t.id)});localStorage.setItem('mjPlanner_imported_gtasks',JSON.stringify(imported));closeSyncModal();updateSyncBadge(0);renderWork();showToast('Imported '+toImport.length+' tasks','success')}
function initApp(){populateWorkSelects();populatePersonalSelects();renderWork();if(appSettings.syncUrl&&currentMode==='work')setTimeout(syncGoogleTasks,1500)}
initFirebase();
</script>
</body>
</html>
